<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="By default, after packaging a game with UE and installing the Apk on a phone, launching the game will create the game’s data directory under &#x2F;storage&#x2F;emulated&#x2F;0&#x2F;UE4Game&#x2F; (which is at the root of the i">
<meta property="og:type" content="article">
<meta property="og:title" content="Modify the default data storage path for Android games">
<meta property="og:url" content="https://en.imzlp.com/posts/20367/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="By default, after packaging a game with UE and installing the Apk on a phone, launching the game will create the game’s data directory under &#x2F;storage&#x2F;emulated&#x2F;0&#x2F;UE4Game&#x2F; (which is at the root of the i">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/20230323184632.webp">
<meta property="article:published_time" content="2020-01-22T09:10:02.000Z">
<meta property="article:modified_time" content="2020-01-22T09:10:02.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/20230323184632.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/20367/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Modify the default data storage path for Android games | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/20367/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Modify the default data storage path for Android games<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2020-01-22-20367.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/20367/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        
          <div class="post-subtitle" style="text-align: center;line-height: 1;">
            <sub text-align="center" style="font-size: 15px;align-content: center;font-style: italic;bottom: 0em;">UE源码分析：修改游戏默认的数据存储路径</sub>
          </div>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-22 09:10 09:10:02:10" itemprop="dateCreated datePublished" datetime="2020-01-22T09:10:02+00:00">2020-01-22 09:10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/" itemprop="url" rel="index"><span itemprop="name">UnrealEngine</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          
            <span id="/posts/20367/" class="post-meta-item leancloud_visitors" data-flag-title="Modify the default data storage path for Android games" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>By default, after packaging a game with UE and installing the Apk on a phone, launching the game will create the game’s data directory under <code>/storage/emulated/0/UE4Game/</code> (which is at the root of the internal storage). According to Google’s rules, it is best for each app’s data files to be placed in their own private directory. Therefore, I want to put all the game’s data packaged by UE into the directory <code>/storage/emulated/0/Android/data/PACKAGE_NAME</code> (regardless of whether it’s log, ini, or crash information).<br>This seemingly simple requirement has several different approaches involving UE4’s path management, JNI, Android Manifest, and analysis of UBT code.</p>
<span id="more"></span>

<p>Default path:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/20367/ue4-data-folder-in-android.webp"></p>
<p>There are two methods: one is to modify the engine code to implement a change to <code>GFilePathBase</code>, and the other is to simply add <code>manifest</code> in the project settings without changing the engine. Of course, not changing the engine is the best approach. However, since this is an analysis, I’ll explore both methods and also analyze the <code>Project Setting</code> - <code>Android</code> - <code>Use ExternalFilesDir for UE4Game Files</code> option to see why it has no effect.</p>
<h3 id="Modifying-Engine-Code"><a href="#Modifying-Engine-Code" class="headerlink" title="Modifying Engine Code"></a>Modifying Engine Code</h3><p>After looking through the engine code, I found that this part of the path is written here: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/6c20d9831a968ad3cb156442bebb41a883e62152/Engine/Source/Runtime/Core/Private/Android/AndroidPlatformFile.cpp#L946">AndroidPlatformFile.cpp#L946</a>. It takes <code>GFilePathBase</code> and combines it with <code>UE4Game</code> + <code>PROJECT_NAME</code> to form the path.</p>
<p>In versions of the engine up to UE4.22, this was in the <code>AndroidFile.cpp</code> file, but from 4.23 onwards, it’s in <code>AndroidPlatformFile.cpp</code>.<br>The initialization of the base path <code>GFilePathBase</code> happens in <code>Launch\Private\Android\AndroidJNI.cpp</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launch\Private\Android\AndroidJNI.cpp</span></span><br><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* InJavaVM, <span class="type">void</span>* InReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;In the JNI_OnLoad function&quot;</span>));</span><br><span class="line"></span><br><span class="line">  JNIEnv* Env = <span class="literal">NULL</span>;</span><br><span class="line">  InJavaVM-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span> **)&amp;Env, JNI_CURRENT_VERSION);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if you have problems with stuff being missing especially in distribution builds then it could be because proguard is stripping things from java</span></span><br><span class="line">  <span class="comment">// check proguard-project.txt and see if your stuff is included in the exceptions</span></span><br><span class="line">  GJavaVM = InJavaVM;</span><br><span class="line">  FAndroidApplication::<span class="built_in">InitializeJavaEnv</span>(GJavaVM, JNI_CURRENT_VERSION, FJavaWrapper::GameActivityThis);</span><br><span class="line"></span><br><span class="line">  FJavaWrapper::<span class="built_in">FindClassesAndMethods</span>(Env);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hook signals</span></span><br><span class="line">  <span class="keyword">if</span> (!FPlatformMisc::<span class="built_in">IsDebuggerPresent</span>() || GAlwaysReportCrash)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// disable crash handler.. getting better stack traces from system for now</span></span><br><span class="line">    <span class="comment">// FPlatformMisc::SetCrashHandler(EngineCrashHandler);</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Cache path to external storage</span></span><br><span class="line">  jclass EnvClass = Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/os/Environment&quot;</span>);</span><br><span class="line">  jmethodID getExternalStorageDir = Env-&gt;<span class="built_in">GetStaticMethodID</span>(EnvClass, <span class="string">&quot;getExternalStorageDirectory&quot;</span>, <span class="string">&quot;()Ljava/io/File;&quot;</span>);</span><br><span class="line">  jobject externalStoragePath = Env-&gt;<span class="built_in">CallStaticObjectMethod</span>(EnvClass, getExternalStorageDir, <span class="literal">nullptr</span>);</span><br><span class="line">  jmethodID getFilePath = Env-&gt;<span class="built_in">GetMethodID</span>(Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/io/File&quot;</span>), <span class="string">&quot;getPath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">  jstring pathString = (jstring)Env-&gt;<span class="built_in">CallObjectMethod</span>(externalStoragePath, getFilePath, <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *nativePathString = Env-&gt;<span class="built_in">GetStringUTFChars</span>(pathString, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// Copy that somewhere safe </span></span><br><span class="line">  GFilePathBase = <span class="built_in">FString</span>(nativePathString);</span><br><span class="line">  GOBBFilePathBase = GFilePathBase;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// then release...</span></span><br><span class="line">  Env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(pathString, nativePathString);</span><br><span class="line">  Env-&gt;<span class="built_in">DeleteLocalRef</span>(pathString);</span><br><span class="line">  Env-&gt;<span class="built_in">DeleteLocalRef</span>(externalStoragePath);</span><br><span class="line">  Env-&gt;<span class="built_in">DeleteLocalRef</span>(EnvClass);</span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Path found as &#x27;%s&#x27;\n&quot;</span>), *GFilePathBase);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the system font directory</span></span><br><span class="line">  jstring fontPath = (jstring)Env-&gt;<span class="built_in">CallStaticObjectMethod</span>(FJavaWrapper::GameActivityClassID, FJavaWrapper::AndroidThunkJava_GetFontDirectory);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> * nativeFontPathString = Env-&gt;<span class="built_in">GetStringUTFChars</span>(fontPath, <span class="number">0</span>);</span><br><span class="line">  GFontPathBase = <span class="built_in">FString</span>(nativeFontPathString);</span><br><span class="line">  Env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(fontPath, nativeFontPathString);</span><br><span class="line">  Env-&gt;<span class="built_in">DeleteLocalRef</span>(fontPath);</span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Font Path found as &#x27;%s&#x27;\n&quot;</span>), *GFontPathBase);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wire up to core delegates, so core code can call out to Java</span></span><br><span class="line">  <span class="built_in">DECLARE_DELEGATE_OneParam</span>(FAndroidLaunchURLDelegate, <span class="type">const</span> FString&amp;);</span><br><span class="line">  <span class="keyword">extern</span> CORE_API FAndroidLaunchURLDelegate OnAndroidLaunchURL;</span><br><span class="line">  OnAndroidLaunchURL = FAndroidLaunchURLDelegate::<span class="built_in">CreateStatic</span>(&amp;AndroidThunkCpp_LaunchURL);</span><br><span class="line"></span><br><span class="line">  FPlatformMisc::<span class="built_in">LowLevelOutputDebugString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;In the JNI_OnLoad function 5&quot;</span>));</span><br><span class="line">  </span><br><span class="line">  <span class="type">char</span> mainThreadName[] = <span class="string">&quot;MainThread-UE4&quot;</span>;</span><br><span class="line">  <span class="built_in">AndroidThunkCpp_SetThreadName</span>(mainThreadName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JNI_CURRENT_VERSION;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Our goal is to change the value of <code>GFilePathBase</code>, because by default it gets its value by calling <code>getExternalStorageDirectory</code>, which is the directory of external storage: <code>/storage/emulated/0/</code>. When combined with <code>UE4Game</code>, this gives the default path we usually see.</p>
<p>Since <code>getExternalStorageDirectory</code> and the like are static members of Environment and do not provide the path we want, but <code>Context</code> does, and the UE code does not retrieve it, we need a way to get the App’s Context.</p>
<p>We can get the Context from JNI using the following method:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get context</span></span><br><span class="line">jobject JniEnvContext;</span><br><span class="line">&#123;</span><br><span class="line">	jclass activityThreadClass = Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/app/ActivityThread&quot;</span>);</span><br><span class="line">	jmethodID currentActivityThread = FJavaWrapper::<span class="built_in">FindStaticMethod</span>(Env, activityThreadClass, <span class="string">&quot;currentActivityThread&quot;</span>, <span class="string">&quot;()Landroid/app/ActivityThread;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">	jobject at = Env-&gt;<span class="built_in">CallStaticObjectMethod</span>(activityThreadClass, currentActivityThread);</span><br><span class="line">	jmethodID getApplication = FJavaWrapper::<span class="built_in">FindMethod</span>(Env, activityThreadClass, <span class="string">&quot;getApplication&quot;</span>, <span class="string">&quot;()Landroid/app/Application;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	JniEnvContext = FJavaWrapper::<span class="built_in">CallObjectMethod</span>(Env, at, getApplication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then we can use the function <code>getExternalFilesDir</code> under <code>Context</code> to obtain our desired path:</p>
<blockquote>
<p>Note: the prototype of <code>getExternalFilesDir</code> is: <code>File getExternalFilesDir(String)</code>, so when using JNI to get the jmehodID, it’s important to match the signature exactly, or it will crash; its signature is <code>(Ljava/lang/String;)Ljava/io/File;</code>.</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jmethodID getExternalFilesDir = Env-&gt;<span class="built_in">GetMethodID</span>(Env-&gt;<span class="built_in">GetObjectClass</span>(JniEnvContext), <span class="string">&quot;getExternalFilesDir&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/io/File;&quot;</span>);</span><br><span class="line"><span class="comment">// get File</span></span><br><span class="line">jobject ExternalFileDir = Env-&gt;<span class="built_in">CallObjectMethod</span>(JniEnvContext, getExternalFilesDir, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="comment">// getPath method in File class</span></span><br><span class="line">jmethodID getFilePath = Env-&gt;<span class="built_in">GetMethodID</span>(Env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/io/File&quot;</span>), <span class="string">&quot;getPath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">jstring pathString = (jstring)Env-&gt;<span class="built_in">CallObjectMethod</span>(ExternalFileDir, getFilePath, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *nativePathString = Env-&gt;<span class="built_in">GetStringUTFChars</span>(pathString, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>The value of <code>nativePathString</code> obtained is:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/storage/emulated/<span class="number">0</span>/Android/data/com.imzlp.GWorld/files</span><br></pre></td></tr></table></figure>

<p>Here, <code>com.imzlp.GWorld</code> is your App’s package name.</p>
<p>Then simply assign this value to <code>GFilePathBase</code>, and after repackaging the Apk in the editor and reinstalling it, all the app’s data will be under <code>/storage/emulated/0/Android/data/PACKAGE_NAME/files</code>.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/20367/ue4-android-loadjni-log.webp"></p>
<p>Links for invoking and operating JNI and Android storage paths in UE:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46869901/how-to-get-the-android-context-instance-when-calling-jni-method">How to get the Android context instance when calling JNI method?</a></li>
<li><a target="_blank" rel="noopener" href="https://kotlintc.com/articles/3760">Android JNI get Context</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/os/Environment">Android Environment API</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/Context.html">Android Context API</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2de0113b3164">How much do you know about Android storage paths?</a></li>
</ul>
<h3 id="Controlling-with-Manifest"><a href="#Controlling-with-Manifest" class="headerlink" title="Controlling with Manifest"></a>Controlling with Manifest</h3><p>OK, I’ve generally written about analyzing the modification of <code>GFilePathBase</code> in the engine. There is actually a non-engine modification approach, which is to add <code>manifest</code> in the project settings.</p>
<p>The principle is also in <code>AndoidJNI.cpp</code>, where there is the following code:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//This function is declared in the Java-defined class, GameActivity.java: &quot;public native void nativeSetGlobalActivity();&quot;</span></span><br><span class="line"><span class="function">JNI_METHOD <span class="type">void</span> <span class="title">Java_com_epicgames_ue4_GameActivity_nativeSetGlobalActivity</span><span class="params">(JNIEnv* jenv, jobject thiz, jboolean bUseExternalFilesDir, jstring internalFilePath, jstring externalFilePath, jboolean bOBBinAPK, jstring APKFilename <span class="comment">/*, jobject googleServices*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!FJavaWrapper::GameActivityThis)</span><br><span class="line">	&#123;</span><br><span class="line">		GGameActivityThis = FJavaWrapper::GameActivityThis = jenv-&gt;<span class="built_in">NewGlobalRef</span>(thiz);</span><br><span class="line">		<span class="keyword">if</span> (!FJavaWrapper::GameActivityThis)</span><br><span class="line">		&#123;</span><br><span class="line">			FPlatformMisc::<span class="built_in">LowLevelOutputDebugString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Error setting the global GameActivity activity&quot;</span>));</span><br><span class="line">			<span class="built_in">check</span>(<span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// This call is only to set the correct GameActivityThis</span></span><br><span class="line">		FAndroidApplication::<span class="built_in">InitializeJavaEnv</span>(GJavaVM, JNI_CURRENT_VERSION, FJavaWrapper::GameActivityThis);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// @todo split GooglePlay, this needs to be passed in to this function</span></span><br><span class="line">		FJavaWrapper::GoogleServicesThis = FJavaWrapper::GameActivityThis;</span><br><span class="line">		<span class="comment">// FJavaWrapper::GoogleServicesThis = jenv-&gt;NewGlobalRef(googleServices);</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Next we check to see if the OBB file is in the APK</span></span><br><span class="line">		<span class="comment">//jmethodID isOBBInAPKMethod = jenv-&gt;GetStaticMethodID(FJavaWrapper::GameActivityClassID, &quot;isOBBInAPK&quot;, &quot;()Z&quot;);</span></span><br><span class="line">		<span class="comment">//GOBBinAPK = (bool)jenv-&gt;CallStaticBooleanMethod(FJavaWrapper::GameActivityClassID, isOBBInAPKMethod, nullptr);</span></span><br><span class="line">		GOBBinAPK = bOBBinAPK;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> <span class="type">char</span> *nativeAPKFilenameString = jenv-&gt;<span class="built_in">GetStringUTFChars</span>(APKFilename, <span class="number">0</span>);</span><br><span class="line">		GAPKFilename = <span class="built_in">FString</span>(nativeAPKFilenameString);</span><br><span class="line">		jenv-&gt;<span class="built_in">ReleaseStringUTFChars</span>(APKFilename, nativeAPKFilenameString);</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> <span class="type">char</span> *nativeInternalPath = jenv-&gt;<span class="built_in">GetStringUTFChars</span>(internalFilePath, <span class="number">0</span>);</span><br><span class="line">		GInternalFilePath = <span class="built_in">FString</span>(nativeInternalPath);</span><br><span class="line">		jenv-&gt;<span class="built_in">ReleaseStringUTFChars</span>(internalFilePath, nativeInternalPath);</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> <span class="type">char</span> *nativeExternalPath = jenv-&gt;<span class="built_in">GetStringUTFChars</span>(externalFilePath, <span class="number">0</span>);</span><br><span class="line">		GExternalFilePath = <span class="built_in">FString</span>(nativeExternalPath);</span><br><span class="line">		jenv-&gt;<span class="built_in">ReleaseStringUTFChars</span>(externalFilePath, nativeExternalPath);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bUseExternalFilesDir)</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UE_BUILD_SHIPPING</span></span><br><span class="line">			GFilePathBase = GInternalFilePath;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">			GFilePathBase = GExternalFilePath;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">			FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GFilePathBase Path override to&#x27;%s&#x27;\n&quot;</span>), *GFilePathBase);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;InternalFilePath found as &#x27;%s&#x27;\n&quot;</span>), *GInternalFilePath);</span><br><span class="line">		FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ExternalFilePath found as &#x27;%s&#x27;\n&quot;</span>), *GExternalFilePath);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>During engine startup, it will be called from JNI, where one of the parameters <code>bUseExternalFilesDir</code> controls whether to modify the value of <code>GFilePathBase</code>. If it’s true, in Shipping packaging mode, <code>GFilePathBase</code> will be set to the value of <code>GInternalFilePath</code>, which is the following path:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/user/PACKAGE_NAME/files</span><br></pre></td></tr></table></figure>

<p>This is the app’s private data path on Android, which cannot be accessed without ROOT permissions. This also means that files cannot be manually placed in this directory; I believe the design intent is to prevent users from accessing data generated during the release version.</p>
<blockquote>
<p>However, UE also provides a configuration to output logs to non-internal storage during Shipping mode. This is done by adding <code>bPublicLogFiles=True</code> under <code>[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</code> in <code>DefaultEngine.ini</code>.</p>
</blockquote>
<p>In non-Shipping packaging mode, it will be set to the value of <code>GExternalFilePath</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/storage/emulated/<span class="number">0</span>/Android/data/PACKAGE_NAME/files</span><br></pre></td></tr></table></figure>

<p>This is the external storage sandbox path for Android apps, which will be automatically cleaned up when the app is uninstalled.</p>
<p>However, the key issue is how to control the <code>bUseExternalFilesDir</code> parameter that comes from JNI.</p>
<p>The answer to this question is to add <code>manifest</code> information! I initially thought it was the <code>ProjectSettings</code> - <code>Android</code> - <code>UseExternalFilesDirForUE4GameFiles</code> option, but selecting it has no effect, as I will analyze later.</p>
<p>Before explaining how to control the <code>bUseExternalFilesDir</code> variable through the <code>manifest</code>, it’s important to know what the Manifest of an APK packaged by UE4 contains by default.</p>
<p>Below is the Manifest file I unpacked from the APK:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> standalone=<span class="string">&quot;no&quot;</span>?&gt;</span><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:installLocation</span>=<span class="string">&quot;internalOnly&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.imzlp.TEST&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;29&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;10&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:hardwareAccelerated</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:hasCode</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/icon&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:launchMode</span>=<span class="string">&quot;singleTask&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.SplashActivity&quot;</span> <span class="attr">android:screenOrientation</span>=<span class="string">&quot;landscape&quot;</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/UE4SplashTheme&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:configChanges</span>=<span class="string">&quot;density|keyboard|keyboardHidden|mcc|mnc|orientation|screenSize|uiMode&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:launchMode</span>=<span class="string">&quot;singleTask&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity&quot;</span> <span class="attr">android:screenOrientation</span>=<span class="string">&quot;landscape&quot;</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/UE4SplashTheme&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.app.lib_name&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;UE4&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:configChanges</span>=<span class="string">&quot;density|keyboard|keyboardHidden|mcc|mnc|orientation|screenSize|uiMode&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;.DownloaderActivity&quot;</span> <span class="attr">android:screenOrientation</span>=<span class="string">&quot;landscape&quot;</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/UE4SplashTheme&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.EngineVersion&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;4.22.3&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.EngineBranch&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;++UE4+Release-4.22&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.ProjectVersion&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;1.0.0.0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.DepthBufferPreference&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bPackageDataInsideApk&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bVerifyOBBOnStartUp&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bShouldHideUI&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.ProjectName&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;Mobile422&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.AppType&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bHasOBBFiles&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.BuildConfiguration&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;Development&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.CookedFlavors&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;ETC2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bValidateTextureFormats&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseDisplayCutout&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bAllowIMU&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bSupportsVulkan&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.google.android.gms.games.APP_ID&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;@string/app_id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.google.android.gms.version&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;@integer/google_play_services_version&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:configChanges</span>=<span class="string">&quot;keyboard|keyboardHidden|orientation|screenLayout|screenSize|smallestScreenSize|uiMode&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.google.android.gms.ads.AdActivity&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;OBBDownloaderService&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;AlarmReceiver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.LocalNotificationReceiver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.MulticastBroadcastReceiver&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.android.vending.INSTALL_REFERRER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.max_aspect&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;2.1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:glEsVersion</span>=<span class="string">&quot;0x00030000&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.android.vending.CHECK_LICENSE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_WIFI_STATE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.VIBRATE&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>This file is generated in <code>UnrealBuildTool\Platform\Android\UEDeployAdnroid.cs</code>‘s <code>GenerateManifest</code> function.</p>
<p>It controls the permissions and attributes configuration required after APK installation. We can see that one entry is:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>The value of <code>bUseExternalFilesDir</code> is false! How can we set it to true?</p>
<p>You need to open <code>Project Settings</code> - <code>Android</code> - <code>Advanced APK Packaging</code> and find the <code>Extra Tags for &lt;application&gt; node</code>. Since <code>&lt;meta-data /&gt;</code> is under <code>Application</code>, you need to add content here.</p>
<p>The content to add is:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>That’s right! Just paste this line with <code>meta-data</code> and modify the value, and UE will automatically append this content to the <code>Manifest</code> in the <code>Application</code> section during packing, overriding the default <code>false</code> value.</p>
<p>Then, after repackaging, you will see that the <code>bUseExternalFilesDir</code> option takes effect.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/20367/ue4-android-override-GFilePathBase-as-ExternalFilePath.webp"></p>
<h3 id="Controlling-bUseExternalFilesDir-via-UPL"><a href="#Controlling-bUseExternalFilesDir-via-UPL" class="headerlink" title="Controlling bUseExternalFilesDir via UPL"></a>Controlling bUseExternalFilesDir via UPL</h3><p>Since UE automatically adds <code>com.epicgames.ue4.GameActivity.bUseExternalFilesDir</code> to <code>AndroidManifest.xml</code>, if we want to manually control it, directly adding it will cause errors, prompting that it already exists:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   &gt; Task :app:processDebugManifest FAILED</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Z:\app\src\main\AndroidManifest.xml:<span class="number">47</span>:<span class="number">5</span><span class="number">-106</span> Error:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):     Element meta-data<span class="meta">#com.epicgames.ue4.GameActivity.bUseExternalFilesDir at AndroidManifest.xml:47:5-106 duplicated with element declared at AndroidManifest.xml:27:5-107</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Z:\app\src\main\AndroidManifest.xml Error:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):     Validation failed, exiting</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   FAILURE: Build failed with an exception.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * What went wrong:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Execution failed <span class="keyword">for</span> task <span class="string">&#x27;:app:processDebugManifest&#x27;</span>.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   &gt; Manifest merger failed with multiple errors, see logs</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   See http:<span class="comment">//g.co/androidstudio/manifest-merger for more information about the manifest merger.</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * Try:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   Run with --stacktrace option to get the stack trace. Run with --info <span class="keyword">or</span> --debug option to get more log output. Run with --scan to get full insights.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   * Get more help at https:<span class="comment">//help.gradle.org</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   </span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   BUILD FAILED in <span class="number">10</span>s</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   <span class="number">189</span> actionable tasks: <span class="number">1</span> executed, <span class="number">188</span> up-to-date</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)):   ERROR: cmd.exe failed with args /c <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\GCloudExample\Intermediate\Android\armv7\gradle\rungradle.bat&quot;</span> :app:assembleDebug</span><br><span class="line">PackagingResults: Error: cmd.exe failed with args /c <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\GCloudExample\Intermediate\Android\armv7\gradle\rungradle.bat&quot;</span> :app:assembleDebug</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): Took <span class="number">13.3060694</span>s to run UnrealBuildTool.exe, ExitCode=<span class="number">6</span></span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): UnrealBuildTool failed. See log <span class="keyword">for</span> more details. (C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4<span class="number">.25</span>\UBT-.txt)</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): AutomationTool exiting with ExitCode=<span class="number">6</span> (<span class="number">6</span>)</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Android</span> (ASTC)): BUILD FAILED</span><br><span class="line">PackagingResults: Error: Unknown Error</span><br></pre></td></tr></table></figure>

<p>If you want to modify or delete the entry in the UE-generated <code>AndroidManifest.xml</code>, you can do so by first deleting it before adding it.</p>
<p>For example, to delete the following entry:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data android:name=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> android:value=<span class="string">&quot;false&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>You can write the following code in the UPL’s <code>androidManifestUpdates</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">androidManifestUpdates</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">loopElements</span> <span class="attr">tag</span>=<span class="string">&quot;meta-data&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setStringFromAttribute</span> <span class="attr">result</span>=<span class="string">&quot;ApplicationSectionName&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span> <span class="attr">name</span>=<span class="string">&quot;android:name&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setBoolIsEqual</span> <span class="attr">result</span>=<span class="string">&quot;bUseExternalFilesDir&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$S(ApplicationSectionName)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bUseExternalFilesDir&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">removeElement</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">loopElements</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">addElements</span> <span class="attr">tag</span>=<span class="string">&quot;application&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">addElements</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidManifestUpdates</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>This code iterates through the <code>AndroidManifest.xml</code>, locating and deleting the <code>meta-data</code> entry with the <code>android:name</code> as <code>com.epicgames.ue4.GameActivity.bUseExternalFilesDir</code>.</p>
<h3 id="Analysis-of-the-Ineffectiveness-of-the-bUseExternalFilesDir-Option-in-Project-Settings"><a href="#Analysis-of-the-Ineffectiveness-of-the-bUseExternalFilesDir-Option-in-Project-Settings" class="headerlink" title="Analysis of the Ineffectiveness of the bUseExternalFilesDir Option in Project Settings"></a>Analysis of the Ineffectiveness of the bUseExternalFilesDir Option in Project Settings</h3><p>Now let’s analyze why the <code>Project Settings</code> - <code>Android</code> - <code>Use ExternalFilesDir for UE4Game Files</code> option is ineffective. In fact, this option does control the value of <code>bUseExternalFilesDir</code> in the <code>manifest</code>, manipulated within UBT, as previously mentioned, the <code>manifest</code> file is generated within UBT. <strong>However</strong>, although UE provides this parameter, in the current engine (4.22.3) this option has no effect because it is disabled by default. </p>
<p>First, the UBT build call stack is as follows:</p>
<ol>
<li><code>Deploy</code> in <code>AndroidPlatform</code> (UEBuildAndroid.cs)</li>
<li><code>PrepTargetForDeployment</code> in <code>UEDeployAndroid</code> (UEDeployAndroid.cs)</li>
<li><code>MakeApk</code> in <code>UEDeployAndroid</code> (UEDeployAndroid.cs) (the most critical function)</li>
</ol>
<p>The <code>MakeApk</code> function receives a special control parameter <code>bDisallowExternalFilesDir</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UEDeployAndroid.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">MakeApk</span><span class="params">(AndroidToolChain ToolChain, string ProjectName, TargetType InTargetType, string ProjectDirectory, string OutputPath, string EngineDirectory, <span class="type">bool</span> bForDistribution, string CookFlavor, <span class="type">bool</span> bMakeSeparateApks, <span class="type">bool</span> bIncrementalPackage, <span class="type">bool</span> bDisallowPackagingDataInApk, <span class="type">bool</span> bDisallowExternalFilesDir)</span></span>;</span><br></pre></td></tr></table></figure>

<p>It is used to control whether to enable the <code>Use ExternalFilesDir for UE4Game Files</code> option in project settings.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UEDeployAndroid.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">MakeApk</span><span class="params">(AndroidToolChain ToolChain, string ProjectName, TargetType InTargetType, string ProjectDirectory, string OutputPath, string EngineDirectory, <span class="type">bool</span> bForDistribution, string CookFlavor, <span class="type">bool</span> bMakeSeparateApks, <span class="type">bool</span> bIncrementalPackage, <span class="type">bool</span> bDisallowPackagingDataInApk, <span class="type">bool</span> bDisallowExternalFilesDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="type">bool</span> bUseExternalFilesDir = <span class="built_in">UseExternalFilesDir</span>(bDisallowExternalFilesDir);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// func UseExternalFilesDir</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">bool</span> <span class="title">UseExternalFilesDir</span><span class="params">(<span class="type">bool</span> bDisallowExternalFilesDir, ConfigHierarchy Ini = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bDisallowExternalFilesDir)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make a new one if one wasn&#x27;t passed in</span></span><br><span class="line">  <span class="keyword">if</span> (Ini == null)</span><br><span class="line">  &#123;</span><br><span class="line">    Ini = <span class="built_in">GetConfigCacheIni</span>(ConfigHierarchyType.Engine);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we check this a lot, so make it easy </span></span><br><span class="line">  <span class="type">bool</span> bUseExternalFilesDir;</span><br><span class="line">  Ini.<span class="built_in">GetBool</span>(<span class="string">&quot;/Script/AndroidRuntimeSettings.AndroidRuntimeSettings&quot;</span>, <span class="string">&quot;bUseExternalFilesDir&quot;</span>, out bUseExternalFilesDir);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bUseExternalFilesDir;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As can be seen, if <code>bDisallowExternalFilesDir</code> is true, it will not read the configuration in project settings at all.</p>
<p>The critical point is that, when calling <code>MakeApk</code> in <code>PrepTargetForDeployment</code>, the default parameter passed is true:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UEDeployAndroid.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="type">bool</span> <span class="title">PrepTargetForDeployment</span><span class="params">(UEBuildDeployTarget InTarget)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//Log.TraceInformation(&quot;$$$$$$$$$$$$$$ PrepTargetForDeployment $$$$$$$$$$$$$$$$$ &#123;0&#125;&quot;, InTarget.TargetName);</span></span><br><span class="line">  AndroidToolChain ToolChain = <span class="keyword">new</span> <span class="built_in">AndroidToolChain</span>(InTarget.ProjectFile, <span class="literal">false</span>, InTarget.AndroidArchitectures, InTarget.AndroidGPUArchitectures); </span><br><span class="line"></span><br><span class="line">  <span class="comment">// we need to strip architecture from any of the output paths</span></span><br><span class="line">  string BaseSoName = ToolChain.<span class="built_in">RemoveArchName</span>(InTarget.OutputPaths[<span class="number">0</span>].FullName);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get the receipt</span></span><br><span class="line">  UnrealTargetPlatform Platform = InTarget.Platform;</span><br><span class="line">  UnrealTargetConfiguration Configuration = InTarget.Configuration;</span><br><span class="line">  string ProjectBaseName = Path.<span class="built_in">GetFileName</span>(BaseSoName).<span class="built_in">Replace</span>(<span class="string">&quot;-&quot;</span> + Platform, <span class="string">&quot;&quot;</span>).<span class="built_in">Replace</span>(<span class="string">&quot;-&quot;</span> + Configuration, <span class="string">&quot;&quot;</span>).<span class="built_in">Replace</span>(<span class="string">&quot;.so&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  FileReference ReceiptFilename = TargetReceipt.<span class="built_in">GetDefaultPath</span>(InTarget.ProjectDirectory, ProjectBaseName, Platform, Configuration, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  Log.<span class="built_in">TraceInformation</span>(<span class="string">&quot;Receipt Filename: &#123;0&#125;&quot;</span>, ReceiptFilename);</span><br><span class="line">  <span class="built_in">SetAndroidPluginData</span>(ToolChain.<span class="built_in">GetAllArchitectures</span>(), <span class="built_in">CollectPluginDataPaths</span>(TargetReceipt.<span class="built_in">Read</span>(ReceiptFilename, UnrealBuildTool.EngineDirectory, InTarget.ProjectDirectory)));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make an apk at the end of compiling, so that we can run without packaging (debugger, cook on the fly, etc)</span></span><br><span class="line">  string RelativeEnginePath = UnrealBuildTool.EngineDirectory.<span class="built_in">MakeRelativeTo</span>(DirectoryReference.<span class="built_in">GetCurrentDirectory</span>());</span><br><span class="line">  <span class="built_in">MakeApk</span>(ToolChain, InTarget.TargetName, InTarget.ProjectDirectory.FullName, BaseSoName, RelativeEnginePath, bForDistribution: <span class="literal">false</span>, CookFlavor: <span class="string">&quot;&quot;</span>,</span><br><span class="line">bMakeSeparateApks: <span class="built_in">ShouldMakeSeparateApks</span>(), bIncrementalPackage: <span class="literal">true</span>, bDisallowPackagingDataInApk: <span class="literal">false</span>, bDisallowExternalFilesDir: <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if we made any non-standard .apk files, the generated debugger settings may be wrong</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ShouldMakeSeparateApks</span>() &amp;&amp; (InTarget.OutputPaths.Count &gt; <span class="number">1</span> || !InTarget.OutputPaths[<span class="number">0</span>].FullName.<span class="built_in">Contains</span>(<span class="string">&quot;-armv7-es2&quot;</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    Console.<span class="built_in">WriteLine</span>(<span class="string">&quot;================================================================================================================================&quot;</span>);</span><br><span class="line">    Console.<span class="built_in">WriteLine</span>(<span class="string">&quot;Non-default apk(s) have been made: If you are debugging, you will need to manually select one to run in the debugger properties!&quot;</span>);</span><br><span class="line">    Console.<span class="built_in">WriteLine</span>(<span class="string">&quot;================================================================================================================================&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is really a tricky point… I see that the UBT source code for UE4.18 is the same, it is still disabled by default. Clearly, there is this option, yet it is closed by default without any prompt, which is quite frustrating.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>In fact, modifying the engine code and using the <code>manifest</code> both have their advantages:</p>
<ul>
<li>The advantage of modifying the code is that you can specify any path (not necessarily reasonable), but the downside is that you need the source version of the engine.</li>
<li>The advantage of using the <code>Manifest</code> is that you don’t need the source version of the engine, but can only use <code>InternalFilesDir</code> (Shipping) or <code>ExternalFilesDir</code> (not-shipping).</li>
</ul>
<p>By the way, let’s complain a bit about UE; why expose an option that doesn’t work in the settings?</p>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                The article is finished. If you have any questions, please comment and communicate.
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/20367/" target="_blank">Modify the default data storage path for Android games</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2020/01/22 09:10<br/>
             
             <span>Word Count:</span><span class="page-count">7k Words</span><br/>
             
             <span>Link:</span><a href="/posts/20367/" target="_blank" title="Modify the default data storage path for Android games">https://en.imzlp.com/posts/20367/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/20367/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/Android/" rel="tag"># Android</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/20425/" rel="prev" title="The Differences and Relationships between UEC++ and Standard C++">
      <i class="fa fa-chevron-left"></i> The Differences and Relationships between UEC++ and Standard C++
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/17590/" rel="next" title="HotPatcher: A open source UE resource hot patching tool">
      HotPatcher: A open source UE resource hot patching tool <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Modifying-Engine-Code"><span class="nav-number">1.</span> <span class="nav-text">Modifying Engine Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Controlling-with-Manifest"><span class="nav-number">2.</span> <span class="nav-text">Controlling with Manifest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Controlling-bUseExternalFilesDir-via-UPL"><span class="nav-number">3.</span> <span class="nav-text">Controlling bUseExternalFilesDir via UPL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Analysis-of-the-Ineffectiveness-of-the-bUseExternalFilesDir-Option-in-Project-Settings"><span class="nav-number">4.</span> <span class="nav-text">Analysis of the Ineffectiveness of the bUseExternalFilesDir Option in Project Settings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conclusion"><span class="nav-number">5.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/20367/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
