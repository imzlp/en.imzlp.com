<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="In UE, there is a PSO Cache mechanism, which stands for Pipeline State Object Caching. It is used to pre-record and construct the shader information dependent on the materials used at runtime. When th">
<meta property="og:type" content="article">
<meta property="og:title" content="UE project optimization: PSO Cache">
<meta property="og:url" content="https://en.imzlp.com/posts/24336/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="In UE, there is a PSO Cache mechanism, which stands for Pipeline State Object Caching. It is used to pre-record and construct the shader information dependent on the materials used at runtime. When th">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2022/202302051843926.webp">
<meta property="article:published_time" content="2021-04-22T19:40:55.000Z">
<meta property="article:modified_time" content="2021-04-22T19:40:55.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="PSOCache">
<meta property="article:tag" content="PSO">
<meta property="article:tag" content="优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2022/202302051843926.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/24336/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>UE project optimization: PSO Cache | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/24336/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          UE project optimization: PSO Cache<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2021-04-22-24336.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/24336/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        
          <div class="post-subtitle" style="text-align: center;line-height: 1;">
            <sub text-align="center" style="font-size: 15px;align-content: center;font-style: italic;bottom: 0em;">UE项目优化：PSO Cache</sub>
          </div>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-22 19:40 19:40:55:40" itemprop="dateCreated datePublished" datetime="2021-04-22T19:40:55+00:00">2021-04-22 19:40</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/" itemprop="url" rel="index"><span itemprop="name">UnrealEngine</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/PSOCache/" itemprop="url" rel="index"><span itemprop="name">PSOCache</span></a>
                </span>
            </span>

          
            <span id="/posts/24336/" class="post-meta-item leancloud_visitors" data-flag-title="UE project optimization: PSO Cache" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>30 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>In UE, there is a PSO Cache mechanism, which stands for Pipeline State Object Caching. It is used to pre-record and construct the shader information dependent on the materials used at runtime. When the project first utilizes these shaders, this list can speed up the shader loading/compilation process. The PSO Cache saves rendering states, vertex declarations, primitive types, render target pixel formats, and other data to files, enhancing shader loading efficiency. This article primarily introduces the enabling and construction process of PSO Cache, and will analyze the loading process of PSO Cache in the engine, along with implementing hot-update PSO methods, error handling, etc. The principle of PSO Cache will be analyzed in detail later.</p>
<span id="more"></span>

<p>The official documentation for PSO Cache: <a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/SharingAndReleasing/PSOCaching/index.html">PSO Cache</a>.</p>
<p>Overview of the PSO Cache construction process:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/PSO_Caching_Digramh.webp"></p>
<p>The deployment and use of PSO Cache can be roughly divided into the following steps:</p>
<ol>
<li>Enable PSO Cache and Shader Stable Keys for the project, and after packaging, you can obtain <code>ShaderStableInfo*.scl.csv</code> from the <code>Metadata/PipelineCaches</code> directory.</li>
<li>Add the <code>logPSO</code> parameter to start the game, which is used to record PSO data at runtime (<code>*.rec.upipelinecache</code>).</li>
<li>Generate <code>*.stablepc.csv</code> using <code>ShaderStableInfo*.scl.csv</code> and <code>*.rec.upipelinecache</code>.</li>
<li>Execute Cook again to generate the <code>upipelinecache</code> file using <code>*.stablepc.csv</code>, which will be included in the package.</li>
<li>Start the game, and the engine will automatically load <code>*.stable.upipelinecache</code>, using the PSO Cache when compiling shaders.</li>
</ol>
<p>The content order of this article also follows these steps.</p>
<h3 id="Enable-Shader-Stable-Keys"><a href="#Enable-Shader-Stable-Keys" class="headerlink" title="Enable Shader Stable Keys"></a>Enable Shader Stable Keys</h3><p>First, you need to enable <code>ShaderStableKeys</code> for the project to generate stable Shader Keys during Cook, serving as a record for shaders.</p>
<p>Add the following value in <code>DefaultEngine.ini</code> (or platform-specific files like AndroidEngine.ini):</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DevOptions.Shaders]</span></span><br><span class="line"><span class="attr">NeedsShaderStableKeys</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>After adding this, execute packaging (Cook) again, which will create the following directory:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Saved/Cooked/PLATFORM_NAME/PROJECT_NAME/Metadata/PipelineCaches</span><br></pre></td></tr></table></figure>
<p>And it will produce two files in this directory (corresponding to the project and the engine):</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ShaderStableInfo-PROJECT_NAME-GLSL_ES3_1_ANDROID.scl.csv</span><br><span class="line">ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv</span><br></pre></td></tr></table></figure>
<p>During the Cook process, the following log will indicate that these two files were generated:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LogCook: Display: Saved scl.csv D:/PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Metadata/PipelineCaches/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv for platform Android_ASTC</span><br><span class="line">LogCook: Display: Saved scl.csv D:/PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Metadata/PipelineCaches/ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv for platform Android_ASTC</span><br></pre></td></tr></table></figure>

<p>You can use them to generate <code>*.stablepc.csv</code> by running the commandlet <code>-run=ShaderPipelineCacheTools</code>.</p>
<p>The content of the <code>*.scl.csv</code> file:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210422200532.webp"></p>
<h3 id="Runtime-Capture-of-PSO-Data"><a href="#Runtime-Capture-of-PSO-Data" class="headerlink" title="Runtime Capture of PSO Data"></a>Runtime Capture of PSO Data</h3><p>When starting the game, add the <code>-logPSO</code> parameter or include the following configuration in <code>DefaultEngine.ini</code>:</p>
<figure class="highlight ini"><figcaption><span>Config/DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.Enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.LogPSO</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveBoundPSOLog</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>You can also set these parameters in the <code>Devices Profile</code>:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210420172045.webp"></p>
<p>These two parameters are used in the following code:</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RHI/Private/PipelineFileCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FPipelineFileCache::IsPipelineFileCacheEnabled</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">bool</span> bOnce = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">bool</span> bCmdLineForce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!bOnce)</span><br><span class="line">  &#123;</span><br><span class="line">    bOnce = <span class="literal">true</span>;</span><br><span class="line">    bCmdLineForce = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;psocache&quot;</span>));</span><br><span class="line">    <span class="built_in">UE_CLOG</span>(bCmdLineForce, LogRHI, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;****************************** Forcing PSO cache from command line&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> FileCacheEnabled &amp;&amp; (bCmdLineForce || CVarPSOFileCacheEnabled.<span class="built_in">GetValueOnAnyThread</span>() == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FPipelineFileCache::LogPSOtoFileCache</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">bool</span> bOnce = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">bool</span> bCmdLineForce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!bOnce)</span><br><span class="line">  &#123;</span><br><span class="line">    bOnce = <span class="literal">true</span>;</span><br><span class="line">    bCmdLineForce = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;logpso&quot;</span>));</span><br><span class="line">    <span class="built_in">UE_CLOG</span>(bCmdLineForce, LogRHI, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;****************************** Forcing logging of PSOs from command line&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (bCmdLineForce || CVarPSOFileCacheLogPSO.<span class="built_in">GetValueOnAnyThread</span>() == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>During gameplay, the log will include:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LogConfig: Applying CVar settings from Section [ConsoleVariables] File [../../../FGame/Saved/Config/Android/Engine.ini]</span><br><span class="line">LogConfig: Setting CVar [[r.ShaderPipelineCache.Enabled:1]]</span><br><span class="line">LogConfig: Setting CVar [[r.ShaderPipelineCache.LogPSO:1]]</span><br><span class="line">LogConfig: Setting CVar [[r.ShaderPipelineCache.SaveBoundPSOLog:1]]</span><br><span class="line">...</span><br><span class="line">LogRHI: Base name for record PSOs is ../../../FGame/Saved/CollectedPSOs/++UE4+Release-4.25-CL-0-FGame_GLSL_ES3_1_ANDROID_00084A4308D90436AC0F652223AA8D4F.rec.upipelinecache</span><br><span class="line">LogRHI: Could not open FPipelineCacheFile: ../../../FGame/Content/PipelineCaches/Android/FGame_GLSL_ES3_1_ANDROID.upipelinecache</span><br><span class="line">...</span><br><span class="line">LogRHI: Display: Encountered a new graphics PSO: 3478445130</span><br><span class="line">LogRHI: Display: New Graphics PSO (3478445130) Description: 416F798F22743F626513A16205A15ECB135C3791,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,&lt;0 1 0 0 1 0 0 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0&gt;,&lt;0.000000 0.000000 2 1 0 0&gt;,&lt;0 3 0 7 0 0 0 0 7 0 0 0 255 255&gt;,1,11,1051148,2,2,0,0,0,4,10,1114633,0,0,18,2569,0,0,37,1051145,0,0,37,2585,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15360,15391,1055,1027,1025,0,0,0,0,1,&lt;0 0 3 0 12 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;</span><br><span class="line">LogRHI: Display: Encountered a new graphics PSO: 898510125</span><br><span class="line">LogRHI: Display: New Graphics PSO (898510125) Description: 432A3E5557E9ED8328AC7E6CDA5AA6FC2F0B2439,0FED48EC019CFDD251488DE33D563DCFFD7E69DA,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,0000000000000000000000000000000000000000,&lt;0 1 0 0 1 0 7 0 1 0 0 1 0 0 0 1 0 0 1 0 0 0 1 0 0 1 0 0 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0 1 0 0 1 0 15 0&gt;,&lt;0.000000 0.000000 2 0 0 0&gt;,&lt;0 7 0 7 0 0 0 0 7 0 0 0 255 255&gt;,1,11,1051148,2,2,0,0,0,4,10,1114633,0,0,18,2569,0,0,37,1051145,0,0,37,2585,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15360,15391,1055,1027,1025,0,0,0,2,2,&lt;0 0 4 0 32 0&gt;,&lt;0 16 2 1 32 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;,&lt;0 0 0 0 0 0&gt;</span><br></pre></td></tr></table></figure>
<p>And a following file will be created in <code>Saved/CoolectedPSOs</code>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210420185534.webp"></p>
<blockquote>
<p>Note that by default, only the current MaterialQualityLevel will be collected. If you wish to collect for other qualities, you need to switch and rerun.</p>
</blockquote>
<h3 id="Generate-stablepc-csv"><a href="#Generate-stablepc-csv" class="headerlink" title="Generate *.stablepc.csv"></a>Generate *.stablepc.csv</h3><p>Use the following commandlet:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Engine/Binaries/Win64/UE4Editor-Cmd.exe</span><br><span class="line">D:/Client/Client.uproject</span><br><span class="line">-run=ShaderPipelineCacheTools <span class="built_in">expand</span></span><br><span class="line">D:/PSOCache/*.rec.upipelinecache</span><br><span class="line">D:/PSOCache/*.scl.csv</span><br><span class="line">D:/PSOCache/Client_GLSL_ES3_1_ANDROID.stablepc.csv</span><br></pre></td></tr></table></figure>
<p>The above command will generate the <code>Client_GLSL_ES3_1_ANDROID.stablepc.csv</code> file under the engine’s Binaries/Win64. Note that it must match the naming convention <code>&#123;PROJECTNAME&#125;_&#123;SHADER_FORMART_NAME&#125;.stablepc.csv</code>.</p>
<p>For Android, the naming will be: Client_GLSL_ES3_1_ANDROID.stablepc.csv<br>For iOS, the naming will be: Client_SF_METAL.stablepc.csv</p>
<p>During generation, the following logs will be produced:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">D:\PSOCache&gt;&quot;C:\Program Files\Epic Games\UE_4.25\Engine\Binaries\Win64\UE4Editor-Cmd.exe&quot; &quot;D:\PSOExample\PSOExample.uproject&quot; -run=ShaderPipelineCacheTools expand D:/PSOCache/*.rec.upipelinecache D:/PSOCache/*.scl.csv D:/PSOCache/PSOExample_GLSL_ES3_1_ANDROID.stablepc.csv</span><br><span class="line">[2021.04.22-08.57.39:623][  0]LogTargetPlatformManager: Display: Building Assets For Windows</span><br><span class="line">[2021.04.22-08.57.39:648][  0]LogAudioDebug: Display: Lib vorbis DLL was dynamically loaded.</span><br><span class="line">[2021.04.22-08.57.39:841][  0]LogShaderCompilers: Display: Using Local Shader Compiler.</span><br><span class="line">[2021.04.22-08.57.40:492][  0]LogDerivedDataCache: Display: Max Cache Size: 512 MB</span><br><span class="line">[2021.04.22-08.57.40:523][  0]LogDerivedDataCache: Display: Loaded Boot cache: C:/Users/lipengzha/AppData/Local/UnrealEngine/4.25/DerivedDataCache/Boot.ddc</span><br><span class="line">[2021.04.22-08.57.40:533][  0]LogDerivedDataCache: Display: Pak cache opened for reading ../../../Engine/DerivedDataCache/Compressed.ddp.</span><br><span class="line">[2021.04.22-08.57.44:616][  0]LogAudioCaptureCore: Display: No Audio Capture implementations found. Audio input will be silent.</span><br><span class="line">[2021.04.22-08.57.44:616][  0]LogAudioCaptureCore: Display: No Audio Capture implementations found. Audio input will be silent.</span><br><span class="line">[2021.04.22-08.57.45:274][  0]LogShaderPipelineCacheTools: Display: Loading D:/PSOCache/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv...</span><br><span class="line">[2021.04.22-08.57.45:275][  0]LogShaderPipelineCacheTools: Display: Loading D:/PSOCache/ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv...</span><br><span class="line">[2021.04.22-08.57.45:280][  0]LogShaderPipelineCacheTools: Display: Loaded 548 shader info lines from D:/PSOCache/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv.</span><br><span class="line">[2021.04.22-08.57.45:287][  0]LogShaderPipelineCacheTools: Display: Loaded 5707 shader info lines from D:/PSOCache/ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv.</span><br><span class="line">[2021.04.22-08.57.45:287][  0]LogShaderPipelineCacheTools: Display: Loaded 6255 unique shader info lines total.</span><br><span class="line">[2021.04.22-08.57.45:289][  0]LogShaderPipelineCacheTools: Display: Loading D:/PSOCache/++UE4+Release-4.25-CL-13942748-PSOExample_GLSL_ES3_1_ANDROID_000843BC08D905AF09E24614C6A6086F.rec.upipelinecache....</span><br><span class="line">[2021.04.22-08.57.45:293][  0]LogShaderPipelineCacheTools: Display: Loaded 105 PSOs</span><br><span class="line">[2021.04.22-08.57.45:297][  0]LogShaderPipelineCacheTools: Display: Loaded 105 PSOs total [Usage Mask Merged = 0].</span><br><span class="line">[2021.04.22-08.57.45:325][  0]LogShaderPipelineCacheTools: Display: Generated 478 stable PSOs total</span><br><span class="line">[2021.04.22-08.57.45:344][  0]LogShaderPipelineCacheTools: Display: Wrote stable PSOs, 479 lines (541.8 KB) to D:/PSOCache/PSOExample_GLSL_ES3_1_ANDROID.stablepc.csv</span><br><span class="line">[2021.04.22-08.57.45:346][  0]LogInit: Display:</span><br><span class="line">[2021.04.22-08.57.45:349][  0]LogInit: Display: Success - 0 error(s), 0 warning(s)</span><br><span class="line">[2021.04.22-08.57.45:353][  0]LogInit: Display:</span><br><span class="line">Execution of commandlet took:  0.08 seconds</span><br><span class="line">[2021.04.22-08.57.45:408][  0]LogShaderCompilers: Display: Shaders left to compile 0</span><br><span class="line">[2021.04.22-08.57.45:621][  0]LogContentStreaming: Display: There are 1 unreleased StreamingManagers</span><br></pre></td></tr></table></figure>

<p>All files needed for the final PSO:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">D:\PSOCache&gt;tree /a /f</span><br><span class="line">Volume in drive D is Data</span><br><span class="line">Volume serial number is 004B-E876</span><br><span class="line">D:.</span><br><span class="line">    ++UE4+Release-4.25-CL-13942748-PSOExample_GLSL_ES3_1_ANDROID_000843BC08D905AF09E24614C6A6086F.rec.upipelinecache</span><br><span class="line">    PSOExample_GLSL_ES3_1_ANDROID.stablepc.csv</span><br><span class="line">    ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv</span><br><span class="line">    ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv</span><br></pre></td></tr></table></figure>
<p>I backed up the files generated by the test project: <a href="PSOCache.7z">PSOCache.7z</a>, which allows you to view the contents of each file.</p>
<h3 id="Generate-stable-upipelinecache"><a href="#Generate-stable-upipelinecache" class="headerlink" title="Generate *.stable.upipelinecache"></a>Generate *.stable.upipelinecache</h3><p>Place the generated <code>*stablepc.csv</code> into the <code>Build/Android/PipelineCaches</code> directory, noting that the <code>Build/PLATFORM</code> this platform is the compilation platform, not the resource platform during Cook; for Android, the package should be <code>Android</code>, not <code>Android_ASTC</code>, etc. Then repackage.</p>
<p>The engine creates the PipelineCache using <code>stablepc.csv</code> during Cook:</p>
<figure class="highlight cpp"><figcaption><span>Editor\UnrealEd\Private\CookOnTheFlyServer.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UCookOnTheFlyServer::CreatePipelineCache</span><span class="params">(<span class="type">const</span> ITargetPlatform* TargetPlatform, <span class="type">const</span> FString&amp; LibraryName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// make sure we have a registry generated for all the platforms </span></span><br><span class="line">  <span class="type">const</span> FString TargetPlatformName = TargetPlatform-&gt;<span class="built_in">PlatformName</span>();</span><br><span class="line">  TArray&lt;FString&gt;* SCLCSVPaths = OutSCLCSVPaths.<span class="built_in">Find</span>(<span class="built_in">FName</span>(TargetPlatformName));</span><br><span class="line">  <span class="keyword">if</span> (SCLCSVPaths &amp;&amp; SCLCSVPaths-&gt;<span class="built_in">Num</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FName&gt; ShaderFormats;</span><br><span class="line">    TargetPlatform-&gt;<span class="built_in">GetAllTargetedShaderFormats</span>(ShaderFormats);</span><br><span class="line">    <span class="keyword">for</span> (FName ShaderFormat : ShaderFormats)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// *stablepc.csv or *stablepc.csv.compressed</span></span><br><span class="line">      <span class="type">const</span> FString Filename = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;*%s_%s.stablepc.csv&quot;</span>), *LibraryName, *ShaderFormat.<span class="built_in">ToString</span>());</span><br><span class="line">      <span class="type">const</span> FString StablePCPath = FPaths::<span class="built_in">ProjectDir</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;Build&quot;</span>) / TargetPlatform-&gt;<span class="built_in">IniPlatformName</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;PipelineCaches&quot;</span>) / Filename;</span><br><span class="line">      <span class="type">const</span> FString StablePCPathCompressed = StablePCPath + <span class="built_in">TEXT</span>(<span class="string">&quot;.compressed&quot;</span>);</span><br><span class="line"></span><br><span class="line">      TArray&lt;FString&gt; ExpandedFiles;</span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(ExpandedFiles, *FPaths::<span class="built_in">GetPath</span>(StablePCPath), *FPaths::<span class="built_in">GetCleanFilename</span>(StablePCPath), <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(ExpandedFiles, *FPaths::<span class="built_in">GetPath</span>(StablePCPathCompressed), *FPaths::<span class="built_in">GetCleanFilename</span>(StablePCPathCompressed), <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (!ExpandedFiles.<span class="built_in">Num</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;---- NOT Running UShaderPipelineCacheToolsCommandlet for platform %s  shader format %s, no files found at %s&quot;</span>), *TargetPlatformName, *ShaderFormat.<span class="built_in">ToString</span>(), *StablePCPath);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;---- Running UShaderPipelineCacheToolsCommandlet for platform %s  shader format %s&quot;</span>), *TargetPlatformName, *ShaderFormat.<span class="built_in">ToString</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> FString OutFilename = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s_%s.stable.upipelinecache&quot;</span>), *LibraryName, *ShaderFormat.<span class="built_in">ToString</span>());</span><br><span class="line">        <span class="type">const</span> FString PCUncookedPath = FPaths::<span class="built_in">ProjectDir</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>) / <span class="built_in">TEXT</span>(<span class="string">&quot;PipelineCaches&quot;</span>) / TargetPlatform-&gt;<span class="built_in">IniPlatformName</span>() / OutFilename;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (IFileManager::<span class="built_in">Get</span>().<span class="built_in">FileExists</span>(*PCUncookedPath))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogCook, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Deleting %s, cooked data doesn&#x27;t belong here.&quot;</span>), *PCUncookedPath);</span><br><span class="line">          IFileManager::<span class="built_in">Get</span>().<span class="built_in">Delete</span>(*PCUncookedPath, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> FString PCCookedPath = <span class="built_in">ConvertToFullSandboxPath</span>(*PCUncookedPath, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">const</span> FString PCPath = PCCookedPath.<span class="built_in">Replace</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;[Platform]&quot;</span>), *TargetPlatformName);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function">FString <span class="title">Args</span><span class="params">(TEXT(<span class="string">&quot;build &quot;</span>))</span></span>;</span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        Args += StablePCPath;</span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        int32 NumMatched = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; SCLCSVPaths-&gt;<span class="built_in">Num</span>(); Index++)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(*SCLCSVPaths)[Index].<span class="built_in">Contains</span>(ShaderFormat.<span class="built_in">ToString</span>()))</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          NumMatched++;</span><br><span class="line">          Args += <span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">          Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">          Args += (*SCLCSVPaths)[Index];</span><br><span class="line">          Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!NumMatched)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogCook, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Shader format %s for platform %s had this file %s, but no .scl.csv files.&quot;</span>), *ShaderFormat.<span class="built_in">ToString</span>(), *TargetPlatformName, *StablePCPath);</span><br><span class="line">          <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; SCLCSVPaths-&gt;<span class="built_in">Num</span>(); Index++)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogCook, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;    .scl.csv file: %s&quot;</span>), *((*SCLCSVPaths)[Index]));</span><br><span class="line">          &#125;              </span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        Args += PCPath;</span><br><span class="line">        Args += <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;  With Args: %s&quot;</span>), *Args);</span><br><span class="line"></span><br><span class="line">        int32 Result = UShaderPipelineCacheToolsCommandlet::<span class="built_in">StaticMain</span>(Args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Result)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">LogCookerMessage</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UShaderPipelineCacheToolsCommandlet failed %d&quot;</span>), Result), EMessageSeverity::Error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;---- Done running UShaderPipelineCacheToolsCommandlet for platform %s&quot;</span>), *TargetPlatformName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The actual use of <code>stablepc.csv</code> is to execute the <code>ShaderPipelineCacheTools</code> commandlet to generate upipelinecache files and include them in the package.</p>
<p>The execution command for ShaderPipelineCacheToolsCommandlet is:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Engine\Binaries\Win64\UE4Editor-Cmd.exe</span><br><span class="line">D:\PSOExample\PSOExample.uproject</span><br><span class="line">-run=ShaderPipelineCacheTools build</span><br><span class="line">&quot;D:\PSOExample/Build/Android/PipelineCaches/*PSOExample_GLSL_ES3_1_ANDROID.stablepc.csv&quot;</span><br><span class="line">&quot;D:\PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Metadata/PipelineCaches/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv&quot;</span><br><span class="line">&quot;D:\PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Metadata/PipelineCaches/ShaderStableInfo-PSOExample-GLSL_ES3_1_ANDROID.scl.csv&quot;</span><br><span class="line">&quot;D:\PSOExample/Saved/Cooked/Android_ASTC/PSOExample/Content/PipelineCaches/Android/PSOExample_GLSL_ES3_1_ANDROID.stable.upipelinecache&quot;</span><br></pre></td></tr></table></figure>

<p>The path for the generated <code>*.stable.upipelinecache</code> file in the package is <code>Content\PipelineCaches\Android</code>:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\PSOExample\Saved\Cooked\Android_ASTC\PSOExample\Content\PipelineCaches&gt;tree /a /f</span><br><span class="line">Volume in drive C is Windows</span><br><span class="line">Volume serial number is 0C49-9EA3</span><br><span class="line">C:.</span><br><span class="line">\---Android</span><br><span class="line">        PSOExample_GLSL_ES3_1_ANDROID.stable.upipelinecache</span><br></pre></td></tr></table></figure>
<p>Since it is located under Content and will be packed into pak, it can also be updated hot.</p>
<p>When a package containing the upipelinecache is installed, the following log will appear at runtime:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LogShaderLibrary: Display: Using ../../../PSOExample/Content/ShaderArchive-PSOExample-GLSL_ES3_1_ANDROID.ushaderbytecode for material shader code. Total 3053 unique shaders.</span><br><span class="line">LogShaderLibrary: Display: Cooked Context: Using Shared Shader Library PSOExample</span><br><span class="line">LogRHI: Display: Opened pipeline cache after state change and enqueued 0 of 0 tasks for precompile.</span><br><span class="line">LogRHI: Base name for record PSOs is ../../../PSOExample/Saved/CollectedPSOs/++UE4+Release-4.25-CL-13942748-PSOExample_GLSL_ES3_1_ANDROID_00087B4B08D905BBC5A827F40CA03A0C.rec.upipelinecache</span><br><span class="line">LogRHI: FPipelineCacheFile Header Game Version: 13942748</span><br><span class="line">LogRHI: FPipelineCacheFile Header Engine Data Version: 17</span><br><span class="line">LogRHI: FPipelineCacheFile Header TOC Offset: 38155</span><br><span class="line">LogRHI: FPipelineCacheFile File Size: 51011 Bytes</span><br><span class="line">LogRHI: Opened FPipelineCacheFile: ../../../PSOExample/Content/PipelineCaches/Android/PSOExample_GLSL_ES3_1_ANDROID.stable.upipelinecache (GUID: 00000000000000000000000000000000) with 102 entries.</span><br><span class="line">LogRHI: Scanning Binary program cache, using Shader Pipeline Cache version 6988202F47BA858F3F0DE483D7DB0606</span><br><span class="line">LogRHI: AndroidEGL:SwapBuffers eglGetCompositorTimingANDROID EGL_COMPOSITE_DEADLINE_ANDROID=2718926192606265, EGL_COMPOSITE_INTERVAL_ANDROID=16559027, EGL_COMPOSITE_TO_PRESENT_LATENCY_ANDROID=14559027</span><br></pre></td></tr></table></figure>
<h3 id="Loading-and-Hot-Updating-PSO-Cache"><a href="#Loading-and-Hot-Updating-PSO-Cache" class="headerlink" title="Loading and Hot Updating PSO Cache"></a>Loading and Hot Updating PSO Cache</h3><p>Similar to <code>ShaderCode</code>, the engine automatically loads the PSO Cache upon startup by calling <code>FPipelineCacheFile::OpenPipelineFileCache</code> to read <code>*.stable.upipelinecache</code> within <code>FEngineLoop</code>.</p>
<p>The code for loading PSO in <code>PreInitPreStartupScreen</code> is as follows:</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Private/LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInitPreStartupScreen</span><span class="params">(<span class="type">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">bool</span> bUseCodeLibrary = FPlatformProperties::<span class="built_in">RequiresCookedData</span>() || GAllowCookedDataInEditorBuilds;</span><br><span class="line">    <span class="keyword">if</span> (bUseCodeLibrary)</span><br><span class="line">    &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::InitForRuntime&quot;</span>);</span><br><span class="line">        <span class="comment">// Will open material shader code storage if project was packaged with it</span></span><br><span class="line">        <span class="comment">// This only opens the Global shader library, which is always in the content dir.</span></span><br><span class="line">        FShaderCodeLibrary::<span class="built_in">InitForRuntime</span>(GMaxRHIShaderPlatform);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">if</span> !UE_EDITOR</span></span><br><span class="line">      <span class="comment">// Cooked data only - but also requires the code library - game only</span></span><br><span class="line">      <span class="keyword">if</span> (FPlatformProperties::<span class="built_in">RequiresCookedData</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderPipelineCache::Initialize&quot;</span>);</span><br><span class="line">        <span class="comment">// Initialize the pipeline cache system. Opening is deferred until the manual call to</span></span><br><span class="line">        <span class="comment">// OpenPipelineFileCache below, after content pak&#x27;s ShaderCodeLibraries are loaded.</span></span><br><span class="line">        FShaderPipelineCache::<span class="built_in">Initialize</span>(GMaxRHIShaderPlatform);</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span> <span class="comment">//!UE_EDITOR</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">//Handle opening shader library after our EarlyLoadScreen</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LLM_SCOPE</span>(ELLMTag::Shaders);</span><br><span class="line">    <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::OpenLibrary&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open the game library which contains the material shaders.</span></span><br><span class="line">    FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> FString&amp; RootDir : FPlatformMisc::<span class="built_in">GetAdditionalRootDirectories</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">Combine</span>(RootDir, FApp::<span class="built_in">GetProjectName</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now our shader code main library is opened, kick off the precompile, if already initialized</span></span><br><span class="line">    FShaderPipelineCache::<span class="built_in">OpenPipelineFileCache</span>(GMaxRHIShaderPlatform);</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FShaderPipelineCache::OpenPipelineFileCache</code> has two overloaded versions:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RenderCore\Private\ShaderPipelineCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FShaderPipelineCache::OpenPipelineFileCache</span><span class="params">(EShaderPlatform Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">bool</span> bFileOpen = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (GConfig)</span><br><span class="line">  &#123;</span><br><span class="line">    FString LastOpenedName;</span><br><span class="line">    <span class="keyword">if</span> ((GConfig-&gt;<span class="built_in">GetString</span>(FShaderPipelineCacheConstants::SectionHeading, FShaderPipelineCacheConstants::LastOpenedKey, LastOpenedName, *GGameUserSettingsIni) || GConfig-&gt;<span class="built_in">GetString</span>(FShaderPipelineCacheConstants::SectionHeading, FShaderPipelineCacheConstants::LastOpenedKey, LastOpenedName, *GGameIni)) &amp;&amp; LastOpenedName.<span class="built_in">Len</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      bFileOpen = <span class="built_in">OpenPipelineFileCache</span>(LastOpenedName, Platform);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bFileOpen)</span><br><span class="line">  &#123;</span><br><span class="line">    bFileOpen = <span class="built_in">OpenPipelineFileCache</span>(FApp::<span class="built_in">GetProjectName</span>(), Platform);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bFileOpen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FShaderPipelineCache::OpenPipelineFileCache</span><span class="params">(FString <span class="type">const</span>&amp; Name, EShaderPlatform Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (ShaderPipelineCache)</span><br><span class="line">    <span class="keyword">return</span> ShaderPipelineCache-&gt;<span class="built_in">Open</span>(Name, Platform);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Upon engine startup, it defaults to reading <code>OpenPipelineFileCache(FApp::GetProjectName(), Platform)</code>, which is <code>PSOExample_GLSL_ES3_1_ANDROID.stable.upipelinecache</code>. The Platform parameter can be obtained by passing the global object <code>GMaxRHIShaderPlatform</code>.</p>
<p>UE also provides a <code>console</code> command to specify loading <code>stable.upipelinecache</code>: <code>r.ShaderPipelineCache.Open</code>, along with several other console commands that control PSO:</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderPipelineCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> FAutoConsoleCommand <span class="title">LoadPipelineCacheCmd</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;r.ShaderPipelineCache.Open&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;Takes the desired filename to open and then loads the pipeline file cache.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  FConsoleCommandWithArgsDelegate::CreateStatic(ConsoleCommandLoadPipelineFileCache)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> FAutoConsoleCommand <span class="title">SavePipelineCacheCmd</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;r.ShaderPipelineCache.Save&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;Save the current pipeline file cache.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  FConsoleCommandDelegate::CreateStatic(ConsoleCommandSavePipelineFileCache)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> FAutoConsoleCommand <span class="title">ClosePipelineCacheCmd</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;r.ShaderPipelineCache.Close&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;Close the current pipeline file cache.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  FConsoleCommandDelegate::CreateStatic(ConsoleCommandClosePipelineFileCache)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> FAutoConsoleCommand <span class="title">SwitchModePipelineCacheCmd</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;r.ShaderPipelineCache.SetBatchMode&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  TEXT(<span class="string">&quot;Sets the compilation batch mode, which should be one of:\n\tPause: Suspend precompilation.\n\tBackground: Low priority precompilation.\n\tFast: High priority precompilation.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  FConsoleCommandWithArgsDelegate::CreateStatic(ConsoleCommandSwitchModePipelineCacheCmd)</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br></pre></td></tr></table></figure>

<p>This means that you only need to include the latest <code>*.stable.upipelinecache</code> in the hot update package, and then call <code>OpenPipelineFileCache</code> to load the latest PSO Cache, which can maintain consistency with the hot update process of ShaderCode.</p>
<p>Generating a new PSO Cache requires two critical types of data:</p>
<ol>
<li>Runtime-captured PSO data (upipelinecache)</li>
<li>ShaderStableInfo (located in the Metadata directory)</li>
</ol>
<p>Since ShaderCode can be hot updated, and <code>ShaderStableInfo</code> can be obtained by cooking the latest project, the PSO Cache can similarly be iteratively updated by hot updating shaders and continuously capturing the latest PSO data. I plan to add the PSO Cache hot update functionality to <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a> when I have time, thus integrating the deployment and packaging of PSO Cache into an automated hot update process, marking this down for future reference.</p>
<p>When <code>r.ShaderPipelineCache.Enabled=1</code> is set, the engine will automatically load the project’s PSO Cache upon startup, and the engine imposes a restriction that it can only be loaded once; subsequent calls to <code>OpenPipelineFileCache</code> will not be loaded:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FPipelineFileCache::OpenPipelineFileCache</span><span class="params">(FString <span class="type">const</span>&amp; Name, EShaderPlatform Platform, FGuid&amp; OutGameFileGuid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">bool</span> bOk = <span class="literal">false</span>;</span><br><span class="line">  OutGameFileGuid = <span class="built_in">FGuid</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">IsPipelineFileCacheEnabled</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">FRWScopeLock <span class="title">Lock</span><span class="params">(FileCacheLock, SLT_Write)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(FileCache == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      FileCache = <span class="keyword">new</span> <span class="built_in">FPipelineCacheFile</span>();</span><br><span class="line">      </span><br><span class="line">      bOk = FileCache-&gt;<span class="built_in">OpenPipelineFileCache</span>(Name, Platform, OutGameFileGuid);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// File Cache now exists - these caches should be empty for this file otherwise will have false positives from any previous file caching - if not something has been caching when it should not be</span></span><br><span class="line">      <span class="built_in">check</span>(NewPSOs.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line">      <span class="built_in">check</span>(NewPSOHashes.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line">      <span class="built_in">check</span>(RunTimeToPSOUsage.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> bOk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After the engine loads by default, <code>FileCache</code> will no longer be <code>nullptr</code>, so subsequent loading calls will directly return <code>false</code>. The solution is to prevent the engine from automatically loading the PSO Cache at startup and wait until runtime hot updates to load it manually. I checked the code and found that this can be detected from the <code>IsPipelineFileCacheEnabled</code> check:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FPipelineFileCache::IsPipelineFileCacheEnabled</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">bool</span> bOnce = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">bool</span> bCmdLineForce = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!bOnce)</span><br><span class="line">  &#123;</span><br><span class="line">    bOnce = <span class="literal">true</span>;</span><br><span class="line">    bCmdLineForce = FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;psocache&quot;</span>));</span><br><span class="line">    <span class="built_in">UE_CLOG</span>(bCmdLineForce, LogRHI, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;****************************** Forcing PSO cache from command line&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> FileCacheEnabled &amp;&amp; (bCmdLineForce || CVarPSOFileCacheEnabled.<span class="built_in">GetValueOnAnyThread</span>() == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Its return value depends on two values: <code>FileCacheEnabled</code> and <code>CVarPSOFileCacheEnabled</code>.</p>
<p><code>FileCacheEnabled</code> is assigned in <code>FPipelineFileCache::Initialize</code>, and is always <code>true</code> for platforms other than iOS. For iOS, it depends on the result of <code>FPipelineFileCache::ShouldEnableFileCache</code>.</p>
<p><code>CVarPSOFileCacheEnabled</code> is a console variable that controls the value of <code>r.ShaderPipelineCache.Enabled</code>:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarPSOFileCacheEnabled</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                               TEXT(<span class="string">&quot;r.ShaderPipelineCache.Enabled&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">                               PIPELINE_CACHE_DEFAULT_ENABLED,</span></span></span><br><span class="line"><span class="params"><span class="function">                               TEXT(<span class="string">&quot;1 Enables the PipelineFileCache, 0 disables it.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">                               ECVF_Default | ECVF_RenderThreadSafe</span></span></span><br><span class="line"><span class="params"><span class="function">                               )</span></span>;</span><br></pre></td></tr></table></figure>
<p>We need to follow three steps:</p>
<ol>
<li>Set the default value of <code>CVarPSOFileCacheEnabled</code> to <code>false</code> when the engine starts.</li>
<li>Manually modify the <code>CVarPSOFileCacheEnabled</code> value at runtime to enable the PSO Cache.</li>
<li>Load the PSO Cache.</li>
</ol>
<p>The specific implementation process is as follows:</p>
<ol>
<li>Set <code>r.ShaderPipelineCache.Enabled=0</code> in <code>DefaultEngine.ini</code> before packaging:</li>
</ol>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.Enabled</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>Then write two functions to enable and load PSO at runtime:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ShaderPipelineCache.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RHIShaderFormatDefinitions.inl&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;HAL/IConsoleManager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::EnableShaderPipelineCache</span><span class="params">(<span class="type">bool</span> bEnable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogHotPatcher,Display,<span class="built_in">TEXT</span>(<span class="string">&quot;EnableShaderPipelineCache %s&quot;</span>),bEnable?<span class="built_in">TEXT</span>(<span class="string">&quot;true&quot;</span>):<span class="built_in">TEXT</span>(<span class="string">&quot;false&quot;</span>));</span><br><span class="line">  <span class="keyword">auto</span> Var =  IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">FindConsoleVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;r.ShaderPipelineCache.Enabled&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span>(Var)</span><br><span class="line">  &#123;</span><br><span class="line">    Var-&gt;<span class="built_in">Set</span>( bEnable ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> !!Var;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::LoadShaderPipelineCache</span><span class="params">(<span class="type">const</span> FString&amp; Name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogHotPatcher,Display,<span class="built_in">TEXT</span>(<span class="string">&quot;Load Shader pipeline cache %s for platform %d&quot;</span>),*Name,*<span class="built_in">ShaderPlatformToShaderFormatName</span>(GMaxRHIShaderPlatform).<span class="built_in">ToString</span>());</span><br><span class="line">  <span class="keyword">return</span> FShaderPipelineCache::<span class="built_in">OpenPipelineFileCache</span>(Name,GMaxRHIShaderPlatform);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This will enable delayed loading of the PSO Cache, which can be manually loaded after a hot update.### Delayed Collection and Storage</p>
<p>Since collecting and storing PSO Cache has additional performance overhead, you can disable the collection and storage of PSO data and enable it at runtime as needed. In <code>DefaultEngine.ini</code>, disable <code>LogPSO</code> and <code>SaveBoundPSOLog</code>, so that automatic collection and storage do not occur when packaging the basic build:</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.LogPSO</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveBoundPSOLog</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>Then enable it at runtime:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">EPSOSaveMode</span> : uint8</span><br><span class="line">&#123;</span><br><span class="line">	Incremental = <span class="number">0</span>, <span class="comment">// Fast(er) approach which saves new entries incrementally at the end of the file, replacing the table-of-contents, but leaves everything else alone.</span></span><br><span class="line">	BoundPSOsOnly = <span class="number">1</span>, <span class="comment">// Slower approach which consolidates and saves all PSOs used in this run of the program, removing any entry that wasn&#x27;t seen, and sorted by the desired sort-mode.</span></span><br><span class="line">	SortedBoundPSOs = <span class="number">2</span> <span class="comment">// Slow save consolidates all PSOs used on this device that were never part of a cache file delivered in game-content, sorts entries into the desired order and will thus read-back from disk.</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::SavePipelineFileCache</span><span class="params">(EPSOSaveMode Mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FShaderPipelineCache::<span class="built_in">SavePipelineFileCache</span>((FPipelineFileCache::SaveMode)Mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::EnableLogPSO</span><span class="params">(<span class="type">bool</span> bEnable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogHotPatcher,Display,<span class="built_in">TEXT</span>(<span class="string">&quot;EnableLogPSO %s&quot;</span>),bEnable?<span class="built_in">TEXT</span>(<span class="string">&quot;true&quot;</span>):<span class="built_in">TEXT</span>(<span class="string">&quot;false&quot;</span>));</span><br><span class="line">	<span class="keyword">auto</span> Var =  IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">FindConsoleVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;r.ShaderPipelineCache.LogPSO&quot;</span>));</span><br><span class="line">	<span class="keyword">if</span>(Var)</span><br><span class="line">	&#123;</span><br><span class="line">		Var-&gt;<span class="built_in">Set</span>( bEnable ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> !!Var;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UFlibShaderPipelineCacheHelper::EnableSaveBoundPSOLog</span><span class="params">(<span class="type">bool</span> bEnable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogHotPatcher,Display,<span class="built_in">TEXT</span>(<span class="string">&quot;EnableSaveBoundPSOLog %s&quot;</span>),bEnable?<span class="built_in">TEXT</span>(<span class="string">&quot;true&quot;</span>):<span class="built_in">TEXT</span>(<span class="string">&quot;false&quot;</span>));</span><br><span class="line">	<span class="keyword">auto</span> Var =  IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">FindConsoleVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;r.ShaderPipelineCache.SaveBoundPSOLog&quot;</span>));</span><br><span class="line">	<span class="keyword">if</span>(Var)</span><br><span class="line">	&#123;</span><br><span class="line">		Var-&gt;<span class="built_in">Set</span>( bEnable ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> !!Var;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Enabling <code>SaveBoundPSOLog</code> will automatically store the collected PSO data. You can choose not to enable automatic storage and manually store it during runtime by calling <code>FShaderPipelineCache::SavePipelineFileCache</code>.</p>
<h3 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h3><h4 id="Cook-Did-Not-Generate-scl-csv"><a href="#Cook-Did-Not-Generate-scl-csv" class="headerlink" title="Cook Did Not Generate .scl.csv"></a>Cook Did Not Generate .scl.csv</h4><p>Make sure to enable <code>ShaderStableKeys</code> for the project, or the .scl.csv file will not be generated.</p>
<h4 id="No-upipelinecache-File-Generated-at-Runtime"><a href="#No-upipelinecache-File-Generated-at-Runtime" class="headerlink" title="No upipelinecache File Generated at Runtime"></a>No upipelinecache File Generated at Runtime</h4><p>Please strictly follow the steps in <a target="_blank" rel="noopener" href="https://imzlp.com/posts/24336/#%E8%BF%90%E8%A1%8C%E6%97%B6%E6%8D%95%E8%8E%B7PSO%E6%95%B0%E6%8D%AE">Runtime Capture PSO Data</a>.</p>
<ol>
<li>Confirm that <code>r.ShaderPipelineCache.Enabled</code> is enabled (in DefaultEngine.ini or DeviceProfile).</li>
<li>Add the <code>-logPSO</code> parameter in ue4commandline.txt.</li>
</ol>
<h4 id="Bad-PSO"><a href="#Bad-PSO" class="headerlink" title="Bad PSO"></a>Bad PSO</h4><p>If using the official engine, the above process is complete, but sometimes the project requires modifications to the engine to support specific rendering features, such as adding Multi-subpasshint support:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Public\PipelineFileCache.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">RHI_API</span> FPipelineCacheFileFormatPSO</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">RHI_API</span> GraphicsDescriptor</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// uint8 SubpassHint; to SubpassHint[8];</span></span><br><span class="line">    uint8 SubpassHint[<span class="number">8</span>];  </span><br><span class="line">    uint8 SubpassIndex;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>This change requires simultaneous modifications to both the <code>GraphicsDescriptor::StateToString()</code> and <code>GraphicsDescriptor::StateFromString()</code> functions to include serialization support for multi-subpasshint.</p>
<p>However, after modifying this, when using <code>-run=ShaderPipelineCacheTools</code> to generate <code>*.stablepc.csv</code>, the following log error occurs:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">LogShaderPipelineCacheTools: Expanding matched    1 files: D:\PipelineCaches\*.rec.upipelinecache</span><br><span class="line">LogShaderPipelineCacheTools:                              : D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache</span><br><span class="line">LogShaderPipelineCacheTools: Expanding matched    2 files: D:\PipelineCaches\*.scl.csv</span><br><span class="line">LogShaderPipelineCacheTools:                              : D:\PipelineCaches\ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv</span><br><span class="line">LogShaderPipelineCacheTools:                              : D:\PipelineCaches\ShaderStableInfo-PSOCaching-GLSL_ES3_1_ANDROID.scl.csv</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loading D:\PipelineCaches\ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv...</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loading D:\PipelineCaches\ShaderStableInfo-PSOCaching-GLSL_ES3_1_ANDROID.scl.csv...</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loaded 926 shader info lines from D:\PipelineCaches\ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv.</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loaded 9266 shader info lines from D:\PipelineCaches\ShaderStableInfo-PSOCaching-GLSL_ES3_1_ANDROID.scl.csv.</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loaded 10192 unique shader info lines total.</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loading D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache....</span><br><span class="line">LogShaderPipelineCacheTools: Display: Loaded 115 PSOs</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br><span class="line">LogShaderPipelineCacheTools: Warning: Bad PSO found discarding [Invertibility=FAIL Verify=PASS in: D:\PipelineCaches\++UE4+Release-4.25-CL-0-PSOCaching_GLSL_ES3_1_ANDROID_0008BF4D08D9069169A7B6820601243D.rec.upipelinecache]</span><br></pre></td></tr></table></figure>

<p>This is because the String reversibility verification for PSO data has failed:</p>
<figure class="highlight cpp"><figcaption><span>Editor\UnrealEd\Private\Commandlets\ShaderPipelineCacheToolsCommandlet.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CheckPSOStringInveribility</span><span class="params">(<span class="type">const</span> FPipelineCacheFileFormatPSO&amp; Item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">FPipelineCacheFileFormatPSO <span class="title">TempItem</span><span class="params">(Item)</span></span>;</span><br><span class="line">  TempItem.Hash = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  FString StringRep;</span><br><span class="line">  <span class="keyword">if</span> (Item.Type == FPipelineCacheFileFormatPSO::DescriptorType::Compute)</span><br><span class="line">  &#123;</span><br><span class="line">    StringRep = TempItem.ComputeDesc.<span class="built_in">ToString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    StringRep = TempItem.GraphicsDesc.<span class="built_in">ToString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  FPipelineCacheFileFormatPSO DupItem;</span><br><span class="line">  FMemory::<span class="built_in">Memzero</span>(DupItem.GraphicsDesc);</span><br><span class="line">  DupItem.Type = Item.Type;</span><br><span class="line">  DupItem.UsageMask = Item.UsageMask;</span><br><span class="line">  <span class="keyword">if</span> (Item.Type == FPipelineCacheFileFormatPSO::DescriptorType::Compute)</span><br><span class="line">  &#123;</span><br><span class="line">    DupItem.ComputeDesc.<span class="built_in">FromString</span>(StringRep);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    DupItem.GraphicsDesc.<span class="built_in">FromString</span>(StringRep);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogShaderPipelineCacheTools, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;CheckPSOStringInveribility: %s&quot;</span>), *StringRep);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (DupItem == TempItem) &amp;&amp; (<span class="built_in">GetTypeHash</span>(DupItem) == <span class="built_in">GetTypeHash</span>(TempItem));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The key part is in the line <code>DupItem.GraphicsDesc.FromString(StringRep);</code> where the data for <code>GraphicsDesc</code> failed to restore successfully.</p>
<p>After debugging, it was found that the engine records the number of parseable elements in the string for Pipeline Cache Graphics Descriptor, which is the number of entries in the second column of the generated <code>*.stablepc.csv</code>. The official engine defaults to 63, recorded by <code>FPipelineCacheGraphicsDescPartsNum</code>:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> int32  FPipelineCacheGraphicsDescPartsNum = <span class="number">63</span>; <span class="comment">// parser will expect this number of parts in a description string</span></span><br></pre></td></tr></table></figure>
<p>The status and data of each item in the generated <code>*.stablepc.csv</code> are as follows:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210424_114130.webp"></p>
<p>It consists of exactly 63 entries. Please note that in <code>GraphicsDescriptor::StateFromString</code>, there is a check for the expected number of parts, and the data passed to <code>FromString</code> must match the value of <code>FPipelineCacheGraphicsDescPartsNum</code>:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RHI\Private\PipelineFileCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> FPipelineCacheFileFormatPSO::GraphicsDescriptor::<span class="built_in">StateFromString</span>(<span class="type">const</span> FStringView&amp; Src)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">constexpr</span> int32 PartCount = FPipelineCacheGraphicsDescPartsNum;</span><br><span class="line"></span><br><span class="line">  TArray&lt;FStringView, TInlineAllocator&lt;PartCount&gt;&gt; Parts;</span><br><span class="line">  UE::String::<span class="built_in">ParseTokens</span>(Src.<span class="built_in">TrimStartAndEnd</span>(), <span class="built_in">TEXT</span>(<span class="string">&#x27;,&#x27;</span>), [&amp;Parts](FStringView Part) &#123; Parts.<span class="built_in">Add</span>(Part); &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check if we have expected number of parts</span></span><br><span class="line">  <span class="keyword">if</span> (Parts.<span class="built_in">Num</span>() != PartCount)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// instead of crashing let caller handle this case</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/24336/20210424115803.webp"></p>
<p>Because we added multi-subpasshint support, we modified <code>SubpassHint</code> from <code>uint8</code> to <code>uint8[8]</code>, adding 7 more data points, so the corresponding <code>FPipelineCacheGraphicsDescPartsNum</code> must also be increased by 7 to become 70, otherwise the <code>StateFromString</code> verification will fail.</p>
<p>After modifying this, regenerating <code>*.stablepc.csv</code> using <code>-run=ShaderPipelineCacheTools</code> no longer results in the <code>Bad PSO</code> error.</p>
<h3 id="Usage-and-Configuration"><a href="#Usage-and-Configuration" class="headerlink" title="Usage and Configuration"></a>Usage and Configuration</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/SharingAndReleasing/PSOCaching/CompilingUsingPSOCachingData/index.html">Compiling &amp; Using PSO Cache Data</a></li>
</ul>
<p>You can control the construction of PSO data at runtime through the functions of <code>FShaderPipelineCache</code>:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RenderCore\Public\ShaderPipelineCache.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Pauses precompilation. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">PauseBatching</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/** Resumes precompilation batching. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">ResumeBatching</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/** Returns the number of pipelines waiting for precompilation. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> uint32 <span class="title">NumPrecompilesRemaining</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/** Returns the number of pipelines actively being precompiled this frame. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> uint32 <span class="title">NumPrecompilesActive</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/** Sets the precompilation batching mode. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">SetBatchMode</span><span class="params">(BatchMode Mode)</span></span>;</span><br></pre></td></tr></table></figure>
<p>The official recommendation is to wait for the PSO to finish building before hiding the LoadingScreen during the loading screen:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(FShaderPipelineCache::<span class="built_in">NumPrecompilesRemaining</span>() &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (OutDebugReason != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *OutDebugReason = <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;PC: PSO cache still compiling&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can also build during the opening of the UI, cutscenes, or pause menus by handling it through the following three function combinations:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pause PSO cache compilation</span></span><br><span class="line">FShaderPipelineCache::<span class="built_in">PauseBatching</span>();</span><br><span class="line"><span class="comment">// Set the processing mode for PSO</span></span><br><span class="line"><span class="comment">// enum class BatchMode</span></span><br><span class="line"><span class="comment">// &#123; </span></span><br><span class="line"><span class="comment">//   Background, // The maximum batch size is defined by r.ShaderPipelineCache.BackgroundBatchSize</span></span><br><span class="line"><span class="comment">//   Fast, // The maximum batch size is defined by r.ShaderPipelineCache.BatchSize</span></span><br><span class="line"><span class="comment">//   Precompile // The maximum batch size is defined by r.ShaderPipelineCache.PrecompileBatchSize</span></span><br><span class="line"><span class="comment">// &#125;;</span></span><br><span class="line">FShaderPipelineCache::<span class="built_in">SetBatchMode</span>(FShaderPipelineCache::BatchMode::Background);</span><br><span class="line"><span class="comment">// Resume compiling PSO</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">ResumeBatching</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>There are multiple CVars in the engine to control PSO capturing, loading, etc. For detailed information, refer to: <a target="_blank" rel="noopener" href="https://consolehelp.imzlp.com/">UE Console Variables and Command</a>, search for <code>r.shaderpipelinecache</code> to see all supported CVars.</p>
</blockquote>
<p>You can also use configurations to automatically build when the game starts by modifying the <code>[ConsoleVariables]</code> configuration in <code>DefaultEngine.ini</code>. They are defined in <code>Runtime\RenderCore\Private\ShaderPipelineCache.cpp</code> within <code>ConsoleVariable</code>, which can be adjusted at runtime or in configuration files as needed:</p>
<div class="tabs" id="menu-items"><ul class="nav-tabs"><li class="tab active"><a href="#menu-items-1"><code>Default PSO Engine Configurations</code></a></li><li class="tab"><a href="#menu-items-2"><code>My Modified Configurations</code></a></li></ul><div class="tab-content"><div class="tab-pane active" id="menu-items-1"><figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="comment">;Sets the startup mode for the PSO cache, determining what the cache does after initialisation:</span></span><br><span class="line"><span class="comment">;0: Precompilation is paused and nothing will compile until a call to ResumeBatching().</span></span><br><span class="line"><span class="comment">;1: Precompilation is enabled in the &#x27;Fast&#x27; mode.</span></span><br><span class="line"><span class="comment">;2: Precompilation is enabled in the &#x27;Background&#x27; mode.</span></span><br><span class="line"><span class="comment">;Default is 1.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.StartupMode</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when compiling takes priority. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchSize</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when pre-optimizing the cache. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchSize</span>=<span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when in the background or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 0.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchTime</span>=<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when compiling takes priority or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 16.0 (max. ms per-frame of precompilation).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BatchTime</span>=<span class="number">16.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when pre-optimizing or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 10.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchTime</span>=<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to log before automatically saving. 0 will disable automatic saving. Shipping defaults to 0, otherwise default is 100.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveAfterPSOsLogged</span>=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTime</span>=<span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Mask used to precompile the cache. Defaults to all PSOs (-1)</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreCompileMask</span>=-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved when -logpso is on the command line.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTimeBoundPSO</span>=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;If &gt; 0 then a log of all bound PSOs for this run of the program will be saved to a writable user cache file. Defaults to 0 but is forced on with -logpso.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveBoundPSOLog</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to use GameFileMask during PSO precompile - recording should always save out the usage masks to make that data availble when needed.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.GameFileMaskEnabled</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to PreOptimize PSOs - this allows some PSOs to be compiled in the foreground before going in to game</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreOptimizeEnabled</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The minimum bind count to allow a PSO to be precompiled.  Changes to this value will not affect PSOs that have already been removed from consideration.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MinBindCount</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The maximum time to allow a PSO to be precompiled.  if greather than 0, the amount of wall time we will allow pre-compile of PSOs and then switch to background processing.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MaxPrecompileTime</span>=<span class="number">0.0</span></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="menu-items-2"><figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="comment">;Sets the startup mode for the PSO cache, determining what the cache does after initialisation:</span></span><br><span class="line"><span class="comment">;0: Precompilation is paused and nothing will compile until a call to ResumeBatching().</span></span><br><span class="line"><span class="comment">;1: Precompilation is enabled in the &#x27;Fast&#x27; mode.</span></span><br><span class="line"><span class="comment">;2: Precompilation is enabled in the &#x27;Background&#x27; mode.</span></span><br><span class="line"><span class="comment">;Default is 1.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.StartupMode</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when compiling takes priority. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BatchSize</span>=<span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when compiling takes priority or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 16.0 (max. ms per-frame of precompilation).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BatchTime</span>=<span class="number">16.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when compiling takes priority. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchSize</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when pre-optimizing the cache. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchSize</span>=<span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when in the background or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 0.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchTime</span>=<span class="number">11.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when cpre-optimizing or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 10.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchTime</span>=<span class="number">10.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to log before automatically saving. 0 will disable automatic saving. Shipping defaults to 0, otherwise default is 100.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveAfterPSOsLogged</span>=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTime</span>=<span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Mask used to precompile the cache. Defaults to all PSOs (-1)</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreCompileMask</span>=-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved when -logpso is on the command line.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTimeBoundPSO</span>=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to use GameFileMask during PSO precompile - recording should always save out the usage masks to make that data availble when needed.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.GameFileMaskEnabled</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to PreOptimize PSOs - this allows some PSOs to be compiled in the foreground before going in to game</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreOptimizeEnabled</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The minimum bind count to allow a PSO to be precompiled.  Changes to this value will not affect PSOs that have already been removed from consideration.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MinBindCount</span>=<span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The maximum time to allow a PSO to be precompiled.  if greather than 0, the amount of wall time we will allow pre-compile of PSOs and then switch to background processing.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MaxPrecompileTime</span>=<span class="number">33</span></span><br></pre></td></tr></table></figure></div></div></div>

<p>Enabling automatic PSO data construction at startup will generate the following log:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LogRHI: Base name for record PSOs is ../../../FGame/Saved/CollectedPSOs/++UE4+Release-4.25-CL-0-FGame_SF_METAL_8F3222B7964FE2A89C849E90E0000736.rec.upipelinecache</span><br><span class="line">LogRHI: FPipelineCacheFile Header Game Version: 0</span><br><span class="line">LogRHI: FPipelineCacheFile Header Engine Data Version: 17</span><br><span class="line">LogRHI: FPipelineCacheFile Header TOC Offset: 293853</span><br><span class="line">LogRHI: FPipelineCacheFile File Size: 380497 Bytes</span><br><span class="line">LogRHI: Opened FPipelineCacheFile: ../../../FGame/Content/PipelineCaches/IOS/FGame_SF_METAL.stable.upipelinecache (GUID: 00000000000000000000000000000000) with 690 entries.</span><br><span class="line">LogRHI: Display: Opened pipeline cache and enqueued 441 of 441 tasks for precompile with BatchSize 50 and BatchTime 10.000000.</span><br></pre></td></tr></table></figure>

<p>You can also set the PSO’s <code>SortOrder</code> in <code>DefaultGameUserSettings.ini</code>:</p>
<pre><code class="ini">[ShaderPipelineCache.CacheFile]
;default is 0
;Default = 0, // Whatever order they are already in.
;FirstToLatestUsed = 1, // Start with the PSOs with the lowest first-frame used and work toward those with the highest.
;MostToLeastUsed = 2 // Start with the most often used PSOs working toward the least.
SortOrder=1
```### Profiling
You can use Unreal Insights to view the time taken for shader linking:
![](https://img.imzlp.com/imgs/zlp/picgo/2023/20230524160612.png)

And by using `stat pipelinestatecache`, you can check the loading and generation status of PSOs.

### Notes

#### ShaderLibrary Requirements
Using PSOs requires changing the shader serialization method to share shader library; if it is in inline shader form, Pre-Compiled PSOs cannot be used. Runtime collection is possible, but it cannot be utilized in the next package build.

#### scl.csv to shk
&gt; In 4.27, StableExtension has been changed from `scl.csv` to `shk`. [ShaderCodeLibrary.cpp#L65](https://github.com/EpicGames/UnrealEngine/blob/4.27/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L65)

![](https://img.imzlp.com/imgs/zlp/picgo/2023/20230525192513.png)



### References

- [PSO Cache](https://docs.unrealengine.com/en-US/SharingAndReleasing/PSOCaching/index.html).
- [Unreal Engine 4: PSO Cache (Pipeline State Object) to Reduce Load Times/Hitches](https://www.youtube.com/watch?v=0tzrsEm6V9Q&amp;ab_channel=StephenMaloney)
- [Introduction to UE4 Rendering Engine Modules (2)](https://zhuanlan.zhihu.com/p/72768828)
</code></pre>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                The article is finished. If you have any questions, please comment and communicate.
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/24336/" target="_blank">UE project optimization: PSO Cache</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2021/04/22 19:40<br/>
             
             <span>Word Count:</span><span class="page-count">12k Words</span><br/>
             
             <span>Link:</span><a href="/posts/24336/" target="_blank" title="UE project optimization: PSO Cache">https://en.imzlp.com/posts/24336/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/24336/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/PSOCache/" rel="tag"># PSOCache</a>
              <a href="/tags/PSO/" rel="tag"># PSO</a>
              <a href="/tags/%E4%BC%98%E5%8C%96/" rel="tag"># 优化</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/8724/" rel="prev" title="A first look at the next generation of UE5">
      <i class="fa fa-chevron-left"></i> A first look at the next generation of UE5
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/17996/" rel="next" title="UE Development Notes: Android">
      UE Development Notes: Android <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Enable-Shader-Stable-Keys"><span class="nav-number">1.</span> <span class="nav-text">Enable Shader Stable Keys</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Runtime-Capture-of-PSO-Data"><span class="nav-number">2.</span> <span class="nav-text">Runtime Capture of PSO Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Generate-stablepc-csv"><span class="nav-number">3.</span> <span class="nav-text">Generate *.stablepc.csv</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Generate-stable-upipelinecache"><span class="nav-number">4.</span> <span class="nav-text">Generate *.stable.upipelinecache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Loading-and-Hot-Updating-PSO-Cache"><span class="nav-number">5.</span> <span class="nav-text">Loading and Hot Updating PSO Cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Error-Handling"><span class="nav-number">6.</span> <span class="nav-text">Error Handling</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Cook-Did-Not-Generate-scl-csv"><span class="nav-number">6.1.</span> <span class="nav-text">Cook Did Not Generate .scl.csv</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#No-upipelinecache-File-Generated-at-Runtime"><span class="nav-number">6.2.</span> <span class="nav-text">No upipelinecache File Generated at Runtime</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bad-PSO"><span class="nav-number">6.3.</span> <span class="nav-text">Bad PSO</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Usage-and-Configuration"><span class="nav-number">7.</span> <span class="nav-text">Usage and Configuration</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/24336/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
