<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="A series of articles has been introduced regarding the engineering practices of hot updates in UE, capable of achieving version comparison and differential updates based on resources from the original">
<meta property="og:type" content="article">
<meta property="og:title" content="UE Hot Update: binary patch solution for resources">
<meta property="og:url" content="https://en.imzlp.com/posts/25136/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="A series of articles has been introduced regarding the engineering practices of hot updates in UE, capable of achieving version comparison and differential updates based on resources from the original">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2022/202302051826294.webp">
<meta property="article:published_time" content="2021-09-06T16:27:10.000Z">
<meta property="article:modified_time" content="2021-09-06T16:27:10.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="热更新">
<meta property="article:tag" content="HotPatcher">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2022/202302051826294.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/25136/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>UE Hot Update: binary patch solution for resources | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/25136/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          UE Hot Update: binary patch solution for resources<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2021-09-06-25136.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/25136/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        
          <div class="post-subtitle" style="text-align: center;line-height: 1;">
            <sub text-align="center" style="font-size: 15px;align-content: center;font-style: italic;bottom: 0em;">UE热更新：资源的二进制补丁方案</sub>
          </div>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-06 16:27 16:27:10:27" itemprop="dateCreated datePublished" datetime="2021-09-06T16:27:10+00:00">2021-09-06 16:27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/" itemprop="url" rel="index"><span itemprop="name">UnrealEngine</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/%E7%83%AD%E6%9B%B4%E6%96%B0/" itemprop="url" rel="index"><span itemprop="name">热更新</span></a>
                </span>
            </span>

          
            <span id="/posts/25136/" class="post-meta-item leancloud_visitors" data-flag-title="UE Hot Update: binary patch solution for resources" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>A series of articles has been introduced regarding the engineering practices of hot updates in UE, capable of achieving version comparison and differential updates based on resources from the original project. However, by default, resource updates depend on file updates; if a resource changes, the entire file must be repackaged. In UE, resource changes after Cook do not cause the entire file to be updated; only certain bytes are modified during serialization. In this case, a file-based patch mechanism can significantly reduce the size of the patch. This article outlines the generation and loading scheme of binary patches based on <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>, allowing for easy generation of binary patches.</p>
<p>To fulfill this requirement, I have ported HDiffPatch to UE and used it as the default DIFF/PATCH algorithm for binary differential patches in <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>; it can also easily extend other algorithms based on the Modular Feature approach.</p>
<span id="more"></span>

<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>The implementation of binary differential patches based on resources has already been widely applied in some games, such as League of Legends, which has implemented a binary patching scheme in its update mechanism. Some implementation schemes are based on the differences of complete packages, which is unsuitable for UE since the resources packaged by UE are in Pak format. The arrangement order of resources during Pak packaging is not fixed, and cannot guarantee the same arrangement, making direct comparisons of Pak unreasonable, yielding poor performance. Therefore, my scheme is to perform DIFF on the Cooked files of the resources before they are packaged into Pak, then pack the differential results into Pak.</p>
<p>In UE, the modified files that ultimately update to the player’s device as uasset are all files after they are Cooked. The following image serves as an example:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210906111908.webp"></p>
<p>The comparison of the same resource before and after modification after cooking shows that the Cooked file only changed some data, while most of the data remained consistent. In this situation, updating the entire file seems wasteful, and the benefits of binary patches are significant.</p>
<p>Thus, the objectives are:</p>
<ol>
<li>Generate binary patches based on the Cooked results of UAsset during packaging.</li>
<li>Replace the original Cooked resource file with the patch file.</li>
<li>Apply the patch when loading resources.</li>
</ol>
<p>To meet these three needs, it is necessary to intervene in the packaging process and modify the engine code.</p>
<h3 id="Binary-Patches-of-Resources"><a href="#Binary-Patches-of-Resources" class="headerlink" title="Binary Patches of Resources"></a>Binary Patches of Resources</h3><p>The uasset packaged by UE is a Cooked file, which can be read after the game is packaged. To implement binary DIFF/PATCH for uasset, it is necessary to obtain the Cooked files in the base package and the latest Cooked files for comparison.</p>
<p>Thanks to the mechanism of <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>, it is very convenient to acquire the current patch’s uasset information, unpack the files in the Patch list from the base package’s Pak, and perform DIFF with the latest Cooked files.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20210906143200850.webp"></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20210906145329200.webp"></p>
<p>Therefore, the steps and processes of performing DIFF on the entire resource are:</p>
<ol>
<li>Retrieve the list of resources in the current patch.</li>
<li>Cook the resources in the patch.</li>
<li>Unpack the resources from the base package’s Pak currently listed in the patch.</li>
<li>Use HDiffPatch to create a new binary patch between the new and old resources.</li>
<li>Remove the original Cooked file from the Patch information and use <code>patch</code> as a substitute.</li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210906142450.webp"></p>
<p>This mechanism has been provided in the <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a> plugin, and can be enabled in the <code>Binaries Patch</code> section of the <code>Patch</code> configuration page.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210906143450.webp"></p>
<p>You can specify the Pak of the base package for a certain platform and the decryption key, as well as perform some filter operations, supporting file rule matching (size, type), etc. The size of the patches is still quite considerable:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210906144159.webp"></p>
<h3 id="Binary-DIFF-PATCH-Algorithm"><a href="#Binary-DIFF-PATCH-Algorithm" class="headerlink" title="Binary DIFF/PATCH Algorithm"></a>Binary DIFF/PATCH Algorithm</h3><blockquote>
<p>I have ported HDiffPatch to UE in the form of a plugin that can be downloaded from GitHub: <a target="_blank" rel="noopener" href="https://github.com/hxhb/HDiffPatchUE">hxhb/HDiffPatchUE</a>. Together with HotPatcher, it can be used in the same project for patching.</p>
</blockquote>
<p>For binary DIFF/PATCH algorithms, I have currently chosen <a target="_blank" rel="noopener" href="https://github.com/sisong/HDiffPatch">HDiffPatch</a>, which has performance advantages over BsDiff:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20210906142257789.webp"></p>
<p>I have ported the HDiffPatch code into a UE module and made some corrections for cross-platform issues. Once HotPatcher is launched, you can choose it in <code>Binaries Patch</code> - <code>Binaries Patch Type</code>.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210906144900.webp"></p>
<p>I have encapsulated its code into two functions for convenient DIFF/PATCH operations.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">CreateCompressedDiff</span><span class="params">(<span class="type">const</span> TArray&lt;uint8&gt;&amp; NewData, <span class="type">const</span> TArray&lt;uint8&gt;&amp; OldData, TArray&lt;uint8&gt;&amp; OutPatch)</span></span>;</span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">PatchCompressedDiff</span><span class="params">(<span class="type">const</span> TArray&lt;uint8&gt;&amp; OldData, <span class="type">const</span> TArray&lt;uint8&gt;&amp; PatchData, TArray&lt;uint8&gt;&amp; OutNewData)</span></span>;</span><br></pre></td></tr></table></figure>

<p>Of course, as mentioned before, if you do not want to use HDiffPatch as the algorithm for creating binaries, you can implement other algorithms by injecting them. Since it is based on a Modular Feature implementation, it can be integrated non-intrusively, just by adding a module that implements the following interface and registering it into the <code>BINARIES_DIFF_PATCH_FEATURE_NAME</code> Modular Features in <code>StartupModule</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">IBinariesDiffPatchFeature</span>: <span class="keyword">public</span> IModularFeature</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">IBinariesDiffPatchFeature</span>()&#123;&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">CreateDiff</span><span class="params">(<span class="type">const</span> TArray&lt;uint8&gt;&amp; NewData, <span class="type">const</span> TArray&lt;uint8&gt;&amp; OldData, TArray&lt;uint8&gt;&amp; OutPatch)</span> </span>= <span class="number">0</span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">PatchDiff</span><span class="params">(<span class="type">const</span> TArray&lt;uint8&gt;&amp; OldData, <span class="type">const</span> TArray&lt;uint8&gt;&amp; PatchData, TArray&lt;uint8&gt;&amp; OutNewData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FString <span class="title">GetFeatureName</span><span class="params">()</span><span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Runtime-PATCH"><a href="#Runtime-PATCH" class="headerlink" title="Runtime PATCH"></a>Runtime PATCH</h3><blockquote>
<p>Note: The implementation of the PakFile module has not supported PakCache, so it needs to be disabled.</p>
</blockquote>
<p>After completing the previous steps, the binary patches have been generated and packaged into Pak files.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210906161543.webp"></p>
<p>For resources created with binary patches, they also need to be accessed via patches during runtime. This section provides an implementation idea, but it is not a complete solution. This part involves too much content and requires engine modifications. I provide a rough practical solution aimed at verifying the feasibility of binary patches. A lot of optimization is still needed according to project requirements.</p>
<p>When UE loads files from Pak, it sorts them according to PakOrder, which is also the foundation for UE’s hot update implementation. The reading of files from Pak is implemented in <code>IPlatformPakFile.cpp</code>, which is located in the UE’s <code>PakFile</code> module.<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20210906153945329.webp"></p>
<p>The original Pak loading process:</p>
<ol>
<li>Read File A.</li>
<li>Read the original Cooked file of A from Pak.</li>
<li>Return the file handle.</li>
</ol>
<p>However, after creating a patch, the Pak does not contain the original Cooked file, so it is necessary to execute the patch operation on the basis of the old resource to restore the latest file:</p>
<ol>
<li>Read File A.</li>
<li><strong>Read the old A file + A’s patch file from Pak.</strong></li>
<li><strong>Perform runtime patching to restore the source file.</strong></li>
<li>Return the source file handle.</li>
</ol>
<p>The patching operation is usually part of the <code>Pre Patch</code> process; while it can be done in memory during runtime, it incurs significant performance costs. Therefore, prior to entering the game, during the hot update process, all downloaded resources can be patched so that, during runtime, the only difference is whether the data is read from Pak or from disk.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210906161224.webp"></p>
<p>To implement this process, the UE’s <code>PakFile</code> module needs to be modified. However, it is recommended not to directly modify the PakFile module but to create a class that inherits from <code>FPakPlatformFile</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PATCHPAKFILE_API</span> FPatchPakPlatformFile: <span class="keyword">public</span> FPakPlatformFile</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> IFileHandle* <span class="title">OpenRead</span><span class="params">(<span class="type">const</span> TCHAR* Filename, <span class="type">bool</span> bAllowWrite = <span class="literal">false</span>)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> IAsyncReadFileHandle* <span class="title">OpenAsyncRead</span><span class="params">(<span class="type">const</span> TCHAR* Filename)</span><span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">const</span> TCHAR* <span class="title">GetName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">TEXT</span>(<span class="string">&quot;PatchPakFile&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Reading files from Pak is achieved by calling the <code>OpenRead</code> and <code>OpenAsyncRead</code> interfaces, where the above process can be implemented.</p>
<p>The core pseudocode for the main flow is as follows:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IFileHandle* <span class="title">FPatchPakPlatformFile::OpenRead</span><span class="params">(<span class="type">const</span> TCHAR* Filename, <span class="type">bool</span> bAllowWrite)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IFileHandle* Handle = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">HasPatch</span>(Filename))</span><br><span class="line">	&#123;</span><br><span class="line">		Handle = <span class="built_in">GetLowerLevel</span>()-&gt;<span class="built_in">OpenRead</span>(<span class="built_in">GetPatchedAssetPath</span>(Filename),bAllowWrite);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> !Handle ? FPakPlatformFile::<span class="built_in">OpenRead</span>(Filename, bAllowWrite) : Handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The asynchronous process follows the same idea.</p>
<p>Once <code>FPatchPakPlatformFile</code> is implemented, it can be placed into the engine’s runtime. The engine’s code needs to be modified to replace the <code>PakFile</code> module with <code>PatchPakFile</code> so that our code can take effect.</p>
<p>Modify the <code>Launch</code> module’s <code>LaunchEngineLoop.cpp</code> file in the <code>LaunchCheckForFileOverride</code> function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// From</span></span><br><span class="line">IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;PakFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line"><span class="comment">// To</span></span><br><span class="line">IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;PatchPakFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br></pre></td></tr></table></figure>

<p>This will allow the implemented reading process to be utilized when reading files from Pak, achieving patching behavior.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>This article introduces a scheme for creating binary resource patches in UE, implementing binary resource patches based on HDiffPatch on the foundation of <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>, and validating their feasibility through real-time or pre-patch methods. Further optimizations are needed for practical projects since the restored files are the original Cooked files and have not undergone encryption, raising resource security issues that also need to be addressed. If time permits, I will add more details on enhancing patch performance, encrypted resources, and other implementations.</p>
<p>To facilitate testing, I provide a ThirdPerson demo, which can be downloaded via the link: <a target="_blank" rel="noopener" href="https://stusdnueducn-my.sharepoint.com/:u:/g/personal/2017020625_stu_sdnu_edu_cn/EUAydgBo401Jv750Q1wsQ44BjwSKSnT08xQPd0Ec0u89jQ?e=cQY160">CompressionLab_WindowsNoEditor.7z</a>.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210906162626.webp"></p>
<p>The two files in the red box, one has gone through BinariesPatch and the other is the original Cooked file, can perform the same function and can be placed in <code>CompressionLab/Content/Paks</code> for testing.</p>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                The article is finished. If you have any questions, please comment and communicate.
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/25136/" target="_blank">UE Hot Update: binary patch solution for resources</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2021/09/06 16:27<br/>
             
             <span>Word Count:</span><span class="page-count">6.9k Words</span><br/>
             
             <span>Link:</span><a href="/posts/25136/" target="_blank" title="UE Hot Update: binary patch solution for resources">https://en.imzlp.com/posts/25136/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/25136/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/" rel="tag"># 热更新</a>
              <a href="/tags/HotPatcher/" rel="tag"># HotPatcher</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/15810/" rel="prev" title="UE Hot Update: Shader update strategy">
      <i class="fa fa-chevron-left"></i> UE Hot Update: Shader update strategy
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/26475/" rel="next" title="UE as Lib">
      UE as Lib <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Binary-Patches-of-Resources"><span class="nav-number">2.</span> <span class="nav-text">Binary Patches of Resources</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Binary-DIFF-PATCH-Algorithm"><span class="nav-number">3.</span> <span class="nav-text">Binary DIFF&#x2F;PATCH Algorithm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Runtime-PATCH"><span class="nav-number">4.</span> <span class="nav-text">Runtime PATCH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conclusion"><span class="nav-number">5.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/25136/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
