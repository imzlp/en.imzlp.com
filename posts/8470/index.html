<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="UE uses Zlib by default as the compression algorithm for packaging resources, but it is not the best choice in terms of compression ratio and decompression speed. The efficiency comparison of various">
<meta property="og:type" content="article">
<meta property="og:title" content="Integrate ZSTD compression algorithm for UE4 using ModularFeature">
<meta property="og:url" content="https://en.imzlp.com/posts/8470/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="UE uses Zlib by default as the compression algorithm for packaging resources, but it is not the best choice in terms of compression ratio and decompression speed. The efficiency comparison of various">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/20230323190907.webp">
<meta property="article:published_time" content="2020-04-20T21:52:56.000Z">
<meta property="article:modified_time" content="2020-04-20T21:52:56.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="插件开发">
<meta property="article:tag" content="ZSTD">
<meta property="article:tag" content="压缩算法">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/20230323190907.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/8470/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Integrate ZSTD compression algorithm for UE4 using ModularFeature | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/8470/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Integrate ZSTD compression algorithm for UE4 using ModularFeature<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2020-04-19-8470.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/8470/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        
          <div class="post-subtitle" style="text-align: center;line-height: 1;">
            <sub text-align="center" style="font-size: 15px;align-content: center;font-style: italic;bottom: 0em;">ModularFeature：为UE4集成ZSTD压缩算法</sub>
          </div>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-20 21:52 21:52:56:52" itemprop="dateCreated datePublished" datetime="2020-04-20T21:52:56+00:00">2020-04-20 21:52</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/" itemprop="url" rel="index"><span itemprop="name">UnrealEngine</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">插件开发</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">压缩算法</span></a>
                </span>
            </span>

          
            <span id="/posts/8470/" class="post-meta-item leancloud_visitors" data-flag-title="Integrate ZSTD compression algorithm for UE4 using ModularFeature" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>25 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>UE uses <code>Zlib</code> by default as the compression algorithm for packaging resources, but it is not the best choice in terms of compression ratio and decompression speed. The efficiency comparison of various compression algorithms can be seen from the <a target="_blank" rel="noopener" href="https://quixdb.github.io/squash-benchmark/">Squash Compression Benchmark</a>. I chose the Facebook open-source <a target="_blank" rel="noopener" href="https://facebook.github.io/zstd/">ZStandard</a> to replace Zlib, as ZSTD provides a good compression ratio while also having decent decompression speed. This article will not only explain how to integrate a compression algorithm into UE but will also briefly introduce a modular organization method for some features in UE—<code>ModularFeature</code>. Using this method makes it easy to replace certain functionalities, and the replacement compression algorithm in this article serves as a practical example.</p>
<p>I integrated <a target="_blank" rel="noopener" href="https://facebook.github.io/zstd/">ZSTD</a> into UE by writing a plugin. The source code is available on GitHub: <a target="_blank" rel="noopener" href="https://github.com/hxhb/ue-zstd">hxhb/ue-zstd</a>, which supports Android, Windows, iOS, and macOS. Feel free to give it a star.</p>
<span id="more"></span>

<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In fact, the compression ratio of <a target="_blank" rel="noopener" href="https://facebook.github.io/zstd/">ZStandard</a> is similar to that of zlib when considering compression speed (ZSTD’s compression level is around <code>10</code>), but ZSTD decompresses faster. ZSTD’s compression levels range from <code>1 to 22</code>, with the default set to <code>3</code>. In the plugin I developed, the default level is set to <code>10</code>, which can be specified by using the <code>-zstdlevel=</code> parameter when starting the engine (if you compiled UnrealPak, you can also specify the <code>-zstdlevel=</code> parameter in the project settings under <code>Pacakge</code> - <code>PakFileCompressionCommandlineOptions</code>).</p>
<h2 id="ModularFeature"><a href="#ModularFeature" class="headerlink" title="ModularFeature"></a>ModularFeature</h2><p>All ModularFeature implementations in UE must inherit from <code>IModularFeature</code>. It has no members and serves simply as a generic type. The organization of <code>ModularFeature</code> is managed by the <code>IModularFeatures</code> class (with the default implementation being <code>FModularFeatures</code>). This class provides methods to register, unregister, and retrieve instances of <code>IModularFeature</code> by name. Its core functionality is to associate a Name with a set of implementations. For example, all compression algorithms in UE fall under the <code>COMPRESSION_FORMAT_FEATURE_NAME</code>, which corresponds to an array where each element is an implementation of a compression algorithm; this allows us to specify which compression algorithm to use based on our requirements.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Private/Features/ModularFeatures.cpp</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FModularFeatures::RegisterModularFeature</span><span class="params">( <span class="type">const</span> FName Type, IModularFeature* ModularFeature )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ModularFeaturesMap.<span class="built_in">AddUnique</span>( Type, ModularFeature );</span><br><span class="line">  ModularFeatureRegisteredEvent.<span class="built_in">Broadcast</span>( Type, ModularFeature );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As seen above, registering a <code>ModularFeature</code> simply involves adding an element to a Map. Note that <code>ModularFeaturesMap</code> is not a regular <code>TMap</code>; it is a <code>TMiltiMap</code>, allowing a key to correspond to multiple values. It is a static data member of <code>FCompression</code>.</p>
<p>The specific process is:</p>
<ol>
<li>Register the <code>ModularFeature</code> we created with <code>IModularFeatures</code> during the loading of UE’s Module;</li>
<li>When using the feature, we can search for all implementations of a certain <code>ModularFeature</code> based on the name of our <code>ModularFeature</code> category;</li>
<li>We can then call the implemented functionalities of <code>ModularFeature</code> through our own defined interfaces.</li>
</ol>
<p>Note that <code>IModularFeatures::GetModularFeature</code> is implemented using templates, allowing for direct retrieval of the specific type of a given Feature category.</p>
<h2 id="Specifying-Compression-Algorithms"><a href="#Specifying-Compression-Algorithms" class="headerlink" title="Specifying Compression Algorithms"></a>Specifying Compression Algorithms</h2><p>First, let’s take a look at how to replace the compression algorithm used during packaging in UE:</p>
<p>Open <code>Project Settings</code> and find <code>Packing</code> - <code>Pak File Compression Format(s)</code>:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/8470/ue-pak-file-compression-formats.webp"><br>It is an FString type where you can enter a string separated by commas. If multiple formats are specified, they will be prioritized in order, falling back to other formats in case of errors or unavailability (such as plugins not being enabled).</p>
<p>This string is passed to the <code>UnrealPak</code> as the <code>-compressionformats=</code> parameter.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Programs/AutomationTool/Scripts/CopyBuildToStagingDirectory.Automation.cs</span></span><br><span class="line"><span class="built_in">string</span> CompressionFormats = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (PlatformGameConfig.GetString(<span class="string">&quot;/Script/UnrealEd.ProjectPackagingSettings&quot;</span>, <span class="string">&quot;PakFileCompressionFormats&quot;</span>, <span class="keyword">out</span> CompressionFormats))</span><br><span class="line">&#123;</span><br><span class="line">  CompressionFormats = <span class="string">&quot; -compressionformats=&quot;</span> + CompressionFormats;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the <code>PakFileUtilities</code> module, the default compression algorithm is <code>ZLib</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Developer/PakFileUtilities/Private/PakFileUtilities.cpp</span></span><br><span class="line">FString DesiredCompressionFormats;</span><br><span class="line"><span class="comment">// look for -compressionformats or -compressionformat on the commandline</span></span><br><span class="line"><span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-compressionformats=&quot;</span>), DesiredCompressionFormats) || FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-compressionformat=&quot;</span>), DesiredCompressionFormats))</span><br><span class="line">&#123;</span><br><span class="line">  TArray&lt;FString&gt; Formats;</span><br><span class="line">  DesiredCompressionFormats.<span class="built_in">ParseIntoArray</span>(Formats, <span class="built_in">TEXT</span>(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">  <span class="keyword">for</span> (FString&amp; Format : Formats)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// look until we have a valid format</span></span><br><span class="line">    FName FormatName = *Format;</span><br><span class="line">    <span class="keyword">if</span> (FCompression::<span class="built_in">IsFormatValid</span>(FormatName))</span><br><span class="line">    &#123;</span><br><span class="line">      CmdLineParameters.CompressionFormats.<span class="built_in">Add</span>(FormatName);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// make sure we can always fallback to zlib, which is guaranteed to exist</span></span><br><span class="line">CmdLineParameters.CompressionFormats.<span class="built_in">AddUnique</span>(NAME_Zlib);</span><br></pre></td></tr></table></figure>

<p>If a different algorithm is specified, the actual compression algorithm will be retrieved via <code>ICompressionFormat* FCompression::GetCompressionFormat(FName FormatName, bool bErrorOnFailure)</code>. Here’s its implementation:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ICompressionFormat* <span class="title">FCompression::GetCompressionFormat</span><span class="params">(FName FormatName, <span class="type">bool</span> bErrorOnFailure)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ICompressionFormat** ExistingFormat = CompressionFormats.<span class="built_in">Find</span>(FormatName);</span><br><span class="line">  <span class="keyword">if</span> (ExistingFormat == <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;ICompressionFormat*&gt; Features = IModularFeatures::<span class="built_in">Get</span>().<span class="built_in">GetModularFeatureImplementations</span>&lt;ICompressionFormat&gt;(COMPRESSION_FORMAT_FEATURE_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ICompressionFormat* CompressionFormat : Features)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// is this format the right one?</span></span><br><span class="line">      <span class="keyword">if</span> (CompressionFormat-&gt;<span class="built_in">GetCompressionFormatName</span>() == FormatName)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// remember it in our format map</span></span><br><span class="line">        ExistingFormat = &amp;CompressionFormats.<span class="built_in">Add</span>(FormatName, CompressionFormat);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ExistingFormat == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (bErrorOnFailure)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogCompression, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;FCompression::GetCompressionFormat - Unable to find a module or plugin for compression format %s&quot;</span>), *FormatName.<span class="built_in">ToString</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogCompression, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;FCompression::GetCompressionFormat - Unable to find a module or plugin for compression format %s&quot;</span>), *FormatName.<span class="built_in">ToString</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> *ExistingFormat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is seen that it retrieves all <code>FeatureImplementation</code> from <code>IModularFeatures::Get().GetModularFeatureImplementations&lt;ICompressionFormat&gt;</code>. If you want to add your own compression algorithm, you can write a plugin and include it, thus allowing it to be used by name.</p>
<p>As mentioned at the beginning, to add it, you need to register a <code>Feature</code> using <code>IModularFeature::RegisterModularFeature</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IModularFeatures::<span class="built_in">Get</span>().<span class="built_in">RegisterModularFeature</span>(COMPRESSION_FORMAT_FEATURE_NAME, ICompressionFormatPointer);</span><br></pre></td></tr></table></figure>
<p>Here, <code>COMPRESSION_FORMAT_FEATURE_NAME</code> is a macro that corresponds to a string <code>CompressionFormat</code>, marking a group of <code>Feature</code> types. <code>ICompressionFormatPointer</code> is the pointer to the encapsulation of the compression algorithm you wish to add, and that object needs to inherit from <code>ICompressionFormat</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Public/Misc/ICompressionFormat.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMPRESSION_FORMAT_FEATURE_NAME <span class="string">&quot;CompressionFormat&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ICompressionFormat</span> : <span class="keyword">public</span> IModularFeature, <span class="keyword">public</span> IModuleInterface</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FName <span class="title">GetCompressionFormatName</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Compress</span><span class="params">(<span class="type">void</span>* CompressedBuffer, int32&amp; CompressedSize, <span class="type">const</span> <span class="type">void</span>* UncompressedBuffer, int32 UncompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Uncompress</span><span class="params">(<span class="type">void</span>* UncompressedBuffer, int32&amp; UncompressedSize, <span class="type">const</span> <span class="type">void</span>* CompressedBuffer, int32 CompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetCompressedBufferSize</span><span class="params">(int32 UncompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Additionally, in project settings, you can use <code>PakFileCompressionCommandlineOptions</code> to control the parameters for the compression algorithm. This parameter is passed to <code>UnrealPak</code> in <code>CopyBuildToStagingDirectory.Automation.cs</code>. For now, I won’t elaborate on this; it will be discussed later.</p>
<h2 id="Integrating-ZSTD"><a href="#Integrating-ZSTD" class="headerlink" title="Integrating ZSTD"></a>Integrating ZSTD</h2><p>As discussed earlier, integrating a compression algorithm requires implementing a class that inherits from <code>ICompressionFormat</code> and registering it with <code>IModularFeatures</code>. Taking ZSTD as an example, here’s how to add a compression algorithm.</p>
<p>First, let’s review the four interface functions provided in <code>ICompressionFormat</code> and their semantic requirements:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ICompressionFormat</span> : <span class="keyword">public</span> IModularFeature, <span class="keyword">public</span> IModuleInterface</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Get the name of the currently implemented compression algorithm</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FName <span class="title">GetCompressionFormatName</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Execute compression</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Compress</span><span class="params">(<span class="type">void</span>* CompressedBuffer, int32&amp; CompressedSize, <span class="type">const</span> <span class="type">void</span>* UncompressedBuffer, int32 UncompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Execute decompression</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Uncompress</span><span class="params">(<span class="type">void</span>* UncompressedBuffer, int32&amp; UncompressedSize, <span class="type">const</span> <span class="type">void</span>* CompressedBuffer, int32 CompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Get the maximum size of the buffer for compressed data</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetCompressedBufferSize</span><span class="params">(int32 UncompressedSize, int32 CompressionData)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Next, let’s proceed to integrate ZSTD. First, pull the code from <a target="_blank" rel="noopener" href="https://github.com/facebook/zstd/">facebook/zstd</a> and extract it (you can copy everything from the Lib directory except for the <code>dll</code> directory) into the <code>Source/ThirdParty</code> folder of your plugin. Then add its path to <code>PublicIncludePaths</code> in your plugin’s <code>*.build.cs</code>.</p>
<p>You would need to modify ZSTD’s code because the compilation environment and warning levels in UE may not allow the code to compile correctly. Common operations involve ignoring certain warnings, but ZSTD has a specific scenario where its code containing <code>XXHash</code> may conflict with existing definitions in <code>LiveCoding</code>, leading to redefinition errors, so the <code>XXHash</code> code in ZSTD has to be renamed.</p>
<p>Once the ZSTD code compiles successfully in UE, you can move on to creating and implementing the ZSTD <code>ICompressionFormat</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FZstdCompressionFormat</span> : <span class="keyword">public</span> ICompressionFormat</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FName <span class="title">GetCompressionFormatName</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Compress</span><span class="params">(<span class="type">void</span>* CompressedBuffer, int32&amp; CompressedSize, <span class="type">const</span> <span class="type">void</span>* UncompressedBuffer, int32 UncompressedSize, int32 CompressionData)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Uncompress</span><span class="params">(<span class="type">void</span>* UncompressedBuffer, int32&amp; UncompressedSize, <span class="type">const</span> <span class="type">void</span>* CompressedBuffer, int32 CompressedSize, int32 CompressionData)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetCompressedBufferSize</span><span class="params">(int32 UncompressedSize, int32 CompressionData)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> int32 Level;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>This merely derives from <code>ICompressionFormat</code> and adds a static member <code>Level</code> to track which compression level to use in ZSTD.</p>
<p>The remaining task is to identify the functions in ZSTD’s code that can implement the semantics of the <code>ICompressionFormat</code> interface:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZSTDLIB_API <span class="type">size_t</span> <span class="title">ZSTD_compress</span><span class="params">(<span class="type">void</span>* dst, <span class="type">size_t</span> dstCapacity, <span class="type">const</span> <span class="type">void</span>* src, <span class="type">size_t</span> srcSize, <span class="type">int</span> compressionLevel)</span></span>;</span><br><span class="line"><span class="function">ZSTDLIB_API <span class="type">size_t</span> <span class="title">ZSTD_decompress</span><span class="params">(<span class="type">void</span>* dst, <span class="type">size_t</span> dstCapacity, <span class="type">const</span> <span class="type">void</span>* src, <span class="type">size_t</span> compressedSize)</span></span>;</span><br><span class="line"><span class="function">ZSTDLIB_API <span class="type">size_t</span> <span class="title">ZSTD_compressBound</span><span class="params">(<span class="type">size_t</span> srcSize)</span></span>; <span class="comment">/*!&lt; maximum compressed size in worst case single-pass scenario */</span></span><br></pre></td></tr></table></figure>

<p>By examining ZSTD’s code, you can see that these three functions together can implement all functionalities of <code>ICompressionFormat</code>. The implementation is straightforward—all that is required is to forward function calls:<br>Note: The <code>GetCompressionFormatName</code> function specifies the name of the compression feature, which I set to <code>zstd</code>. This name will be used in project settings.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FName <span class="title">FZstdCompressionFormat::GetCompressionFormatName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">TEXT</span>(<span class="string">&quot;zstd&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FZstdCompressionFormat::Compress</span><span class="params">(<span class="type">void</span>* CompressedBuffer, int32&amp; CompressedSize, <span class="type">const</span> <span class="type">void</span>* UncompressedBuffer, int32 UncompressedSize, int32 CompressionData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;FZstdCompressionFormat::Compress level is %d&quot;</span>), FZstdCompressionFormat::Level);</span><br><span class="line">  int32 Result = <span class="built_in">ZSTD_compress</span>(CompressedBuffer, CompressedSize, UncompressedBuffer, UncompressedSize, FZstdCompressionFormat::Level);</span><br><span class="line">  <span class="keyword">if</span> (Result &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Result &gt; <span class="built_in">GetCompressedBufferSize</span>(UncompressedSize, CompressionData))</span><br><span class="line">    &#123;</span><br><span class="line">      FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%d &lt; %d&quot;</span>), Result, <span class="built_in">GetCompressedBufferSize</span>(UncompressedSize, CompressionData));</span><br><span class="line">      <span class="comment">// we cannot safely go over the BufferSize needed!</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CompressedSize = Result;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FZstdCompressionFormat::Uncompress</span><span class="params">(<span class="type">void</span>* UncompressedBuffer, int32&amp; UncompressedSize, <span class="type">const</span> <span class="type">void</span>* CompressedBuffer, int32 CompressedSize, int32 CompressionData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  int32 Result = <span class="built_in">ZSTD_decompress</span>(UncompressedBuffer, UncompressedSize, CompressedBuffer, CompressedSize);</span><br><span class="line">  <span class="keyword">if</span> (Result &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    UncompressedSize = Result;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">int32 <span class="title">FZstdCompressionFormat::GetCompressedBufferSize</span><span class="params">(int32 UncompressedSize, int32 CompressionData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ZSTD_compressBound</span>(UncompressedSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At this point, the integration of ZSTD is complete. The final step is to add this feature to <code>IModularFeatures</code>, making it available for the engine to use.</p>
<p>As I created a plugin, I will write the registration logic in the module’s <code>StartupModule</code>, and unregister it in <code>ShutdownModule</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ZSTD_LEVEL_OPTION_STRING TEXT(<span class="string">&quot;-ZstdLevel=&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FlibzstdModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FString CommandLine = FCommandLine::<span class="built_in">Get</span>();</span><br><span class="line">  <span class="keyword">if</span> (CommandLine.<span class="built_in">Contains</span>(ZSTD_LEVEL_OPTION_STRING, ESearchCase::IgnoreCase))</span><br><span class="line">  &#123;</span><br><span class="line">    int32 level;</span><br><span class="line">    FParse::<span class="built_in">Value</span>(FCommandLine::<span class="built_in">Get</span>(), *<span class="built_in">FString</span>(ZSTD_LEVEL_OPTION_STRING).<span class="built_in">ToLower</span>(), level);</span><br><span class="line">    FZstdCompressionFormat::Level = FMath::<span class="built_in">Clamp</span>(level, <span class="built_in">ZSTD_minCLevel</span>(), <span class="built_in">ZSTD_maxCLevel</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ZstdCompressionFormat = <span class="keyword">new</span> <span class="built_in">FZstdCompressionFormat</span>();</span><br><span class="line">  IModularFeatures::<span class="built_in">Get</span>().<span class="built_in">RegisterModularFeature</span>(COMPRESSION_FORMAT_FEATURE_NAME, ZstdCompressionFormat);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FlibzstdModule::ShutdownModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  IModularFeatures::<span class="built_in">Get</span>().<span class="built_in">UnregisterModularFeature</span>(COMPRESSION_FORMAT_FEATURE_NAME, ZstdCompressionFormat);</span><br><span class="line">  <span class="keyword">delete</span> ZstdCompressionFormat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Using the same registration method as before, I also added a command-line parameter when the engine starts, <code>-ZstdLevel=</code>, which can be used to specify the compression level for ZSTD.</p>
<p>To use the <code>ZSTD</code> algorithm for packaging Pak, you can use my <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a> to add the <code>-compressionformats=zstd,zlib</code> parameter in <code>UnrealPakOptions</code>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/8470/ue-hotpatcher-compressionformats.webp"></p>
<p>To check the compression format used by <code>UnrealPak</code>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/8470/ue4-zstd-compression.webp"></p>
<blockquote>
<p>Note: Since the engine is not compiled, you cannot directly use <code>UnrealPak.exe</code> to decompress Pak files compressed with <code>ZSTD</code>.</p>
</blockquote>
<h2 id="How-to-Use"><a href="#How-to-Use" class="headerlink" title="How to Use"></a>How to Use</h2><p>If you’re calling the <code>ExecuteUnrealPak</code> function from the <code>PakFileUtilities</code> module directly in the UE editor, you only need to enable this plugin in your project, similar to how I used <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>.</p>
<p>However, when packaging directly in the editor (including using <code>ProjectLauncher</code>), UE launches a separate process and does not load this plugin, which can cause issues. Therefore, I will also discuss the solution.</p>
<h3 id="Runtime-Usage"><a href="#Runtime-Usage" class="headerlink" title="Runtime Usage"></a>Runtime Usage</h3><p>To use <code>zstd</code> at runtime, you can retrieve the <code>zstd</code> object registered in the engine and use its interfaces to call the <code>ICompressionFormat</code> methods.</p>
<p>You can obtain it through <code>FCompression</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ICompressionFormat* ZstdCompressionFormat = FCompression::<span class="built_in">GetCompressionFormat</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;zstd&quot;</span>), <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>Once you have it, you can call <code>Compress</code>, <code>Uncompress</code>, and other interfaces to perform compression and decompression.</p>
<h3 id="Modifying-UnrealPak"><a href="#Modifying-UnrealPak" class="headerlink" title="Modifying UnrealPak"></a>Modifying UnrealPak</h3><p>When we use <code>File</code> - <code>Package Project</code> - <code>PLATFORM</code> in the editor, the process goes through several stages:</p>
<ol>
<li>Compiling the project and any dependent plugins.</li>
<li>Cooking the resources in the project.</li>
<li>Using <code>UnrealPak.exe</code> to package the cooked resources.</li>
<li>Copying the packaged results.</li>
</ol>
<p>Since I integrated <code>zstd</code>, it needs to be used during the resource cooking phase, where the <code>Package</code> - <code>PakFileCompressionFormat(s)</code> in project settings takes effect.</p>
<p><strong>However</strong>, since the plugin I created is placed in the project, <code>UnrealPak</code> as a separate program won’t load this plugin, which makes it a bit awkward and unusable directly. To resolve this, modifications should be made to <code>UnrealPak</code>, ensuring it loads the <code>libzstd</code> plugin and registers it with <code>IModularFeature</code> on startup. Since <code>UnrealPak</code> belongs to <code>Programs</code>, you will need the source version of the engine for compilation.</p>
<p>The specific approach is as follows:</p>
<ol>
<li>Place the plugin in the engine’s <code>Engine\Plugins\Runtime</code> directory.</li>
<li>Run <code>GenerateProjectFiles.bat</code> from the engine directory.</li>
<li>Edit the <code>UnrealPak</code> code to add a dependency on the <code>libzstd</code> module and dynamically load the module in the main function:</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Engine\Source\Programs\UnrealPak\Private\UnrealPak.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;UnrealPak.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RequiredProgramMainCPPInclude.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PakFileUtilities.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IPlatformFilePak.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libzstd.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">IMPLEMENT_APPLICATION</span>(UnrealPak, <span class="string">&quot;UnrealPak&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">INT32_MAIN_INT32_ARGC_TCHAR_ARGV</span>()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// start up the main loop</span></span><br><span class="line">  GEngineLoop.<span class="built_in">PreInit</span>(ArgC, ArgV);</span><br><span class="line"></span><br><span class="line">  FlibzstdModule&amp; LibZstdModule = FModuleManager::<span class="built_in">LoadModuleChecked</span>&lt;FlibzstdModule&gt;(<span class="built_in">FName</span>(<span class="string">&quot;libzstd&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> StartTime = FPlatformTime::<span class="built_in">Seconds</span>();</span><br><span class="line"></span><br><span class="line">  int32 Result = <span class="built_in">ExecuteUnrealPak</span>(FCommandLine::<span class="built_in">Get</span>()) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogPakFile, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Unreal pak executed in %f seconds&quot;</span>), FPlatformTime::<span class="built_in">Seconds</span>() - StartTime);</span><br><span class="line"></span><br><span class="line">  GLog-&gt;<span class="built_in">Flush</span>();</span><br><span class="line"></span><br><span class="line">  FEngineLoop::<span class="built_in">AppPreExit</span>();</span><br><span class="line">  FEngineLoop::<span class="built_in">AppExit</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can also see my modified <code>UnrealPak</code> code here: <a href="UnrealPak_422Source.7z">UnrealPak_422Source.7z</a>.</p>
<p>Then compile <code>UnrealPak</code> in <code>Development</code> mode. The resulting <code>UnrealPak.exe</code> will now support <code>zstd</code> compression/decompression functionality.</p>
<p>You can also place this <code>UnrealPak.exe</code> in the installed version of the engine to use it.</p>
<p>Here’s my compiled version of <code>UnrealPak</code> that supports <code>ZSTD</code> (UE4.22.3): <a target="_blank" rel="noopener" href="https://1drv.ms/u/s!AjFMYHAQUensgetGr2fcxHsbWIXeHQ?e=W3CvZX">UnrealPak422_ZSTD</a>.</p>
<p>Now you can specify <code>zstd</code> in the project settings under <code>Package</code> - <code>PakFileCompressionFormat(s)</code>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/8470/ue4-package-setting-zstd-compression.webp"></p>
<h3 id="Passing-Parameters-to-zstd"><a href="#Passing-Parameters-to-zstd" class="headerlink" title="Passing Parameters to zstd"></a>Passing Parameters to zstd</h3><p>Remember the <code>PakFileCompressionCommandlineOptions</code> in the project settings that I put aside earlier? This parameter can be passed as command-line arguments to <code>UnrealPak.exe</code>. Any content filed here will be forwarded to <code>UnrealPak.exe</code>. Our modified <code>UnrealPak</code> will load the <code>libzstd</code> module on startup, and we can analyze the command line input in the <code>StartupModule</code> of the <code>libzstd</code> module to control various compression parameters (like compression level):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ZSTD_LEVEL_OPTION_STRING TEXT(<span class="string">&quot;-ZstdLevel=&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FlibzstdModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FString CommandLine = FCommandLine::<span class="built_in">Get</span>();</span><br><span class="line">  <span class="keyword">if</span> (CommandLine.<span class="built_in">Contains</span>(ZSTD_LEVEL_OPTION_STRING, ESearchCase::IgnoreCase))</span><br><span class="line">  &#123;</span><br><span class="line">    int32 level;</span><br><span class="line">    FParse::<span class="built_in">Value</span>(FCommandLine::<span class="built_in">Get</span>(), *<span class="built_in">FString</span>(ZSTD_LEVEL_OPTION_STRING).<span class="built_in">ToLower</span>(), level);</span><br><span class="line">    FZstdCompressionFormat::Level = FMath::<span class="built_in">Clamp</span>(level, <span class="built_in">ZSTD_minCLevel</span>(), <span class="built_in">ZSTD_maxCLevel</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;FZstdCompressionFormat::Compress level is %d&quot;</span>), FZstdCompressionFormat::Level);</span><br><span class="line">  ZstdCompressionFormat = <span class="keyword">new</span> <span class="built_in">FZstdCompressionFormat</span>();</span><br><span class="line">  IModularFeatures::<span class="built_in">Get</span>().<span class="built_in">RegisterModularFeature</span>(COMPRESSION_FORMAT_FEATURE_NAME, ZstdCompressionFormat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This way, you can fill <code>-zstdlevel=22</code> in the <code>PakFileCompressionCommandlineOptions</code> to control the compression level that you want to use.</p>
<blockquote>
<p>Note that <code>Package</code> - <code>PakFileCompressionCommandlineOptions</code> is inactive by default. If you don’t add any other compression algorithms and use the method of obtaining parameters that I described above, any entries here will have no effect.</p>
</blockquote>
<h2 id="Final-Thoughts"><a href="#Final-Thoughts" class="headerlink" title="Final Thoughts"></a>Final Thoughts</h2><p>Using this method, you can integrate other compression algorithms on your own, such as <a target="_blank" rel="noopener" href="https://github.com/lz4/lz4">lz4</a>, etc. I will write about the compression ratio and performance analysis of ZSTD during packaging when I have more time.</p>
<h2 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h2><p>On April 1, 2021, UE announced the integration of RAD’s Oodle compression algorithm suite into UE in both UE4.27 and UE5. While 4.27 hasn’t been released yet, code and link libraries have already been uploaded. I extracted Oodle and fixed some errors in earlier engine versions, allowing it to be used directly in older engine versions.</p>
<p>For detailed content, please refer to:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://imzlp.com/notes/ue5/#Oodle-Compression">notes/ue5#Oodle Compression</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hxhb/oodle-compression">oodle-compression</a></li>
</ul>
<p>The usage method can be referenced in this article by specifying <code>-compressionformats=Oodle</code> as the command-line argument, as well as <code>-compresslevel=Leviathan</code> to designate the compression level. Testing shows that a Pak file compressed with zlib and measuring 295M was reduced to 282M using Oodle, while Oodle’s decompression speed surpasses that of zlib.</p>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                The article is finished. If you have any questions, please comment and communicate.
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/8470/" target="_blank">Integrate ZSTD compression algorithm for UE4 using ModularFeature</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2020/04/20 21:52<br/>
             
             <span>Word Count:</span><span class="page-count">9.9k Words</span><br/>
             
             <span>Link:</span><a href="/posts/8470/" target="_blank" title="Integrate ZSTD compression algorithm for UE4 using ModularFeature">https://en.imzlp.com/posts/8470/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/8470/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" rel="tag"># 插件开发</a>
              <a href="/tags/ZSTD/" rel="tag"># ZSTD</a>
              <a href="/tags/%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95/" rel="tag"># 压缩算法</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/17371/" rel="prev" title="UE hot update: demand analysis and solution design">
      <i class="fa fa-chevron-left"></i> UE hot update: demand analysis and solution design
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/36659/" rel="next" title="UE hot update: Lua programming guide based on UnLua">
      UE hot update: Lua programming guide based on UnLua <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ModularFeature"><span class="nav-number">2.</span> <span class="nav-text">ModularFeature</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Specifying-Compression-Algorithms"><span class="nav-number">3.</span> <span class="nav-text">Specifying Compression Algorithms</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Integrating-ZSTD"><span class="nav-number">4.</span> <span class="nav-text">Integrating ZSTD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-Use"><span class="nav-number">5.</span> <span class="nav-text">How to Use</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Runtime-Usage"><span class="nav-number">5.1.</span> <span class="nav-text">Runtime Usage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Modifying-UnrealPak"><span class="nav-number">5.2.</span> <span class="nav-text">Modifying UnrealPak</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Passing-Parameters-to-zstd"><span class="nav-number">5.3.</span> <span class="nav-text">Passing Parameters to zstd</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Final-Thoughts"><span class="nav-number">6.</span> <span class="nav-text">Final Thoughts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPDATE"><span class="nav-number">7.</span> <span class="nav-text">UPDATE</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/8470/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
