<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="In some previous articles, the issue of UE hot updates missing shaders and using default materials has been introduced, along with a Shader Patch solution. For details, please refer to the articles:">
<meta property="og:type" content="article">
<meta property="og:title" content="UE Hot Update: Shader update strategy">
<meta property="og:url" content="https://en.imzlp.com/posts/15810/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="In some previous articles, the issue of UE hot updates missing shaders and using default materials has been introduced, along with a Shader Patch solution. For details, please refer to the articles:">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210910103926.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312110129.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210912214012.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210913104500.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210830001957.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210912214134.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20210913121230612.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/17590/cook-patch-assets.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029105320.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029105602.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029002009.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029002120.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029000741.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211031192608.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211031192608.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211031193821.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211031193656.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211030172750.jpg">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211030173043.jpg">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211030173340.jpg">
<meta property="article:published_time" content="2021-09-13T10:24:16.000Z">
<meta property="article:modified_time" content="2021-09-13T10:24:16.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="热更新">
<meta property="article:tag" content="Shader">
<meta property="article:tag" content="InlineShaderCode">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/15810/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>UE Hot Update: Shader update strategy | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/15810/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          UE Hot Update: Shader update strategy<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2021-09-13-15810.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/15810/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        
          <div class="post-subtitle" style="text-align: center;line-height: 1;">
            <sub text-align="center" style="font-size: 15px;align-content: center;font-style: italic;bottom: 0em;">UE热更新：Shader更新策略</sub>
          </div>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-13 10:24 10:24:16:24" itemprop="dateCreated datePublished" datetime="2021-09-13T10:24:16+00:00">2021-09-13 10:24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/" itemprop="url" rel="index"><span itemprop="name">UnrealEngine</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/%E7%83%AD%E6%9B%B4%E6%96%B0/" itemprop="url" rel="index"><span itemprop="name">热更新</span></a>
                </span>
            </span>

          
            <span id="/posts/15810/" class="post-meta-item leancloud_visitors" data-flag-title="UE Hot Update: Shader update strategy" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>27 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>In some previous articles, the issue of UE hot updates missing shaders and using default materials has been introduced, along with a Shader Patch solution. For details, please refer to the articles:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://imzlp.com/posts/5867/">UE Hot Update: Create Shader Patch</a></li>
<li>[UE Hot Update: Questions &amp; Answers#Hot Update Resources Not Working / Material Missing](<a target="_blank" rel="noopener" href="https://imzlp.com/posts/16895/#Hot">https://imzlp.com/posts/16895/#Hot</a> Update Resources Not Working-Material Missing).</li>
</ul>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp"></p>
<p>The fundamental reason for the runtime loss of materials is that the shaders dependent on newly added or modified resources were not packaged, leading to reading failures at runtime. This article will introduce the strategy and pros and cons of shader updates, analyze the mechanisms within the engine, and provide an optimized solution that combines the advantages of Shader Patch and Inline Shader Code, which has been implemented in <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>.</p>
<span id="more"></span>

<p>UE has two serialization strategies for shaders during cooking:</p>
<ol>
<li>Share Material Shader Code: This will serialize the required shaders for the project into a separate Shader Code Library file (<code>ushaderbytecode</code> or <code>metailib</code>), which can reduce package size and avoid shader redundancy, allowing shaders to be searched from shaderbytecode during read.</li>
<li>Inline Shader Code: This serialization method includes shaders in the material uasset, avoiding the management of Shader Code Library. Each material, after cooking, itself contains the required shaders, leading to redundancy within the entire package and increasing package size.</li>
</ol>
<p>In the default project configuration of a new project, <code>Project Settings</code>-<code>Project</code>-<code>Packaging</code>-<code>Shader Material Shader Code</code> is set to off.</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210910103926.webp"></p>
<p>However, in order to reduce the package size, it is generally enabled during packaging, and the resulting package contains ushaderbytecode:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312110129.webp"></p>
<p>If we subsequently update the material without updating the shaders that have changed within the package, it will lead to the material loss issue mentioned earlier. Thus, material loss is determined by two prerequisites:</p>
<ol>
<li>Share Material Shader Code is enabled.</li>
<li>The shader library <code>ushaderbytecode</code> is not updated after the material update.</li>
</ol>
<p>Based on these two prerequisites, a shader update strategy can be formulated:</p>
<ol>
<li>Update the latest Shader Code Library every time an update is made.</li>
<li>Implement inline Shader Code cooking for the updated materials.</li>
</ol>
<p>However, these two strategies also lead to their respective issues:</p>
<p>Shader Code Library:</p>
<ol>
<li>The complete Shader Code Library is excessively large.</li>
<li>Shader Patch requires the management of additional metadata files.</li>
<li>Each patch must be based on the complete shaderbytecode.</li>
</ol>
<p>Inline Shader Code:</p>
<ol>
<li>UE’s default Cook Commandlet does not provide a method to cook a single resource.</li>
<li>Inline Shader Code increases package size.</li>
</ol>
<h2 id="Shader-Patch"><a href="#Shader-Patch" class="headerlink" title="Shader Patch"></a>Shader Patch</h2><p>The process of performing Shader Patch in UE has been previously described in my article: <a target="_blank" rel="noopener" href="https://imzlp.com/posts/5867/">UE Hot Update: Create Shader Patch</a> .</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210912214012.webp" alt="Shader Patch"></p>
<p>Here, I will discuss the mechanisms for creating the Shader Code Library not mentioned in the previous article. In the material resource, there is an attribute <code>bShareCode</code> marking whether the current shader exists in the Shader Library or is inline:</p>
<figure class="highlight cpp"><figcaption><span>Source\Runtime\RenderCore\Private\ShaderMap.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FShaderMapBase::Serialize</span><span class="params">(FArchive&amp; Ar, <span class="type">bool</span> bInlineShaderResources, <span class="type">bool</span> bLoadedByCookedMaterial, <span class="type">bool</span> bInlineShaderCode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">bool</span> bShareCode = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_EDITOR</span></span><br><span class="line">    bShareCode = !bInlineShaderCode &amp;&amp; FShaderLibraryCooker::<span class="built_in">IsShaderLibraryEnabled</span>() &amp;&amp; Ar.<span class="built_in">IsCooking</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// WITH_EDITOR</span></span></span><br><span class="line">    Ar &lt;&lt; bShareCode;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The implementation of <code>FShaderLibraryCooker::IsShaderLibraryEnabled</code> (prior to UE4.26, it was <code>FShaderCodeLibrary::IsEnabled</code>):</p>
<figure class="highlight cpp"><figcaption><span>ShaderCodeLibrary.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FShaderCodeLibrary::IsEnabled</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FShaderCodeLibraryImpl::Impl != <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The creation of <code>FShaderCodeLibraryImpl::Impl</code> takes place in the following two functions:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for Cooking</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FShaderCodeLibrary::InitForCooking</span><span class="params">(<span class="type">bool</span> bNativeFormat)</span></span>;</span><br><span class="line"><span class="comment">// for Runtime </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FShaderCodeLibrary::InitForRuntime</span><span class="params">(EShaderPlatform ShaderPlatform)</span></span>;</span><br></pre></td></tr></table></figure>

<p>This essentially divides into two phases: when cooking for storage, and when reading, it is essential to determine whether the currently dependent shader is stored in the shader library or inlined.</p>
<p>By default, these two functions will not be executed during the editor’s startup because, theoretically, one is required during packaging and the other during non-Editor runtime. They are respectively used during cooking as follows:</p>
<figure class="highlight cpp"><figcaption><span>Editor/UnrealEd/Private/CookOnTheFlyServer.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UCookOnTheFlyServer::InitShaderCodeLibrary</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> UProjectPackagingSettings* <span class="type">const</span> PackagingSettings = <span class="built_in">GetDefault</span>&lt;UProjectPackagingSettings&gt;();</span><br><span class="line">	<span class="type">bool</span> <span class="type">const</span> bCacheShaderLibraries = <span class="built_in">IsUsingShaderCodeLibrary</span>();</span><br><span class="line">    <span class="keyword">if</span> (bCacheShaderLibraries &amp;&amp; PackagingSettings-&gt;bShareMaterialShaderCode)</span><br><span class="line">    &#123;</span><br><span class="line">		FShaderLibraryCooker::<span class="built_in">InitForCooking</span>(PackagingSettings-&gt;bSharedMaterialNativeLibraries);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And in <code>FEngineLoop::PreInitPreStartupScreen</code> (Non-Editor runtime):<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210913104500.webp" alt="FShaderCodeLibrary::InitForRuntime"></p>
<p>Moreover, for situations where Share Shader Library is enabled, UE has also provided a mechanism (4.26+) to forcibly specify that certain resources’ shaders should be inline, configured using the following method:</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ShaderCodeLibrary]</span></span><br><span class="line"><span class="attr">bEnableInliningWorkaround_Windows</span>=<span class="literal">True</span></span><br><span class="line">+<span class="attr">MaterialToInline</span>=/Game/StarterContent/Materials/M_Brick_Clay_Beveled</span><br></pre></td></tr></table></figure>
<p>During the execution of cooking, there is a check for <code>ShouldInlineShaderCode</code>:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210830001957.webp"></p>
<p>To realize forced inlining.</p>
<h2 id="Inline-Shader-Code"><a href="#Inline-Shader-Code" class="headerlink" title="Inline Shader Code"></a>Inline Shader Code</h2><p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210912214134.webp" alt="Inline Shader Code"></p>
<p>In the introduction of the previous section, it has been mentioned whether shaders are serialized to the Shader Library during cooking based on the prerequisite: <code>FShaderCodeLibrary::IsEnabled</code> (4.25-) or <code>FShaderLibraryCooker::IsShaderLibraryEnabled</code> (4.26+). To achieve Inline Shader Code:</p>
<ol>
<li>Turn off <code>bShareMaterialShaderCode</code> in project settings for UE’s CookCommandlet.</li>
<li>Implement a custom cooking process that does not execute <code>FShaderLibraryCooker::InitForCooking</code>.</li>
</ol>
<p>For the first method, every time you want to cook inline, you need to manually modify the project settings, which is inconvenient, so the second method is recommended. However, UE does not provide an interface for cooking a single resource. I have implemented a method to cook a single resource in <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>, supporting selection of resources and directories within the editor, as well as cooking resources within patches:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20210913121230612.webp"></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/17590/cook-patch-assets.webp"></p>
<p>It is also encapsulated in code:</p>
<figure class="highlight cpp"><figcaption><span>FlibHotPactherEditorHelper.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">CookPackage</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="type">const</span> FAssetData&amp; AssetData,</span></span></span><br><span class="line"><span class="params"><span class="function">		UPackage* Package,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="type">const</span> TArray&lt;FString&gt;&amp; Platforms,</span></span></span><br><span class="line"><span class="params"><span class="function">		TFunction&lt;<span class="type">void</span>(<span class="type">const</span> FString&amp;)&gt; PackageSavedCallback = [](<span class="type">const</span> FString&amp;)&#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">class</span> TMap&lt;FString,FSavePackageContext*&gt; PlatformSavePackageContext = TMap&lt;FString,FSavePackageContext*&gt;&#123;&#125;</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>By using this interface, you can perform cooking in the editor, and when the resource being cooked is a material, it will be serialized using Inline Shader Code.</p>
<h2 id="Better-Way"><a href="#Better-Way" class="headerlink" title="Better Way"></a>Better Way</h2><p>As mentioned earlier, using Shader Patch and Inline Shader Code each has its own strengths and weaknesses:</p>
<ol>
<li>Shader Patch requires complete cooking, doing patches on two complete pieces of shader code can be inefficient for large projects and incurs additional management costs.</li>
<li>Inline Shader Code: where no additional files need to be managed, the downside is that shaders cannot be shared, resulting in redundancy.</li>
</ol>
<p>Thus, I provide a plan that combines the strengths of both in <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>:</p>
<ol>
<li>Keep the Share Shader Code Library enabled during cooking.</li>
<li>Only gather all compiled shaders from the resources cooked in the current patch and generate a separate Shader Library.</li>
</ol>
<p>This eliminates the need to manually execute Shader Patch and removes concerns about package size increases from using Inline Shader Code. It is a solution that leverages the advantages of both. Thanks to the process mechanisms of HotPatcher, it can collect all the shaders for the current platform’s cooked resources during the cooking phase (as each packaging platform may have multiple shader formats, like Android’s <code>GLSL_ES</code> or <code>Vulkan</code>).</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029105320.webp"></p>
<p>Once all resources are done cooking, all shaders from this cook will be collected, generating a Shader Code Library to be directly packaged into pak. This implementation does not require new and old version patches for incremental shaders, thus, there is no need for complete cooking, and no need to manage shader code versions.</p>
<p>All functions in HotPatcher can be simply toggled on or off:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029105602.webp"></p>
<p>If <code>bSharedShaderLibrary</code> is not enabled, then all cooked shaders in the current patch are inline shader codes. Conversely, the shaders will be shared, reducing shader redundancy.</p>
<p>There are also several other options:</p>
<ul>
<li><code>bNativeShader</code>: Same as the project setting <code>SharedMaterialNativeLibraries</code>. Once enabled, the iOS platform will compile to metallib.</li>
<li><code>ShaderNameRule</code>: Naming for the Shader Library generated for the current patch, providing three modes: the current patch version, project name, or custom.</li>
<li><code>ShaderLibMountPoint</code> specifies the path where the shader library is stored in the pak for loading during runtime.</li>
</ul>
<blockquote>
<p>Note: By default, the pak includes the <code>Global</code> and project name’s Shader Library, and care should be taken to avoid naming collisions.</p>
</blockquote>
<p>After enabling <code>bSharedShaderLibrary</code> in the plugin, both Windows and Android will generate ushaderbytecode and package it into pak:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029002009.webp" alt="Windows"></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029002120.webp" alt="Android"></p>
<p>If <code>bNativeShader</code> is enabled for iOS, it will compile metallib and metalmap:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211029000741.webp"></p>
<p>Due to iOS’s loading mechanism for Native Shader, metallib and metalmap cannot be packaged into pak. They must be loaded directly from disk, not through UFS.</p>
<p>For the Shader Library packaged for the patch, it must be called after mounting for use. I have similarly encapsulated a loading function in the plugin:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UFlibPatchParserHelper::LoadShaderbytecode</span><span class="params">(<span class="type">const</span> FString&amp; LibraryName, <span class="type">const</span> FString&amp; LibraryDir)</span></span>;</span><br></pre></td></tr></table></figure>

<p>The parameters to be passed here are derived from the <code>ShaderNameRule</code>. If it is the version number, pass the version number as a string. The second parameter is the Shader Library path in the pak, passing the value of <code>ShaderLibMountPoint</code>.</p>
<p>If Shared Shader Library is enabled but only mounted without calling LoadShaderbytecode, it will still result in material loss effects.</p>
<h2 id="Cook-Shader-Format"><a href="#Cook-Shader-Format" class="headerlink" title="Cook Shader Format"></a>Cook Shader Format</h2><p>During the cooking phase, HotPatcher will use the Shader formats configured in project settings for each platform. Each platform can have multiple Shader Formats; we take the most commonly used Windows/Android/iOS platforms as examples.</p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>When packing for Windows, it retrieves <code>GEngineIni</code>‘s <code>TargetRHIs</code>, which defaults to <code>PCD3D_SM5</code>, and can also include <code>ES3.1</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/WindowsTargetPlatform.WindowsTargetSettings]</span></span><br><span class="line"><span class="attr">Compiler</span>=Default</span><br><span class="line">+<span class="attr">TargetedRHIs</span>=PCD3D_ES31</span><br><span class="line">+<span class="attr">TargetedRHIs</span>=PCD3D_SM5</span><br><span class="line"><span class="attr">DefaultGraphicsRHI</span>=DefaultGraphicsRHI_Default</span><br></pre></td></tr></table></figure>

<p>The engine’s code relevant to acquiring Windows Shader Formats can be found in: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Developer/Windows/WindowsTargetPlatform/Private/GenericWindowsTargetPlatform.h#L229">GenericWindowsTargetPlatform.h#L229</a></p>
<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><p>Android is also configured in the engine (UE dropped support for ES2 in version 4.25 and later):</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211031192608.webp"></p>
<p>The engine’s code relevant to acquiring Android Shader Formats can be found at: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Developer/Android/AndroidTargetPlatform/Private/AndroidTargetPlatform.cpp#L390">AndroidTargetPlatform.cpp#L390</a></p>
<h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><p>iOS uses Metal, and whether to compile as Native can be toggled within project settings and HotPatcher with the <code>bNativeShader</code> option. Additionally, it should also depend on whether compiled on Mac or if the Windows environment has a Metal Compiler (4.26+).</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211031192608.webp" alt="Project Settings-Package"><br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211031193821.webp" alt="Override location of Metal Toolchain"></p>
<blockquote>
<p>Note: Accessing the path of Metal Toolchain in the engine for Windows is <code>C:\Program Files\Metal Developer Tools</code>. By default, it will be installed there; if it is located elsewhere, it needs to be modified under <code>Project Settings-IOS-Build</code> in <code>Override location of Metal Toolchain</code>.</p>
</blockquote>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211031193656.webp" alt="HotPatcher"></p>
<p>By enabling <code>bNativeShader</code> in HotPatcher, it will compile metallic/metalmap in supported environments.</p>
<p>The relevant engine code for acquiring Shader Formats on the iOS platform can be found at: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Developer/IOS/IOSTargetPlatform/Private/IOSTargetPlatform.cpp#L581">IOSTargetPlatform.cpp#L581</a></p>
<h2 id="Native-Metal-Shader"><a href="#Native-Metal-Shader" class="headerlink" title="Native Metal Shader"></a>Native Metal Shader</h2><p>As mentioned in previous notes, Apple has introduced a Metal Shader Compiler for Windows, which can compile Metal Native Shader on Windows: <a target="_blank" rel="noopener" href="https://imzlp.com/notes/ue/#Windows-Metal-Shader-Compiler-for-IOS">Windows Metal Shader Compiler for iOS</a>. However, UE only provided engine-level support after version 4.26; before version 4.25, metal could only be packaged using a Mac, and using remote build on Windows would only allow for Text Shader, which is ushaderbytecode, performing lower than Native. During runtime, it generates the following log:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LogMetal: Display: Loaded a text shader (will be slower to load)</span><br></pre></td></tr></table></figure>
<p>The engine’s code can be found at: <a target="_blank" rel="noopener" href="https://cs.github.com/EpicGames/UnrealEngine/blob/d11782b9046e9d0b130309591e4efc57f4b8b037/Engine/Source/Runtime/Apple/MetalRHI/Private/Shaders/Types/Templates/MetalBaseShader.h?q=NewLibrary+path:/%5EEngine%5C/Source%5C/Runtime%5C/Apple%5C/MetalRHI%5C/Private%5C//#L163">Engine/Source/Runtime/Apple/MetalRHI/Private/Shaders/Types/Templates/MetalBaseShader.h</a></p>
<blockquote>
<p>In an environment that supports compiling Native Metal (Mac/Win), HotPatcher also supports compiling Patch resource shaders in Native format.</p>
</blockquote>
<p>Although there is an option to enable Native Shader during packaging in project settings, this switch does not affect the code at runtime after packaging. Regardless of whether the base package has Native enabled, all three shader update methods can be utilized:</p>
<ol>
<li>ushaderbytecode</li>
<li>inline shader code</li>
<li>Native (metallib/metalmap)</li>
</ol>
<p>For the loading of <code>OpenLibrary</code>, on the Metal platform, it will prioritize loading Native first, and only if that fails will it load ushaderbytecode.</p>
<ol>
<li>Attempt to load metalmap; if it fails, <code>FMetalDynamicRHI::RHICreateShaderLibrary</code> returns nullptr (<code>Apple\MetalRHI\Private\MetalShaders.cpp</code>)</li>
<li>If loading the metalmap fails, then load ushaderbytecode.</li>
</ol>
<figure class="highlight cpp"><figcaption><span>Runtime\RenderCore\Private\ShaderCodeLibrary.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FShaderLibraryInstance</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">static</span> FShaderLibraryInstance* <span class="title">Create</span><span class="params">(EShaderPlatform InShaderPlatform, <span class="type">const</span> FString&amp; ShaderCodeDir, FString <span class="type">const</span>&amp; InLibraryName)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		FRHIShaderLibraryRef Library;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">RHISupportsNativeShaderLibraries</span>(InShaderPlatform))</span><br><span class="line">		&#123;</span><br><span class="line">			Library = <span class="built_in">RHICreateShaderLibrary</span>(InShaderPlatform, ShaderCodeDir, InLibraryName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!Library)</span><br><span class="line">		&#123;</span><br><span class="line">          	<span class="type">const</span> FName PlatformName = <span class="built_in">LegacyShaderPlatformToShaderFormat</span>(InShaderPlatform);</span><br><span class="line">			<span class="type">const</span> FString DestFilePath = <span class="built_in">GetCodeArchiveFilename</span>(ShaderCodeDir, InLibraryName, PlatformName);</span><br><span class="line">			<span class="function">TUniquePtr&lt;FArchive&gt; <span class="title">Ar</span><span class="params">(IFileManager::Get().CreateFileReader(*DestFilePath))</span></span>;</span><br><span class="line">          	<span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Thus, regardless of the type of shader library within the base package, the shader update method can be employed.</p>
<blockquote>
<p>There is a necessary point to note when loading Native Metal Shader: the names of <code>metallib</code>/<code>metalmap</code> files must be all lowercase, or else loading will fail. Native Shader Libraries packaged by HotPatcher have this processed.</p>
</blockquote>
<p>I created a test environment where both Native and ushaderbytecode can be loaded properly:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211030172750.jpg"><br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211030173043.jpg" alt="Loaded Shader"><br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211030173340.jpg" alt="Unload Shader"></p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>This article has explored the advantages and disadvantages of various methods for hot-updating shaders in UE, and based on <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a> has implemented incremental shader updates without the need for patching, providing a perfect alternative to Shader Patch and Inline Shader Code solutions.</p>
<p>With this functionality, shaders that depend on a specific map or module can be contained within an independent package, allowing the shaders to be decoupled and downloaded as needed without existing fully within the base package.</p>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                The article is finished. If you have any questions, please comment and communicate.
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/15810/" target="_blank">UE Hot Update: Shader update strategy</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2021/09/13 10:24<br/>
             
             <span>Word Count:</span><span class="page-count">11k Words</span><br/>
             
             <span>Link:</span><a href="/posts/15810/" target="_blank" title="UE Hot Update: Shader update strategy">https://en.imzlp.com/posts/15810/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/15810/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/" rel="tag"># 热更新</a>
              <a href="/tags/Shader/" rel="tag"># Shader</a>
              <a href="/tags/InlineShaderCode/" rel="tag"># InlineShaderCode</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/11750/" rel="prev" title="UE Resource Scanning and inspection tool ResScannerUE">
      <i class="fa fa-chevron-left"></i> UE Resource Scanning and inspection tool ResScannerUE
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/25136/" rel="next" title="UE Hot Update: binary patch solution for resources">
      UE Hot Update: binary patch solution for resources <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Shader-Patch"><span class="nav-number">1.</span> <span class="nav-text">Shader Patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Inline-Shader-Code"><span class="nav-number">2.</span> <span class="nav-text">Inline Shader Code</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Better-Way"><span class="nav-number">3.</span> <span class="nav-text">Better Way</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook-Shader-Format"><span class="nav-number">4.</span> <span class="nav-text">Cook Shader Format</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows"><span class="nav-number">4.1.</span> <span class="nav-text">Windows</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Android"><span class="nav-number">4.2.</span> <span class="nav-text">Android</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iOS"><span class="nav-number">4.3.</span> <span class="nav-text">iOS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Native-Metal-Shader"><span class="nav-number">5.</span> <span class="nav-text">Native Metal Shader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#End"><span class="nav-number">6.</span> <span class="nav-text">End</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/15810/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
