<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="Smart pointers, as one of the most important features of C++11, were originally recorded in C++11 Syntactic Sugar, but this part is so important that I have recently been relatively free (逃) and decid">
<meta property="og:type" content="article">
<meta property="og:title" content="Dynamic memory and smart pointers">
<meta property="og:url" content="https://en.imzlp.com/posts/4280/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="Smart pointers, as one of the most important features of C++11, were originally recorded in C++11 Syntactic Sugar, but this part is so important that I have recently been relatively free (逃) and decid">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/4280/01.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/4280/02.webp">
<meta property="article:published_time" content="2016-08-25T08:18:53.000Z">
<meta property="article:modified_time" content="2016-08-25T08:18:53.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="编程笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/4280/01.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/4280/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Dynamic memory and smart pointers | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/4280/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Dynamic memory and smart pointers<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2016-08-25-4280.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/4280/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        
          <div class="post-subtitle" style="text-align: center;line-height: 1;">
            <sub text-align="center" style="font-size: 15px;align-content: center;font-style: italic;bottom: 0em;">动态内存和智能指针</sub>
          </div>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-25 08:18 08:18:53:18" itemprop="dateCreated datePublished" datetime="2016-08-25T08:18:53+00:00">2016-08-25 08:18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
                </span>
            </span>

          
            <span id="/posts/4280/" class="post-meta-item leancloud_visitors" data-flag-title="Dynamic memory and smart pointers" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>24 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Smart pointers, as one of the most important features of C++11, were originally recorded in <a target="_blank" rel="noopener" href="https://imzlp.com/2016/05/12/cpp11-new-features/">C++11 Syntactic Sugar</a>, but this part is so important that I have recently been relatively free (逃) and decided to summarize it in detail separately. </p>
<span id="more"></span>
<p>In C, dynamic memory allocation and deallocation are achieved through <code>malloc</code> and <code>free</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">malloc</span><span class="params">( <span class="type">size_t</span> size )</span></span>;</span><br></pre></td></tr></table></figure>

<p>We can allocate a contiguous block of memory for our use:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> *p1 = <span class="built_in">malloc</span>(<span class="number">4</span>*<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> n=<span class="number">0</span>; n&lt;<span class="number">4</span>; ++n)&#123; <span class="comment">// populate the array</span></span><br><span class="line">	p1[n] = n*n;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;p1[%d] == %d\n&quot;</span>, n, p1[n]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Output results</span></span><br><span class="line">p1[<span class="number">0</span>] == <span class="number">0</span></span><br><span class="line">p1[<span class="number">1</span>] == <span class="number">1</span></span><br><span class="line">p1[<span class="number">2</span>] == <span class="number">4</span></span><br><span class="line">p1[<span class="number">3</span>] == <span class="number">9</span></span><br></pre></td></tr></table></figure>

<p>In C++, dynamic memory management is done through another pair of operators: <code>new</code> allocates space for an object in dynamic memory and returns a pointer to that object, allowing us to optionally initialize the object; <code>delete</code> takes a pointer to a dynamic object, destroys that object, and frees the associated memory.</p>
<p>The following code demonstrates this:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use new to create a string object and assign it to a string pointer</span></span><br><span class="line">string *testNew=<span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line">cout&lt;&lt;testNew&lt;&lt;<span class="string">&quot;\t&quot;</span>&lt;&lt;*testNew&lt;&lt;endl;</span><br><span class="line"><span class="comment">// delete the previously created object (the object pointed to by testNew)</span></span><br><span class="line"><span class="built_in">delete</span>(testNew);</span><br><span class="line">cout&lt;&lt;testNew&lt;&lt;<span class="string">&quot;\t&quot;</span>&lt;&lt;*testNew&lt;&lt;endl;</span><br><span class="line">testNew=<span class="literal">nullptr</span>;</span><br><span class="line"><span class="comment">// Set dynamic object to nullptr</span></span><br><span class="line">cout&lt;&lt;testNew&lt;&lt;<span class="string">&quot;\t&quot;</span>&lt;&lt;*testNew&lt;&lt;endl;</span><br></pre></td></tr></table></figure>

<p>As seen in the output, the data stored in the location pointed to by testNew before and after the delete operation (on Windows):</p>
<p> <img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/4280/01.webp"></p>
<p>The value stored at the memory address pointed to after releasing with delete (<strong>Dangling Pointer: a pointer that points to a block of memory that once held a data object but is now invalid</strong>) is undefined.</p>
<p>On Linux, compiling and running this would result in <strong>Segmentation fault (core dumped)</strong>.</p>
<p> <img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/4280/02.webp"></p>
<p>Therefore, when we use delete to release a dynamic object, it is best to immediately set it to <a target="_blank" rel="noopener" href="http://en.cppreference.com/w/cpp/language/nullptr">nullptr</a> (null pointer).</p>
<p>As you can see, when using new/delete to manually manage memory, it is essential to remember that new/delete must appear in pairs to avoid creating a dynamic object with new without subsequently deleting it, resulting in memory leaks.</p>
<p>You can also check out my two blog posts discussing issues related to new/delete:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://imzlp.com/2016/06/04/delete-the-void-pointer-memory-leaks/">Memory leaks caused by deleting void* pointers</a></li>
<li><a target="_blank" rel="noopener" href="https://imzlp.com/2016/05/08/STL-release-the-pointer-element-causes-a-memory-leak/">Memory leaks caused by STL releasing pointer elements</a></li>
</ol>
<p>Using dynamic memory is very prone to issues, as ensuring memory is released at the correct time is not easy. Sometimes we forget to release memory, causing <strong>memory leaks</strong>; at other times, we release it while still having pointers referencing that memory, leading to illegal memory references (<strong>dangling pointers</strong>).</p>
<p>Fortunately, to use dynamic memory more safely, C++11 introduced a new feature—<strong>smart pointers</strong>.</p>
<p>C++11 provides two types of <strong>smart pointers</strong> (<code>shared_ptr</code> and <code>unique_ptr</code>) to manage dynamic objects. <strong>Smart pointers</strong> behave similarly to conventional pointers (raw pointers), with the most important difference being that smart pointers can <strong>automatically release the object they point to</strong>.</p>
<p>The two types of smart pointers provided by C++11 differ in how they manage underlying pointers:</p>
<p><strong>shared_ptr</strong> allows multiple pointers to point to the same object.<br><strong>unique_ptr</strong>, on the other hand, exclusively owns the pointed-to object.</p>
<p>The standard library also defines a <strong>companion class</strong>—<code>weak_ptr</code>, which is a weak reference pointing to the object managed by shared_ptr.</p>
<blockquote>
<p>Note: These three types are all defined in memory.</p>
</blockquote>
<h3 id="shared-ptr-Class"><a href="#shared-ptr-Class" class="headerlink" title="shared_ptr Class"></a>shared_ptr Class</h3><p>Similar to <code>vector</code> / <code>string</code> / <code>list</code> / <code>deque</code> that we have come across earlier, smart pointers are also templates. Therefore, when we create a smart pointer, we must provide additional definitions—the type the pointer can point to. Like with vectors, we specify the type inside angle brackets, followed by the name of the defined smart pointer.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr can point to string</span></span><br><span class="line">shared_ptr&lt;string&gt; strp;</span><br><span class="line"><span class="comment">// shared_ptr can point to a vector of strings</span></span><br><span class="line">shared_ptr&lt;vector&lt;string&gt;&gt; vecStrp;</span><br></pre></td></tr></table></figure>

<p><strong>The default initialized smart pointer holds a null pointer (nullptr)</strong></p>
<p>The usage of smart pointers is similar to that of ordinary pointers. <strong>Dereferencing</strong> a smart pointer returns the object it points to. If a smart pointer is used in a conditional check, it effectively checks whether it is null.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shared_ptr&lt;string&gt; strp=<span class="built_in">make_shared</span>&lt;string&gt;();</span><br><span class="line"><span class="comment">// If strp is not null, check whether it points to an empty string</span></span><br><span class="line"><span class="keyword">if</span>(strp&amp;&amp;strp-&gt;<span class="built_in">empty</span>())&#123;</span><br><span class="line">  	<span class="comment">// If strp points to an empty string, dereference strp and assign a new value to the string object pointed to by strp</span></span><br><span class="line">  	*strp=<span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">cout&lt;&lt;*strp&lt;&lt;endl;</span><br><span class="line"><span class="comment">// The result is helloworld</span></span><br></pre></td></tr></table></figure>

<p><strong>Operations supported by both shared_ptr and unique_ptr.</strong></p>
<table>
<thead>
<tr>
<th align="center">Operation</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td align="center">shared_ptr&lt;T&gt; sp;</p>unique_ptr&lt;T&gt; up;</td>
<td>An empty smart pointer that can point to an object of type T</td>
</tr>
<tr>
<td align="center">p</td>
<td>Uses p as a condition check; if p points to an object, this evaluates to true</td>
</tr>
<tr>
<td align="center">*p</td>
<td>Dereference p to obtain the object it points to</td>
</tr>
<tr>
<td align="center">p-&gt;mem</td>
<td>Equivalent to (*p).mem</td>
</tr>
<tr>
<td align="center">p.get()</td>
<td>Returns the pointer stored in p; use with caution—if the smart pointer releases its object, the returned pointer will also disappear (becoming a dangling pointer)</td>
</tr>
<tr>
<td align="center">swap(p,q)</p>p.swap(q)</td>
<td>Swaps the pointers in p and q</td>
</tr>
</tbody></table>
<p><strong>Operations unique to shared_ptr</strong></p>
<table>
<thead>
<tr>
<th align="center">Operation</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td align="center">make_shared&lt;T&gt; (<em>args</em>)</td>
<td>Returns a shared_ptr pointing to a dynamically allocated object of type T. The object is initialized using args.</td>
</tr>
<tr>
<td align="center">shared_ptr&lt;T&gt; p(q)</td>
<td>p is a copy of shared_ptr q; this operation increments the counter in q. The pointer in q must be convertible to T* (for more details, refer to <a target="_blank" rel="noopener" href="https://imzlp.com/2016/05/04/type-convert-in-cpp/#%E5%88%B6%E6%8C%87%E9%92%88%E7%9A%84%E8%BD%AC%E6%8D%A2">A Detailed Analysis of Pointer Conversion in C++</a>)</td>
</tr>
<tr>
<td align="center">p=q</td>
<td>Both p and q are shared_ptr; your pointers must be convertible to each other. This operation decrements p’s reference count and increments q’s; if p’s reference count becomes 0, the original memory it managed will be released.</td>
</tr>
<tr>
<td align="center">p.unique()</td>
<td>Returns true if p.use_count() is 1; otherwise returns false</td>
</tr>
<tr>
<td align="center">p.use_count()</td>
<td>Returns the number of smart pointers that share the object with p; it can be slow and is mainly used for debugging</td>
</tr>
</tbody></table>
<p>We can also implement a simple class similar to <code>shared_ptr</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">smartPoint</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">smartPoint</span>():<span class="built_in">ObjectPoint</span>(<span class="literal">nullptr</span>),<span class="built_in">use_count</span>(<span class="keyword">new</span> <span class="built_in">size_t</span>(<span class="number">1</span>))&#123;&#125;</span><br><span class="line">	<span class="built_in">smartPoint</span>(T *i):<span class="built_in">ObjectPoint</span>(i),<span class="built_in">use_count</span>(<span class="keyword">new</span> <span class="built_in">size_t</span>(<span class="number">1</span>))&#123;&#125;</span><br><span class="line">	<span class="built_in">smartPoint</span>(<span class="type">const</span> smartPoint &amp;i):<span class="built_in">ObjectPoint</span>(i.ObjectPoint),<span class="built_in">use_count</span>(i.use_count)&#123;++*use_count;&#125;</span><br><span class="line">	~<span class="built_in">smartPoint</span>()&#123;<span class="built_in">decr_use</span>();&#125;</span><br><span class="line"></span><br><span class="line">	smartPoint&amp; <span class="keyword">operator</span>=(<span class="type">const</span> T &amp;rhs)&#123;</span><br><span class="line">		++*rhs.use_count;</span><br><span class="line">		<span class="built_in">decr_use</span>();</span><br><span class="line">		ObjectPoint=rhs.ObjectPoint;</span><br><span class="line">		use_count=rhs.use_count;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> T* <span class="keyword">operator</span>-&gt;() <span class="type">const</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(ObjectPoint)</span><br><span class="line">			<span class="keyword">return</span> ObjectPoint;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> T&amp; <span class="keyword">operator</span>*() <span class="type">const</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(ObjectPoint)</span><br><span class="line">			<span class="keyword">return</span> *ObjectPoint;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">size_t</span> <span class="title">count</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> *use_count;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	T *ObjectPoint;</span><br><span class="line">	<span class="type">size_t</span> *use_count;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">decr_use</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(--*use_count==<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">delete</span> ObjectPoint;</span><br><span class="line">			<span class="keyword">delete</span> use_count;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>The above implements only simple reference counting and provides the <code>smartPointer::count()</code> member function to get the number of references to the pointed object.</p>
<p>Here’s a simple test code:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">test</span>&#123;</span><br><span class="line">	<span class="built_in">test</span>()&#123;cout&lt;&lt;<span class="string">&quot;construction&quot;</span>&lt;&lt;endl;&#125;</span><br><span class="line">	~<span class="built_in">test</span>()&#123;cout&lt;&lt;<span class="string">&quot;destruction&quot;</span>&lt;&lt;endl;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">smartPoint&lt;test&gt; <span class="title">funa</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	smartPoint&lt;test&gt; strp=<span class="keyword">new</span> <span class="built_in">test</span>();</span><br><span class="line">  	<span class="comment">// Use strp</span></span><br><span class="line">  	<span class="comment">// When we return strp, the reference count is incremented</span></span><br><span class="line">	<span class="keyword">return</span> strp;</span><br><span class="line">&#125;<span class="comment">// strp leaves the scope but the memory it points to will not be released</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">funb</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	<span class="function">smartPoint&lt;test&gt; <span class="title">strp</span><span class="params">(<span class="keyword">new</span> test())</span></span>;</span><br><span class="line">  	<span class="comment">// Use strp</span></span><br><span class="line">  	<span class="comment">// strp leaves the scope, and the reference count will be decremented, so strp will be automatically released.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> x=<span class="built_in">funa</span>();</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;--------&quot;</span>&lt;&lt;endl;</span><br><span class="line">	<span class="built_in">funb</span>();</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;--------&quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Output results</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">construction	(1)</span></span><br><span class="line"><span class="comment">------------</span></span><br><span class="line"><span class="comment">construction	(2)</span></span><br><span class="line"><span class="comment">destruction	(3)</span></span><br><span class="line"><span class="comment">------------</span></span><br><span class="line"><span class="comment">destruction	(4)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 1. The object created in funa; 4. The object created in funa is destroyed when it leaves the main function&#x27;s scope (X)</span></span><br><span class="line"><span class="comment">// 2. The object created in funb; 3. The object created in funb is destroyed when leaving the funb scope.</span></span><br></pre></td></tr></table></figure>

<h4 id="make-shared-Function"><a href="#make-shared-Function" class="headerlink" title="make_shared Function"></a>make_shared Function</h4><p>The safest way to allocate and use dynamic memory is to call a standard library function called <code>make_shared</code>.</p>
<p>This function allocates an object in dynamic memory, initializes it, and returns a <code>shared_ptr</code> pointing to this object. Like smart pointers, <code>make_shared</code> is also defined in the <code>memory</code> header.</p>
<p>When using <code>make_shared</code>, you must specify the type of the object to create. The definition is similar to templates, following the function name with angle brackets, in which you provide the type.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Points to an int initialized with a value of 0</span></span><br><span class="line">shared_ptr&lt;<span class="type">int</span>&gt; ivalp1=<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line"><span class="comment">// Points to an int with a value of 42</span></span><br><span class="line">shared_ptr&lt;<span class="type">int</span>&gt; ivalp2=<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;(<span class="number">42</span>);</span><br><span class="line"><span class="comment">// Points to a string with the value &quot;HelloWorld&quot;</span></span><br><span class="line">shared_ptr&lt;string&gt; strvalp=<span class="built_in">make_shared</span>&lt;string&gt;(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line"><span class="comment">// Points to a string with the value &quot;9999999999&quot;</span></span><br><span class="line">shared_ptr&lt;string&gt; strvalp=<span class="built_in">make_shared</span>&lt;string&gt;(<span class="number">10</span>,<span class="string">&#x27;9&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>Similar to the <code>emplace</code> member of <code>sequence containers</code> (which directly calls the constructor of the element type to construct elements in the container, for detailed information refer to <a target="_blank" rel="noopener" href="https://imzlp.com/2016/05/12/cpp11-new-features/#emplace%E6%93%8D%E4%BD%9C">C++11 Syntactic Sugar: emplace Operation</a>), <code>make_shared</code> uses its parameters to construct an object of the given type.</p>
<p>For example:</p>
<ol>
<li>The parameters passed when calling <code>make_shared&lt;string&gt;</code> must match one of the constructors for string.</li>
<li>The parameters passed when calling <code>make_shared&lt;int&gt;</code> must be able to initialize an int, and so on.</li>
<li>If we do not pass any parameters, the object will be <strong>value-initialized</strong>.</li>
</ol>
<p>We can also use <a target="_blank" rel="noopener" href="https://imzlp.com/2016/05/12/cpp11-new-features/#auto%E7%B1%BB%E5%9E%8B%E8%AF%B4%E6%98%8E%E7%AC%A6">auto</a> to define an object that holds the result of <code>make_shared</code> (i.e., the smart pointer object), which is a simpler method compared to the previous ones:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// strp points to a dynamically allocated empty vector&lt;string&gt;</span></span><br><span class="line"><span class="keyword">auto</span> strp=make_shared&lt;vector&lt;string&gt;&gt;();</span><br></pre></td></tr></table></figure>

<h4 id="Copying-and-Assigning-shared-ptr"><a href="#Copying-and-Assigning-shared-ptr" class="headerlink" title="Copying and Assigning shared_ptr"></a>Copying and Assigning shared_ptr</h4><p>When a copy or assignment operation is performed, each shared_ptr records how many other shared_ptrs point to the same object.</p>
<p>As mentioned in the previous table, we can call the <code>use_count</code> member function of <code>shared_ptr</code> to get the number of smart pointers sharing the object.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The object pointed to by p has only one reference</span></span><br><span class="line"><span class="keyword">auto</span> p=<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;(<span class="number">42</span>);</span><br><span class="line">cout&lt;&lt;p.<span class="built_in">use_count</span>()&lt;&lt;<span class="string">&quot; &quot;</span>;</span><br><span class="line"><span class="comment">// p and q point to the same object, which has two references</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">q</span><span class="params">(p)</span></span>;</span><br><span class="line">cout&lt;&lt;p.<span class="built_in">use_count</span>()&lt;&lt;endl;</span><br><span class="line"><span class="comment">// The output results are 1 2</span></span><br></pre></td></tr></table></figure>

<p>Each <code>shared_ptr</code> can be thought of as having an associated counter, commonly referred to as the <strong>reference count</strong>. Whenever we copy a shared_ptr, the counter gets incremented.</p>
<p>For example:</p>
<ol>
<li><p>When one shared_ptr is initialized with another shared_ptr.</p>
</li>
<li><p>When a shared_ptr is passed as a parameter to a function.</p>
</li>
<li><p>When it is the return value of a function.</p>
</li>
</ol>
<p>The associated counter will increment.</p>
<p>When we</p>
<ol>
<li>Assign a new value to <code>shared_ptr</code></li>
<li>The <code>shared_ptr</code> is destroyed (e.g., a local <code>shared_ptr</code> leaves its scope)</li>
</ol>
<p>the counter will decrement.</p>
<p><strong>Once a shared_ptr’s</strong> counter becomes 0, it will automatically release the object it manages.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">test</span>&#123;</span><br><span class="line">	<span class="built_in">test</span>()&#123;cout&lt;&lt;<span class="string">&quot;construction&quot;</span>&lt;&lt;endl;&#125;</span><br><span class="line">	~<span class="built_in">test</span>()&#123;cout&lt;&lt;<span class="string">&quot;destruction&quot;</span>&lt;&lt;endl;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The following code</span></span><br><span class="line"><span class="keyword">auto</span> r=<span class="built_in">make_shared</span>&lt;test&gt;();</span><br><span class="line">r=<span class="built_in">make_shared</span>&lt;test&gt;();</span><br><span class="line"><span class="comment">// The output results</span></span><br><span class="line">construction</span><br><span class="line">construction</span><br><span class="line">destruction</span><br><span class="line">destruction</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">The order is:</span></span><br><span class="line"><span class="comment">  1. Create a shared_ptr that can point to a test type object (value initialization) and assign it to r, assuming r points to A</span></span><br><span class="line"><span class="comment">  2. Create another shared_ptr that can point to a test type object (value initialization) and reassign it to r, assuming r points to B</span></span><br><span class="line"><span class="comment">  3. After r is reassigned to point to B, the destructor for A (test) is called to release A</span></span><br><span class="line"><span class="comment">  4. At the end of the program, the destructor for B (test) is called to release B</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: Whether to use a counter or another data structure to record how many pointers share the object is entirely up to the specific implementation of the standard library. The key is that smart pointers can record how many shared_ptrs point to the same object and can release them at the appropriate time.</p>
</blockquote>
<h4 id="Automatic-Destruction-of-Objects-Managed-by-shared-ptr"><a href="#Automatic-Destruction-of-Objects-Managed-by-shared-ptr" class="headerlink" title="Automatic Destruction of Objects Managed by shared_ptr"></a>Automatic Destruction of Objects Managed by shared_ptr</h4><p>Like all defined local variables, local objects are destroyed when they leave their scope.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> ival;</span><br><span class="line">&#125;<span class="comment">// When leaving the scope of func, local variables defined within it will be destroyed</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Smart pointers behave similarly, but when they leave their scope or are assigned a new value, they decrement the object’s internal reference count, and only when the count reaches 0 does the object pointed to by the smart pointer get destroyed.<br>We can see the order of decrementing the reference count and destroying objects with the following code:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">smartPoint&lt;test&gt; <span class="title">funa</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	smartPoint&lt;test&gt; val=<span class="keyword">new</span> <span class="built_in">test</span>();</span><br><span class="line">	<span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">funb</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;run funa before.&quot;</span>&lt;&lt;endl;</span><br><span class="line">	smartPoint&lt;test&gt; temp=<span class="built_in">funa</span>();</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;run funa after.&quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;run funb before&quot;</span>&lt;&lt;endl;</span><br><span class="line">	<span class="built_in">funb</span>();</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;run funb after.&quot;</span>&lt;&lt;endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output results</span></span><br><span class="line">run funb before</span><br><span class="line">run funa before.</span><br><span class="line">construction</span><br><span class="line">run funa after.</span><br><span class="line">destruction</span><br><span class="line">run funb after.</span><br></pre></td></tr></table></figure>
<p>As seen, we call funa in funb, where a smart pointer is created in funa that points to an instance of the test object, and we return this smart pointer to the invocation site of funb. Upon returning, the reference count of the smart pointer created in funa increments (the return is actually a copy constructor creating a new object as a value pass. If you’re interested, you can try returning from funa without receiving (using) that return value at the invocation site to see when the dynamic object created in funa gets destroyed) and then decrements (when leaving the funa scope), so the object pointed to by the smart pointer will not be destroyed when leaving the funa scope. But subsequently, when leaving the funb scope, the smart pointer is destroyed along with the dynamic memory object it points to (because the reference count decrements to 0 when leaving the funb scope, thus calling the destructor of the object pointed to by the smart pointer to release that object).</p>
<p>When the last <code>shared_ptr</code> pointing to an object is destroyed, the shared_ptr class will automatically destroy this object. It does this through a special member function—the <strong>destructor</strong>. Similar to constructors, every class has a destructor. As constructors control initialization, destructors control what actions to take when an object of this type is destroyed.</p>
<p><strong>The destructor of shared_ptr</strong> will decrement the reference count of the object it points to. If the reference count drops to 0, the shared_ptr’s destructor will destroy the object and free the memory it occupied.</p>
<p>When dynamic objects are no longer needed, <code>shared_ptr</code> will automatically release them, making <strong>dynamic memory</strong> usage very easy, as we don’t always have to remember when we created (new) a dynamic object and have yet to release (delete) it.</p>
<p><strong>The destructor of shared_ptr</strong> will decrement the reference count of the object it points to. If the reference count drops to 0, the shared_ptr’s destructor will destroy the object and free the memory it occupied.</p>
<blockquote>
<p>If you store a <code>shared_ptr</code> in a container and later no longer need all of the elements while only using some, remember to use <code>erase</code> to delete those elements you no longer need.</p>
</blockquote>
<h4 id="Classes-Using-Dynamic-Memory-for-Resource-Generation"><a href="#Classes-Using-Dynamic-Memory-for-Resource-Generation" class="headerlink" title="Classes Using Dynamic Memory for Resource Generation"></a>Classes Using Dynamic Memory for Resource Generation</h4><p>Programs use dynamic memory for one of the following reasons:</p>
<ol>
<li>The program does not know how many objects it needs.</li>
<li>The program does not know the exact type of the required objects.</li>
<li>The program needs to share data among multiple objects.</li>
</ol>
<p><code>Container classes</code> are a typical example of using dynamic memory for the first reason.</p>
<p>In the example below, we will define a class that uses dynamic memory to allow multiple objects to share the same underlying data.</p>
<p>The containers we often use (<code>vector</code> / <code>string</code> / <code>map</code> / <code>set</code> / <code>deque</code> / <code>list</code>) allocate resources that have the same lifetime as the object.</p>
<p>For instance, each <code>vector</code> object contains its own elements. When we copy a <code>vector</code>, the elements of the original vector and the new copy are separated.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;string&gt; v1;</span><br><span class="line">&#123;<span class="comment">// New scope</span></span><br><span class="line">	vector&lt;string&gt; v2=&#123;<span class="string">&quot;a&quot;</span>,<span class="string">&quot;an&quot;</span>,<span class="string">&quot;the&quot;</span>&#125;;</span><br><span class="line">  	v1=v2;</span><br><span class="line">&#125;<span class="comment">// v2 is destroyed, and the elements within it are also destroyed</span></span><br><span class="line"><span class="comment">// v1 contains three elements, which are copies of the original elements from v2</span></span><br></pre></td></tr></table></figure>

<p>Elements allocated from a vector only exist while the vector is present. When a vector is destroyed, the elements within that vector also get destroyed.</p>
<p>However, certain classes allocate resources that have a lifetime independent of their original objects. Generally, if two objects share underlying data, we cannot unilaterally destroy the underlying data when one of the objects is destroyed:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Blob&lt;string&gt; b1;</span><br><span class="line">&#123;</span><br><span class="line">  	Blob&lt;string&gt; b2=&#123;<span class="string">&quot;a&quot;</span>,<span class="string">&quot;an&quot;</span>,<span class="string">&quot;the&quot;</span>&#125;;</span><br><span class="line">	b1=b2;</span><br><span class="line">&#125;<span class="comment">// b2 is destroyed</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                The article is finished. If you have any questions, please comment and communicate.
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/4280/" target="_blank">Dynamic memory and smart pointers</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2016/08/25 08:18<br/>
             
             <span>Word Count:</span><span class="page-count">9.6k Words</span><br/>
             
             <span>Link:</span><a href="/posts/4280/" target="_blank" title="Dynamic memory and smart pointers">https://en.imzlp.com/posts/4280/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/4280/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" rel="tag"># 编程笔记</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/33213/" rel="prev" title="Reading CSAPP: Comparison with Modern Operating Systems">
      <i class="fa fa-chevron-left"></i> Reading CSAPP: Comparison with Modern Operating Systems
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/42068/" rel="next" title="Source Insight plugin and configuration">
      Source Insight plugin and configuration <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#shared-ptr-Class"><span class="nav-number">1.</span> <span class="nav-text">shared_ptr Class</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#make-shared-Function"><span class="nav-number">1.1.</span> <span class="nav-text">make_shared Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Copying-and-Assigning-shared-ptr"><span class="nav-number">1.2.</span> <span class="nav-text">Copying and Assigning shared_ptr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Automatic-Destruction-of-Objects-Managed-by-shared-ptr"><span class="nav-number">1.3.</span> <span class="nav-text">Automatic Destruction of Objects Managed by shared_ptr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Classes-Using-Dynamic-Memory-for-Resource-Generation"><span class="nav-number">1.4.</span> <span class="nav-text">Classes Using Dynamic Memory for Resource Generation</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/4280/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
