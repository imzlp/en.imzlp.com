<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="By default, when packaging a project in UE, BuildCookRun is invoked to execute a series of processes such as Compile&#x2F;Cook&#x2F;Pak&#x2F;Stage. In UE, only the assets involved in Cook will be packaged; however,">
<meta property="og:type" content="article">
<meta property="og:title" content="UE Resource Management: Engine Packaging Resource Analysis">
<meta property="og:url" content="https://en.imzlp.com/posts/22570/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="By default, when packaging a project in UE, BuildCookRun is invoked to execute a series of processes such as Compile&#x2F;Cook&#x2F;Pak&#x2F;Stage. In UE, only the assets involved in Cook will be packaged; however,">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2022/202302051818482.webp">
<meta property="article:published_time" content="2021-12-31T14:33:25.000Z">
<meta property="article:modified_time" content="2021-12-31T14:33:25.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="热更新">
<meta property="article:tag" content="资源管理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2022/202302051818482.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/22570/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>UE Resource Management: Engine Packaging Resource Analysis | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/22570/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          UE Resource Management: Engine Packaging Resource Analysis<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2021-12-31-22570.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/22570/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        
          <div class="post-subtitle" style="text-align: center;line-height: 1;">
            <sub text-align="center" style="font-size: 15px;align-content: center;font-style: italic;bottom: 0em;">UE资源管理：引擎打包资源分析</sub>
          </div>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-31 14:33 14:33:25:33" itemprop="dateCreated datePublished" datetime="2021-12-31T14:33:25+00:00">2021-12-31 14:33</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/" itemprop="url" rel="index"><span itemprop="name">UnrealEngine</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">资源管理</span></a>
                </span>
            </span>

          
            <span id="/posts/22570/" class="post-meta-item leancloud_visitors" data-flag-title="UE Resource Management: Engine Packaging Resource Analysis" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>24 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>By default, when packaging a project in UE, BuildCookRun is invoked to execute a series of processes such as Compile/Cook/Pak/Stage. In UE, only the assets involved in Cook will be packaged; however, it often includes many unexpected assets, which can be perplexing. What resources does the engine depend on? And how should we manage the resources involved in packaging in UE?</p>
<p>This article starts with analyzing the rules for resource Cook during UE packaging, studying which resources will actually be Cooked, which is beneficial for resource management. Based on this understanding, a custom Cook process can be implemented, distributing Cook tasks to different processes or even machines to achieve parallelization and accelerate the UE build process.</p>
<p>In addition to resources like uasset, there are many Non-Asset files during packaging, such as ini, Shader Library, AssetRegistry, or script files added to the project, etc. These have been introduced in a previous article <a target="_blank" rel="noopener" href="https://imzlp.com/posts/17371/">UE Hot Update: Demand Analysis and Solution Design</a>. UE’s collection of these <strong>resources</strong> does not occur during the Cook phase (Shader Library and AssetRegistry are generated during the Cook phase), which will not be discussed further in this article, but a dedicated article will be written later on.</p>
<span id="more"></span>

<p>The resources involved in Cook in UE can be logically divided into the following categories:</p>
<ol>
<li>Key resources configured in project settings, such as StartupMap, GameMode, GameInstance, DefaultTouchInterface, etc., which are essential resources.</li>
<li>Several UI directories packaged by default.</li>
<li>Resources loaded via code during engine startup.</li>
<li>Cook resources configured in project settings (including resources marked with <code>Directory to Always Cook</code>, <code>PrimaryAssetLabel</code>, etc.).</li>
<li>Resources passed to CookOnTheFlyServer via <code>FGameDelegates::Get().GetCookModificationDelegate()</code>.</li>
<li>If no specific resources are specified under certain conditions, resources in project and plugin directories are analyzed.</li>
<li>Localized resources (UE supports different resources for different cultures, though it is not commonly used).</li>
</ol>
<p>The resource analysis process in UE is very complex and scattered across various places, and it contains various condition checks. Analyzing the project’s dependent resources accurately is quite inconvenient. This is why it is challenging to ascertain precisely what resources are packaged by UE.</p>
<p>Based on these pain points, I plan to implement a concise and standardized resource collection and packaging process based on HotPatcher. Essentially, the goal is to package the necessary resources that the engine and application need at runtime. This fundamental need leads to the complexity of resource configuration and detection in UE, but we can simplify it for unified analysis and management.</p>
<h3 id="CookCommandlet"><a href="#CookCommandlet" class="headerlink" title="CookCommandlet"></a>CookCommandlet</h3><p>The engine provides UCookCommandlet to implement resource Cook, and during the packaging process, it is invoked by UAT. The default Cook command is as follows:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">D:/UnrealEngine/Engine/Engine/Binaries/Win64/UE4Editor-Cmd.exe</span><br><span class="line">D:/UnrealProjects/Blank425/Blank425.uproject</span><br><span class="line">-run=Cook</span><br><span class="line">-TargetPlatform=WindowsNoEditor</span><br><span class="line">-fileopenlog</span><br><span class="line">-unversioned</span><br><span class="line">-abslog=D:/UnrealEngine/Engine/Engine/Programs/AutomationTool/Saved/Cook-2021.12.07-15.47.10.txt</span><br><span class="line">-stdout</span><br><span class="line">-CrashForUAT</span><br><span class="line">-unattended</span><br><span class="line">-NoLogTimes</span><br><span class="line">-UTF8Output</span><br></pre></td></tr></table></figure>

<p>It executes to the main function of <code>UCookCommandlet</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Source\Editor\UnrealEd\Private\Commandlets\CookCommandlet.cpp</span><br><span class="line"><span class="comment">/* UCommandlet interface</span></span><br><span class="line"><span class="comment"> *****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function">int32 <span class="title">UCookCommandlet::Main</span><span class="params">(<span class="type">const</span> FString&amp; CmdLineParams)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">COOK_STAT</span>(<span class="type">double</span> CookStartTime = FPlatformTime::<span class="built_in">Seconds</span>());</span><br><span class="line">  Params = CmdLineParams;</span><br><span class="line">  <span class="built_in">ParseCommandLine</span>(*Params, Tokens, Switches);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After some parameter checks, it passes the execution flow to <code>CookByTheBook</code>, creates <code>CookOnTheFlyServer</code>, and calls <code>StartCookByTheBook</code>.</p>
<p>All resources during the engine’s packaging are Cooked in <code>CookOnTheFlyServer</code>, generating Shader and AssetRegistry. It can be said that <code>CookOnTheFlyServer</code> is the process in which UE packages assets in a common format in the editor, serializing them to platform format.</p>
<h3 id="Resource-Analysis"><a href="#Resource-Analysis" class="headerlink" title="Resource Analysis"></a>Resource Analysis</h3><blockquote>
<p>The thought process behind resource loading during UE packaging is as follows: first, find the local uasset files, convert the paths to PackageName, load them; while loading, dependent resources are also loaded and cooked together.</p>
</blockquote>
<h4 id="StartupPackages"><a href="#StartupPackages" class="headerlink" title="StartupPackages"></a>StartupPackages</h4><p>In <code>CookOnTheFlyServer.cpp</code>, the resources already loaded into memory are added to <code>CookByTheBookOptions-&gt;StartupPackages</code>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201143900.webp"></p>
<p><code>CookOnTheFlyServer</code> will subsequently add them to the Cook list and handle redirectors.</p>
<h4 id="AllMaps"><a href="#AllMaps" class="headerlink" title="AllMaps"></a>AllMaps</h4><p>If no maps are specified via the command line, <code>AllMaps</code> will be added to <code>MapIniSections</code>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201145609.webp"><br>It is a section in <code>DefaultEditor.ini</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DefaultEngine.ini</span><br><span class="line"><span class="section">[AllMaps]</span></span><br><span class="line">+<span class="attr">Map</span>=/Game/Maps/Login</span><br><span class="line">+<span class="attr">Map</span>=/Game/Maps/LightSpeed</span><br><span class="line">+<span class="attr">Map</span>=/Game/Maps/VFXTest</span><br></pre></td></tr></table></figure>

<p>Before starting, a global compilation of <code>GlobalShader</code> occurs:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201150932.webp"></p>
<p>Resources are obtained via <code>GRedirectCollector</code>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201151823.webp"></p>
<h4 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h4><p>By default, UE adds directories under <code>ContentDirectories</code> in <code>BaseEditor.ini</code> to the Cook list: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Config/BaseEditor.ini#L271">Engine/Config/BaseEditor.ini#L271</a></p>
<p>The default configuration in the engine is as follows, and other directories can be added by modifying <code>DefaultEditor.ini</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BaseEditor.ini</span><br><span class="line"><span class="section">[UI]</span></span><br><span class="line"><span class="comment">; Directories specifying assets needed by Slate UI, assets in these directories are always cooked even if not referenced</span></span><br><span class="line">+<span class="attr">ContentDirectories</span>=/Game/UI</span><br><span class="line">+<span class="attr">ContentDirectories</span>=/Game/Widget</span><br><span class="line">+<span class="attr">ContentDirectories</span>=/Game/Widgets</span><br><span class="line">+<span class="attr">ContentDirectories</span>=/Engine/MobileResources</span><br></pre></td></tr></table></figure>
<p>Resources in these directories will be packaged: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5519">CookOnTheFlyServer.cpp#L5519</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@todo SLATE: This is a hack to ensure all slate referenced assets get cooked.</span></span><br><span class="line"><span class="comment">// Slate needs to be refactored to properly identify required assets at cook time.</span></span><br><span class="line"><span class="comment">// Simply jamming everything in a given directory into the cook list is error-prone</span></span><br><span class="line"><span class="comment">// on many levels - assets not required getting cooked/shipped; assets not put under </span></span><br><span class="line"><span class="comment">// the correct folder; etc.</span></span><br><span class="line"><span class="keyword">if</span> ( !(FilesToCookFlags &amp; ECookByTheBookOptions::NoSlatePackages))</span><br><span class="line">&#123;</span><br><span class="line">  TArray&lt;FString&gt; UIContentPaths;</span><br><span class="line">  TSet &lt;FName&gt; ContentDirectoryAssets; </span><br><span class="line">  <span class="keyword">if</span> (GConfig-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UI&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ContentDirectories&quot;</span>), UIContentPaths, GEditorIni) &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (int32 DirIdx = <span class="number">0</span>; DirIdx &lt; UIContentPaths.<span class="built_in">Num</span>(); DirIdx++)</span><br><span class="line">    &#123;</span><br><span class="line">      FString ContentPath = FPackageName::<span class="built_in">LongPackageNameToFilename</span>(UIContentPaths[DirIdx]);</span><br><span class="line"></span><br><span class="line">      TArray&lt;FString&gt; Files;</span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(Files, *ContentPath, *(<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;*&quot;</span>)) + FPackageName::<span class="built_in">GetAssetPackageExtension</span>()), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; Files.<span class="built_in">Num</span>(); Index++)</span><br><span class="line">      &#123;</span><br><span class="line">        FString StdFile = Files[Index];</span><br><span class="line">        FName PackageName = <span class="built_in">FName</span>(*FPackageName::<span class="built_in">FilenameToLongPackageName</span>(StdFile));</span><br><span class="line">        ContentDirectoryAssets.<span class="built_in">Add</span>(PackageName);</span><br><span class="line">        FPaths::<span class="built_in">MakeStandardFilename</span>(StdFile);</span><br><span class="line">        <span class="built_in">AddFileToCook</span>(FilesInPath, StdFile);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CookByTheBookOptions &amp;&amp; CookByTheBookOptions-&gt;bGenerateDependenciesForMaps) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; MapDependencyGraph : CookByTheBookOptions-&gt;MapDependencyGraphs)</span><br><span class="line">    &#123;</span><br><span class="line">      MapDependencyGraph.Value.<span class="built_in">Add</span>(<span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ContentDirectoryAssets&quot;</span>)), ContentDirectoryAssets);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you do not want the resources under the <code>/Game/UI</code> directory to be included during default packaging, you can override this in the project configuration file <code>DefaultEditor.ini</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[UI]</span></span><br><span class="line">!<span class="attr">ContentDirectories</span>=ClearArray</span><br><span class="line">+<span class="attr">ContentDirectories</span>=/Engine/MobileResources</span><br></pre></td></tr></table></figure>

<h4 id="Directory-to-Always-Cook"><a href="#Directory-to-Always-Cook" class="headerlink" title="Directory to Always Cook"></a>Directory to Always Cook</h4><p><code>Project Settings</code>-<code>Directory to Always Cook</code> <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5276">DirectoriesToAlwaysCook</a></p>
<h4 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h4><ul>
<li><p>AlwaysCookMaps <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5223">CookOnTheFlyServer.cpp#L5223</a></p>
</li>
<li><p>MapToCook <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5253">CookOnTheFlyServer.cpp#L5253</a></p>
</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DefaultGame.ini</span><br><span class="line"><span class="section">[/Script/UnrealEd.ProjectPackagingSettings]</span></span><br><span class="line">+<span class="attr">MapsToCook</span>=(FilePath=<span class="string">&quot;/Game/HandheldAR/Maps/HandheldARBlankMap&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Never Cook <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5317">CookOnTheFlyServer.cpp#L5317</a></p>
</li>
<li><p>AllMaps <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5266">CookOnTheFlyServer.cpp#L5266</a></p>
</li>
</ul>
<h4 id="Cultures"><a href="#Cultures" class="headerlink" title="Cultures"></a>Cultures</h4><p>Here it does not refer to multiple languages but to different cultures, allowing for the use of different resources. <a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.27/en-US/ProductionPipelines/Localization/Asset/">Asset Localization</a></p>
<p>Code for obtaining culture resources: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L6714">CookOnTheFlyServer.cpp#L6714</a></p>
<p>Resources are read from project settings:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201145410.webp"></p>
<p>It will traverse all RootPaths, such as <code>/Engine</code>, <code>/Game</code>, and root directories of plugins:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201145945.webp"></p>
<p>For example, resources under the following directory, and will recursively include subdirectories:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Game/L10N/en/</span><br></pre></td></tr></table></figure>

<h4 id="DefaultTouchInterface"><a href="#DefaultTouchInterface" class="headerlink" title="DefaultTouchInterface"></a>DefaultTouchInterface</h4><p>DefaultTouchInterface is a configurable virtual joystick class in the engine. It may not be depended on by other resources, but it still needs to be packaged; hence it’s individually retrieved during Cook:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FConfigFile InputIni;</span><br><span class="line">FString InterfaceFile;</span><br><span class="line">FConfigCacheIni::<span class="built_in">LoadLocalIniFile</span>(InputIni, <span class="built_in">TEXT</span>(<span class="string">&quot;Input&quot;</span>), <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span> (InputIni.<span class="built_in">GetString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/Engine.InputSettings&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;DefaultTouchInterface&quot;</span>), InterfaceFile))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (InterfaceFile != <span class="built_in">TEXT</span>(<span class="string">&quot;None&quot;</span>) &amp;&amp; InterfaceFile != <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    SoftObjectPaths.<span class="built_in">Emplace</span>(InterfaceFile);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="GetCookModificationDelegate"><a href="#GetCookModificationDelegate" class="headerlink" title="GetCookModificationDelegate"></a>GetCookModificationDelegate</h4><p>Binding agents can be passed to CookCommandlet for the files to be Cooked:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// allow the game to fill out the asset registry, as well as get a list of objects to always cook</span></span><br><span class="line">TArray&lt;FString&gt; FilesInPathStrings;</span><br><span class="line">FGameDelegates::<span class="built_in">Get</span>().<span class="built_in">GetCookModificationDelegate</span>().<span class="built_in">ExecuteIfBound</span>(FilesInPathStrings);</span><br></pre></td></tr></table></figure>
<p>Note that the passed resources need to be the absolute paths of uasset files, not resource paths like <code>/Game/xxx</code>.</p>
<h4 id="AssetManager"><a href="#AssetManager" class="headerlink" title="AssetManager"></a>AssetManager</h4><p>Accessing <code>PrimaryAssetTypeInfo</code> through <code>UAssetManager::Get().ModifyCook</code> (configured in project settings, PrimaryAssetLabelId, etc.).</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201152838.webp"></p>
<p>The following two are the ones automatically added in new projects; <code>ModifyCook</code> scans all PrimaryAssetId resources and adds specified resources to PackageToCook. <strong>Note</strong> that only these resources are added.<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211202201208.webp"></p>
<p>If no resources are explicitly specified in the command line, and no resources are obtained from <code>FGameDelegates::Get().GetCookModificationDelegate()</code>, or <code>UAssetManager::Get().Modify</code>, all resources from plugins and the project will be added:</p>
<p>The execution criteria are:</p>
<ol>
<li><code>AlwaysCookMaps</code> in <code>DefaultEditor.ini</code> is empty, <code>AllMaps</code> is empty.</li>
<li><code>List of maps to include in a packaged build</code> in project settings is empty.</li>
<li><code>DirectoriesToAlwaysCook</code> in project settings is empty.</li>
<li>Resources obtained from <code>FGameDelegates::Get().GetCookModificationDelegate()</code> are empty.</li>
<li>Resources obtained from <code>UAssetManager::Get().ModifyCook</code> are empty.</li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201153116.webp"></p>
<p>In this case, it will fetch <code>/Engine</code>, <code>/Game</code>, and all enabled plugin umap, uasset through <code>NormalizePackageNames</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If no packages were explicitly added by command line or game callback, add all maps</span></span><br><span class="line"><span class="keyword">if</span> (FilesInPath.<span class="built_in">Num</span>() == InitialPackages.<span class="built_in">Num</span>() || bCookAll)</span><br><span class="line">&#123;</span><br><span class="line">  TArray&lt;FString&gt; Tokens;</span><br><span class="line">  Tokens.<span class="built_in">Empty</span>(<span class="number">2</span>);</span><br><span class="line">  Tokens.<span class="built_in">Add</span>(<span class="built_in">FString</span>(<span class="string">&quot;*&quot;</span>) + FPackageName::<span class="built_in">GetAssetPackageExtension</span>());</span><br><span class="line">  Tokens.<span class="built_in">Add</span>(<span class="built_in">FString</span>(<span class="string">&quot;*&quot;</span>) + FPackageName::<span class="built_in">GetMapPackageExtension</span>());</span><br><span class="line"></span><br><span class="line">  uint8 PackageFilter = NORMALIZE_DefaultFlags | NORMALIZE_ExcludeEnginePackages | NORMALIZE_ExcludeLocalizedPackages;</span><br><span class="line">  <span class="keyword">if</span> (bMapsOnly)</span><br><span class="line">  &#123;</span><br><span class="line">    PackageFilter |= NORMALIZE_ExcludeContentPackages;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bNoDev)</span><br><span class="line">  &#123;</span><br><span class="line">    PackageFilter |= NORMALIZE_ExcludeDeveloperPackages;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// assume the first token is the map wildcard/pathname</span></span><br><span class="line">  TArray&lt;FString&gt; Unused;</span><br><span class="line">  <span class="keyword">for</span> (int32 TokenIndex = <span class="number">0</span>; TokenIndex &lt; Tokens.<span class="built_in">Num</span>(); TokenIndex++)</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FString&gt; TokenFiles;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NormalizePackageNames</span>(Unused, TokenFiles, Tokens[TokenIndex], PackageFilter))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;No packages found for parameter %i: &#x27;%s&#x27;&quot;</span>), TokenIndex, *Tokens[TokenIndex]);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int32 TokenFileIndex = <span class="number">0</span>; TokenFileIndex &lt; TokenFiles.<span class="built_in">Num</span>(); ++TokenFileIndex)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">AddFileToCook</span>(FilesInPath, TokenFiles[TokenFileIndex]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211201153502.webp"></p>
<p>But with the default filters, it will exclude resources from the engine directory (<code>/Engine</code>) and from localization directories (<code>/*/L10N/</code>).</p>
<p>This essentially includes all uasset and umap from projects and plugins, excluding all resources under the <code>L10N</code> directory.</p>
<p>The core function for collecting packaged content is located in <code>UCookOnTheFlyServer::CollectFilesToCook</code>: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5200">CookOnTheFlyServer.cpp#L5200</a>.</p>
<ul>
<li><p>Maps, GameMode, GameInstance set in platform settings: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5450">CookOnTheFlyServer.cpp#L5450</a></p>
</li>
<li><p><code>DefaultTouchInterface</code> from <code>InputIni</code>: <a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5499">CookOnTheFlyServer.cpp#L5499</a></p>
</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DefaultInput.ini</span><br><span class="line"><span class="section">[/Script/Engine.InputSettings]</span></span><br><span class="line"><span class="attr">DefaultTouchInterface</span>=/Engine/MobileResources/HUD/LeftVirtualJoystickOnly.LeftVirtualJoystickOnly</span><br></pre></td></tr></table></figure>

<h3 id="SkipEditorContent"><a href="#SkipEditorContent" class="headerlink" title="SkipEditorContent"></a>SkipEditorContent</h3><p>You can configure this in project settings to ignore Editor-related resources during Cook:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2022/image-20220915113313285.webp"></p>
<p>In <code>CookOnTheFlyServer</code>, it will ignore resources from <code>/Engine/Editor*</code> and <code>/Editor/VREditor*</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// don&#x27;t save Editor resources from the Engine if the target doesn&#x27;t have editoronly data</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">IsCookFlagSet</span>(ECookInitializationFlags::SkipEditorContent) &amp;&amp;</span><br><span class="line">	(PackagePathName.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Engine/Editor&quot;</span>)) || PackagePathName.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Engine/VREditor&quot;</span>))) &amp;&amp;</span><br><span class="line">	!Target-&gt;<span class="built_in">HasEditorOnlyData</span>())</span><br><span class="line">&#123;</span><br><span class="line">	Result = ESavePackageResult::ContainsEditorOnlyData;</span><br><span class="line">	bCookPackage = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Dependency-Loading-During-Cook"><a href="#Dependency-Loading-During-Cook" class="headerlink" title="Dependency Loading During Cook"></a>Dependency Loading During Cook</h3><p>Although the above lists the resources that will be included during the engine’s packaging, <strong>they</strong> are not everything since they are still individual resources or directories and do not include the dependency relationships of the resources. Therefore, UE will also perform a substantial dependency analysis during its Cook process.</p>
<p>Consider the following two questions:</p>
<ol>
<li>If an Actor with a C++ implementation is placed in a map and its constructor code loads a certain resource, how will it be packaged?</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AMyActor::<span class="built_in">AMyActor</span>()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Set this actor to call Tick() every frame.  You can turn this off to improve performance if you don&#x27;t need it.</span></span><br><span class="line">  PrimaryActorTick.bCanEverTick = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  UTexture2D* Texture2D = <span class="built_in">LoadObject</span>&lt;UTexture2D&gt;(<span class="literal">nullptr</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;/Game/TextureResources/T_ImportTexture.T_ImportTexture&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Placing it in the scene will not generate any dependencies:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231162602.webp"></p>
<ol start="2">
<li>How do we package resources that are not referenced in AssetRegistry dependency relationships? For example, <code>AnimSequence</code> configurations such as <code>BoneCompressionSettings</code> and <code>CurveCompressionSettings</code> do not appear in the dependency relationships and cannot be found when retrieving dependencies of the animation sequence from the AssetRegistry.</li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231101858.webp"></p>
<p>However, they are recorded in the uasset’s ImportTable:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231144350.webp"></p>
<p>From the Cooked uasset, it can also be seen:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231145100.webp"></p>
<p>Given this, <strong>why can’t we directly scan dependencies from the ImportTable of the assets?</strong></p>
<p>This is because accessing the ImportTable requires actually loading the resource, which can be very resource-intensive and time-consuming with a large number of resources. Accessing dependency relationships from the AssetRegistry does not require loading resources into memory, making it much quicker.</p>
<p>So, how can we solve these issues? We need to start with the default implementation mechanism of UE. It’s essential to clarify two points:</p>
<ol>
<li>The engine creates CDO upon startup and executes the class constructor.</li>
<li>UE’s resources will load their dependent resources when they are loaded.</li>
</ol>
<p>Based on this thought, UE has implemented a solution during Cook to listen for all created UObjects and add them to the Cook list to ensure resources loaded in C++ constructors and dependent resources loaded through the ImportTable are also cooked.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FPackageTracker</span> : <span class="keyword">public</span> FUObjectArray::FUObjectCreateListener, <span class="keyword">public</span> FUObjectArray::FUObjectDeleteListener</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">FPackageTracker</span>()</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="keyword">for</span> (TObjectIterator&lt;UPackage&gt; It; It; ++It)</span><br><span class="line">	&#123;</span><br><span class="line">		UPackage* Package = *It;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">if</span> (Package-&gt;<span class="built_in">GetOuter</span>() == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			LoadedPackages.<span class="built_in">Add</span>(Package);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    GUObjectArray.<span class="built_in">AddUObjectDeleteListener</span>(<span class="keyword">this</span>);</span><br><span class="line">    GUObjectArray.<span class="built_in">AddUObjectCreateListener</span>(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ~<span class="built_in">FPackageTracker</span>()</span><br><span class="line">  &#123;</span><br><span class="line">    GUObjectArray.<span class="built_in">RemoveUObjectDeleteListener</span>(<span class="keyword">this</span>);</span><br><span class="line">    GUObjectArray.<span class="built_in">RemoveUObjectCreateListener</span>(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">NotifyUObjectCreated</span><span class="params">(<span class="type">const</span> <span class="keyword">class</span> UObjectBase *Object, int32 Index)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">NotifyUObjectDeleted</span><span class="params">(<span class="type">const</span> <span class="keyword">class</span> UObjectBase *Object, int32 Index)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Thus, following the same thought process, we only need to use the <code>AssetRegistry</code> to get the dependencies of the resources, store a rough list of resources, and then during Cook, listen to the creation of UObjects. If they are not in the scanned resource list, we will add them to the Cook queue, thereby achieving a complete resource packaging process.</p>
<p>The comparison between the Cook results without importing the ImportTable (left being the default UE Cook results, right being the custom Cook results):<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231152017.webp" alt="未追踪ImportTable的Cook结果对比"></p>
<p>The comparison of Cook results after tracking the ImportTable (left being the default UE Cook results):<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231152130.webp" alt="追踪了ImportTable的结果对比"></p>
<p>As can be seen, the resources Cooked after tracking the ImportTable are consistent with the resources Cooked by UE by default.</p>
<h3 id="Notes"><a href="#Notes" class="headerlink" title="Notes"></a>Notes</h3><p>If you have registered some configurable options in the engine, utilizing <code>FSoftObjectPath</code> and marking storage as <code>config</code> on the UObject will imply that the marked resources will be included in the Cook process, which should be avoided. It is advisable to create resource types similar to <code>PrimaryAssetLabel</code> for resource management marking.</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>This article has analyzed the engine’s default resource packaging process, transforming UE’s resource analysis from a black box into a deterministic process. By understanding the analysis results, we can obtain a rough list of packaged resources through dependency analysis and implement complete resource packaging by tracking <code>UObject</code> creation during Cook, thereby ensuring consistency with the default Cook resources in UE.</p>
<p>Analyzing UE’s resource packaging process allows us to replace the default Cook process in UE and realize multi-process, even cross-machine Cook task distribution, significantly enhancing UE’s packaging efficiency. In the future, I will implement a MultiCook mechanism for HotPatcher.</p>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                The article is finished. If you have any questions, please comment and communicate.
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/22570/" target="_blank">UE Resource Management: Engine Packaging Resource Analysis</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2021/12/31 14:33<br/>
             
             <span>Word Count:</span><span class="page-count">9.8k Words</span><br/>
             
             <span>Link:</span><a href="/posts/22570/" target="_blank" title="UE Resource Management: Engine Packaging Resource Analysis">https://en.imzlp.com/posts/22570/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/22570/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/" rel="tag"># 热更新</a>
              <a href="/tags/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" rel="tag"># 资源管理</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/29169/" rel="prev" title="Efficient Debugging: Start UE Android App with command line parameters">
      <i class="fa fa-chevron-left"></i> Efficient Debugging: Start UE Android App with command line parameters
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/24854/" rel="next" title="My 2021 Annual Summary">
      My 2021 Annual Summary <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#CookCommandlet"><span class="nav-number">1.</span> <span class="nav-text">CookCommandlet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Resource-Analysis"><span class="nav-number">2.</span> <span class="nav-text">Resource Analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#StartupPackages"><span class="nav-number">2.1.</span> <span class="nav-text">StartupPackages</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AllMaps"><span class="nav-number">2.2.</span> <span class="nav-text">AllMaps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UI"><span class="nav-number">2.3.</span> <span class="nav-text">UI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Directory-to-Always-Cook"><span class="nav-number">2.4.</span> <span class="nav-text">Directory to Always Cook</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Maps"><span class="nav-number">2.5.</span> <span class="nav-text">Maps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cultures"><span class="nav-number">2.6.</span> <span class="nav-text">Cultures</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DefaultTouchInterface"><span class="nav-number">2.7.</span> <span class="nav-text">DefaultTouchInterface</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GetCookModificationDelegate"><span class="nav-number">2.8.</span> <span class="nav-text">GetCookModificationDelegate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AssetManager"><span class="nav-number">2.9.</span> <span class="nav-text">AssetManager</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SkipEditorContent"><span class="nav-number">3.</span> <span class="nav-text">SkipEditorContent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dependency-Loading-During-Cook"><span class="nav-number">4.</span> <span class="nav-text">Dependency Loading During Cook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Notes"><span class="nav-number">5.</span> <span class="nav-text">Notes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">6.</span> <span class="nav-text">Summary</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/22570/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
