<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="UE builds projects through UBT (whether using Build in VS or Compile in the Editor, it eventually calls UBT). UBT and UHT are the cornerstones of the UE toolchain, and due to the vast amount of conten">
<meta property="og:type" content="article">
<meta property="og:title" content="Build flow of the Unreal Engine4 project">
<meta property="og:url" content="https://en.imzlp.com/posts/6362/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="UE builds projects through UBT (whether using Build in VS or Compile in the Editor, it eventually calls UBT). UBT and UHT are the cornerstones of the UE toolchain, and due to the vast amount of conten">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/20230417215036.webp">
<meta property="article:published_time" content="2019-03-16T23:09:52.000Z">
<meta property="article:modified_time" content="2019-09-16T19:01:45.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="UBT">
<meta property="article:tag" content="UHT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/20230417215036.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/6362/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Build flow of the Unreal Engine4 project | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/6362/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Build flow of the Unreal Engine4 project<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2019-03-16-6362.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/6362/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-16 23:09 23:09:52:09" itemprop="dateCreated datePublished" datetime="2019-03-16T23:09:52+00:00">2019-03-16 23:09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-16 19:01 19:01:45:01" itemprop="dateModified" datetime="2019-09-16T19:01:45+00:00">2019-09-16 19:01</time>
              </span>

          
            <span id="/posts/6362/" class="post-meta-item leancloud_visitors" data-flag-title="Build flow of the Unreal Engine4 project" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>UE builds projects through UBT (whether using Build in VS or Compile in the Editor, it eventually calls UBT). UBT and UHT are the cornerstones of the UE toolchain, and due to the vast amount of content, it is impossible to analyze everything at once. Let’s outline the main points now and supplement them later as time allows.</p>
<span id="more"></span>
<p>Here’s a general introduction to the responsibilities of UBT and UHT:<br><strong>UBT</strong>:</p>
<ul>
<li>Scans solution directory for modules and plug-ins</li>
<li>Determines all modules that need to be rebuilt</li>
<li>Invokes UHT to parse C++ headers</li>
<li>Creates compiler &amp; linker options from .Build.cs &amp; .Target.cs</li>
<li>Executes platform specific compilers (VisualStudio, LLVM)</li>
</ul>
<p><strong>UHT</strong>:</p>
<ul>
<li>Parses all C++ headers containing UClasses</li>
<li>Generates glue code for all Unreal classes &amp; functions</li>
<li>Generated files stored in Intermediates directory</li>
</ul>
<h2 id="VS"><a href="#VS" class="headerlink" title="VS"></a>VS</h2><p>Back to the topic. First, to start from scratch, the first step is to create a C++ project (choose either BasicCode or ThridPerson) and open VS.<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/01_UECreateCppProject.webp"><br>After opening VS, we can see this Solution structure:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/02_UEProject_VS_SolutionLayout.webp"><br>Right-click on the created Project in the Solution, and select <strong>Properties</strong>:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/03_UE_VS_Project_Properties.webp"><br>You can see that the <code>Build Command</code> under NMake-General uses the <code>.bat</code> files found in the <code>Engine\Build\BatchFiles</code> directory (on Windows platform):</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Build</span><br><span class="line">Engine\Build\BatchFiles\Build.bat</span><br><span class="line"># ReBuild</span><br><span class="line">Engine\Build\BatchFiles\Rebuild.bat</span><br><span class="line"># Clean</span><br><span class="line">Engine\Build\BatchFiles\Clean.bat</span><br></pre></td></tr></table></figure>
<p>Taking Build.bat as an example:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">setlocal</span> enabledelayedexpansion</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM The %~dp0 specifier resolves to the path to the directory where this .bat is located in.</span></span><br><span class="line"><span class="comment">REM We use this so that regardless of where the .bat file was executed from, we can change to</span></span><br><span class="line"><span class="comment">REM directory relative to where we know the .bat is stored.</span></span><br><span class="line"><span class="built_in">pushd</span> &quot;%~dp0\..\..\Source&quot;</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM %1 is the game name</span></span><br><span class="line"><span class="comment">REM %2 is the platform name</span></span><br><span class="line"><span class="comment">REM %3 is the configuration name</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXIST</span> ..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe (</span><br><span class="line">        ..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe %* -DEPLOY</span><br><span class="line">		<span class="built_in">popd</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		REM Ignore exit codes of 2 (&quot;ECompilationResult.UpToDate&quot;) from UBT; it&#x27;s not a failure.</span></span><br><span class="line">		<span class="keyword">if</span> &quot;<span class="variable">!ERRORLEVEL!</span>&quot;==&quot;<span class="number">2</span>&quot; (</span><br><span class="line">			<span class="keyword">EXIT</span> /B <span class="number">0</span></span><br><span class="line">		)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">EXIT</span> /B <span class="variable">!ERRORLEVEL!</span></span><br><span class="line">) <span class="keyword">ELSE</span> (</span><br><span class="line">	<span class="built_in">ECHO</span> UnrealBuildTool.exe <span class="keyword">not</span> found <span class="keyword">in</span> ..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe</span><br><span class="line">	<span class="built_in">popd</span></span><br><span class="line">	<span class="keyword">EXIT</span> /B <span class="number">999</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>It can be seen that <code>Build.bat</code> forwards the received parameters to <code>UnrealBuildTool.exe</code>:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe %*</span><br></pre></td></tr></table></figure>

<h2 id="UBT"><a href="#UBT" class="headerlink" title="UBT"></a>UBT</h2><p>Building a project through UnrealBuildTool requires passing parameters:</p>
<ol>
<li>%1 is the game name</li>
<li>%2 is the platform name</li>
<li>%3 is the configuration name</li>
<li>%4 is the ProjectPath</li>
</ol>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Example</span><br><span class="line">UnrealBuildTool.exe ThridPerson420 Win64 Development &quot;C:\Users\visionsmile\Documents\Unreal Projects\Examples\ThridPerson420\ThridPerson420.uproject&quot; -WaitMutex -FromMsBuild</span><br></pre></td></tr></table></figure>
<p>Next, let’s take a look at how UnrealBuildTools processes this:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Engine\Source\Programs\UnrealBuildTools\UnrealBuildTool.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">static</span> <span class="type">int</span> <span class="title">Main</span><span class="params">(string[] Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// make sure we catch any exceptions and return an appropriate error code.</span></span><br><span class="line">	<span class="comment">// Some inner code already does this (to ensure the Mutex is released),</span></span><br><span class="line">	<span class="comment">// but we need something to cover all outer code as well.</span></span><br><span class="line">	<span class="keyword">try</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">GuardedMain</span>(Arguments);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span> (Exception Exception)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Log.<span class="built_in">IsInitialized</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			Log.<span class="built_in">TraceError</span>(<span class="string">&quot;UnrealBuildTool Exception: &quot;</span> + Exception.<span class="built_in">ToString</span>());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (ExtendedErrorCode != <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> ExtendedErrorCode;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (<span class="type">int</span>)ECompilationResult.OtherCompilationError;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/04_UnrealBuildTool_MainFunction.webp"><br>You can see the parameters passed in.<br>After a bunch of checks on the engine and incoming parameters in GuardedMain, it will call <code>RunUBT</code>:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/05_UnrealBuildTool_RunUBTFunction.webp"></p>
<h3 id="RulesAssembly"><a href="#RulesAssembly" class="headerlink" title="RulesAssembly"></a>RulesAssembly</h3><p>In <code>RunUBT</code>, there’s a crucial function call <code>UEBuildTarget.CreateTarget</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Engine\Source\Programs\UnrealBuildTools\UnrealBuildTool.cs</span></span><br><span class="line"><span class="function">internal <span class="type">static</span> ECompilationResult <span class="title">RunUBT</span><span class="params">(BuildConfiguration BuildConfiguration, string[] Arguments, FileReference ProjectFile, <span class="type">bool</span> bCatchExceptions)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// other code...</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (UBTMakefile != null &amp;&amp; !bIsGatheringBuild &amp;&amp; bIsAssemblingBuild)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// If we&#x27;ve loaded a makefile, then we can fill target information from this file!</span></span><br><span class="line">		Targets = UBTMakefile.Targets;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		DateTime TargetInitStartTime = DateTime.UtcNow;</span><br><span class="line"></span><br><span class="line">		ReadOnlyBuildVersion Version = <span class="keyword">new</span> <span class="built_in">ReadOnlyBuildVersion</span>(BuildVersion.<span class="built_in">ReadDefault</span>());</span><br><span class="line"></span><br><span class="line">		Targets = <span class="keyword">new</span> <span class="built_in">List</span>&lt;UEBuildTarget&gt;();</span><br><span class="line">		foreach (TargetDescriptor TargetDesc in TargetDescs)</span><br><span class="line">		&#123;</span><br><span class="line">			UEBuildTarget Target = UEBuildTarget.<span class="built_in">CreateTarget</span>(TargetDesc, Arguments, bSkipRulesCompile, BuildConfiguration.SingleFileToCompile != null, BuildConfiguration.bUsePrecompiled, Version);</span><br><span class="line">			<span class="keyword">if</span> ((Target == null) &amp;&amp; (BuildConfiguration.bCleanProject))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			Targets.<span class="built_in">Add</span>(Target);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (UnrealBuildTool.bPrintPerformanceInfo)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">double</span> TargetInitTime = (DateTime.UtcNow - TargetInitStartTime).TotalSeconds;</span><br><span class="line">			Log.<span class="built_in">TraceInformation</span>(<span class="string">&quot;Target init took &quot;</span> + TargetInitTime + <span class="string">&quot;s&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// other code ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The definition of <code>UEBuildTarget.CreateTarget</code> is found in <code>Configuration/UEBuildTarget.cs</code>. It constructs a <code>RulesAssembly</code> object inside, which is responsible for reading and constructing the <code>target.cs</code> and Module’s <code>build.cs</code> in the project.<br>The call stack for constructing <code>RulesAssembly</code> is as follows:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/05-construct-rulesassembly.webp"></p>
<p>The constructor of <code>RulesAssembly</code> accepts a variety of parameters:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RulesAssembly</span><span class="params">(DirectoryReference BaseDir, IReadOnlyList&lt;PluginInfo&gt; Plugins, List&lt;FileReference&gt; ModuleFiles, List&lt;FileReference&gt; TargetFiles, Dictionary&lt;FileReference, PluginInfo&gt; ModuleFileToPluginInfo, FileReference AssemblyFileName, <span class="type">bool</span> bContainsEngineModules, <span class="type">bool</span> bUseBackwardsCompatibleDefaults, <span class="type">bool</span> bReadOnly, <span class="type">bool</span> bSkipCompile, RulesAssembly Parent</span></span></span><br></pre></td></tr></table></figure>

<ol>
<li>BaseDir: Project directory</li>
<li>Plugins: Absolute paths of all <code>.uplugin</code> files for all plugins the project depends on</li>
<li>ModuleFiles: Absolute paths of all <code>.build.cs</code> files for all Modules (Game Module and all internal modules of plugins) in the current Target</li>
<li>TargetFiles: Absolute paths of all <code>target.cs</code> files in the current Target</li>
<li>ModuleFileToPluginInfo: Mapping of plugin information; mapping of a Module’s <code>build.cs</code> file to the module’s basic information<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/ruleassembly-constructor-param-moduleFileToPluginInfo.webp"></li>
<li>AssemblyFileName: Absolute path of the project’s BuildRules DLL file (this file is generated when calling <code>UnrealVersionSelector</code> to create the VS project, located in the <code>Intermediate/Build/BuildRules</code> directory)</li>
</ol>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// e.g</span><br><span class="line">C:\Users\imzlp\Documents\Unreal Projects\GWorld\Intermediate\Build\BuildRules\GWorldModuleRules.dll</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>Other parameters (not the focus of this article)</li>
</ol>
<p>The <code>RulesAssembly</code> class defines two crucial members: <code>TargetNameToTargetFile</code> and <code>ModuleNameToModuleFile</code>, to which all defined <strong>TargetRules</strong> and <strong>ModuleRules</strong> of the current project are added in the constructor.</p>
<p>Here’s the <code>RulesAssembly</code> constructor:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/System/RulesAssembly.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Constructor. Compiles a rules assembly from the given source files.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;BaseDir&quot;&gt;</span>The base directory for this assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Plugins&quot;&gt;</span>All the plugins included in this assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ModuleFiles&quot;&gt;</span>List of module files to compile<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TargetFiles&quot;&gt;</span>List of target files to compile<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ModuleFileToPluginInfo&quot;&gt;</span>Mapping of module file to the plugin that contains it<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;AssemblyFileName&quot;&gt;</span>The output path for the compiled assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bContainsEngineModules&quot;&gt;</span>Whether this assembly contains engine modules. Used to initialize the default value for ModuleRules.bTreatAsEngineModule.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bUseBackwardsCompatibleDefaults&quot;&gt;</span>Whether modules in this assembly should use backwards-compatible defaults.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bReadOnly&quot;&gt;</span>Whether the modules and targets in this assembly are installed, and should be created with the bUsePrecompiled flag set<span class="doctag">&lt;/param&gt;</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bSkipCompile&quot;&gt;</span>Whether to skip compiling this assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Parent&quot;&gt;</span>The parent rules assembly<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RulesAssembly</span>(<span class="params">DirectoryReference BaseDir, IReadOnlyList&lt;PluginInfo&gt; Plugins, List&lt;FileReference&gt; ModuleFiles, List&lt;FileReference&gt; TargetFiles, Dictionary&lt;FileReference, PluginInfo&gt; ModuleFileToPluginInfo, FileReference AssemblyFileName, <span class="built_in">bool</span> bContainsEngineModules, <span class="built_in">bool</span> bUseBackwardsCompatibleDefaults, <span class="built_in">bool</span> bReadOnly, <span class="built_in">bool</span> bSkipCompile, RulesAssembly Parent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">this</span>.BaseDir = BaseDir;</span><br><span class="line">	<span class="keyword">this</span>.Plugins = Plugins;</span><br><span class="line">	<span class="keyword">this</span>.ModuleFileToPluginInfo = ModuleFileToPluginInfo;</span><br><span class="line">	<span class="keyword">this</span>.bContainsEngineModules = bContainsEngineModules;</span><br><span class="line">	<span class="keyword">this</span>.bUseBackwardsCompatibleDefaults = bUseBackwardsCompatibleDefaults;</span><br><span class="line">	<span class="keyword">this</span>.bReadOnly = bReadOnly;</span><br><span class="line">	<span class="keyword">this</span>.Parent = Parent;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find all the source files</span></span><br><span class="line">	List&lt;FileReference&gt; AssemblySourceFiles = <span class="keyword">new</span> List&lt;FileReference&gt;();</span><br><span class="line">	AssemblySourceFiles.AddRange(ModuleFiles);</span><br><span class="line">	AssemblySourceFiles.AddRange(TargetFiles);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compile the assembly</span></span><br><span class="line">	<span class="keyword">if</span> (AssemblySourceFiles.Count &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		List&lt;<span class="built_in">string</span>&gt; PreprocessorDefines = GetPreprocessorDefinitions();</span><br><span class="line">		CompiledAssembly = DynamicCompilation.CompileAndLoadAssembly(AssemblyFileName, AssemblySourceFiles, PreprocessorDefines: PreprocessorDefines, DoNotCompile: bSkipCompile);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Setup the module map</span></span><br><span class="line">	<span class="keyword">foreach</span> (FileReference ModuleFile <span class="keyword">in</span> ModuleFiles)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">string</span> ModuleName = ModuleFile.GetFileNameWithoutAnyExtensions();</span><br><span class="line">		<span class="keyword">if</span> (!ModuleNameToModuleFile.ContainsKey(ModuleName))</span><br><span class="line">		&#123;</span><br><span class="line">			ModuleNameToModuleFile.Add(ModuleName, ModuleFile);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Setup the target map</span></span><br><span class="line">	<span class="keyword">foreach</span> (FileReference TargetFile <span class="keyword">in</span> TargetFiles)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">string</span> TargetName = TargetFile.GetFileNameWithoutAnyExtensions();</span><br><span class="line">		<span class="keyword">if</span> (!TargetNameToTargetFile.ContainsKey(TargetName))</span><br><span class="line">		&#123;</span><br><span class="line">			TargetNameToTargetFile.Add(TargetName, TargetFile);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ignore other code..</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Compilation-Environment-Constructing-Target-and-Executing"><a href="#Compilation-Environment-Constructing-Target-and-Executing" class="headerlink" title="Compilation Environment: Constructing Target and Executing"></a>Compilation Environment: Constructing Target and Executing</h3><p>The main role of Target is to collect and configure compilation information for compiling the executable settings, similar to project settings in VS.</p>
<p>In <code>RunUBT</code>, the incoming parameters (Platform/Configuration, etc.) are extracted, and a series of parameters are added. Then, by calling <code>UEBuildTarget.CreateTarget</code>, a <code>UBuildTarget</code> object is created:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Configuration/UEBuildTarget.cs</span></span><br><span class="line"><span class="comment">// Executes logic in `target.cs` and constructs a URBduileTarget object</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UEBuildTarget <span class="title">CreateTarget</span>(<span class="params">TargetDescriptor Desc, <span class="built_in">string</span>[] Arguments, <span class="built_in">bool</span> bSkipRulesCompile, <span class="built_in">bool</span> bCompilingSingleFile, <span class="built_in">bool</span> bUsePrecompiled, ReadOnlyBuildVersion Version</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  DateTime CreateTargetStartTime = DateTime.UtcNow;</span><br><span class="line"></span><br><span class="line">  RulesAssembly RulesAssembly = RulesCompiler.CreateTargetRulesAssembly(Desc.ProjectFile, Desc.Name, bSkipRulesCompile, bUsePrecompiled, Desc.ForeignPlugin);</span><br><span class="line"></span><br><span class="line">  FileReference TargetFileName;</span><br><span class="line">  TargetRules RulesObject = RulesAssembly.CreateTargetRules(Desc.Name, Desc.Platform, Desc.Configuration, Desc.Architecture, Desc.ProjectFile, Version, Arguments, <span class="keyword">out</span> TargetFileName);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In <code>CreateTarget</code>, <code>RulesAssembly.CreateTargetRules</code> is called (to get the <code>target.cs</code> file and construct the basic compilation environment information into a <code>TargetInfo</code> passed to <code>CreateTargetRulesInstance</code> for creating a <code>TargetRules</code> object):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/System/RulesAssembly.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates a target rules object for the specified target name.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TargetName&quot;&gt;</span>Name of the target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Platform&quot;&gt;</span>Platform being compiled<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Configuration&quot;&gt;</span>Configuration being compiled<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Architecture&quot;&gt;</span>Architecture being built<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ProjectFile&quot;&gt;</span>Path to the project file for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Version&quot;&gt;</span>The current build version<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Arguments&quot;&gt;</span>Command line arguments for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TargetFileName&quot;&gt;</span>The original source file name of the Target.cs file for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>The build target rules for the specified target<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TargetRules <span class="title">CreateTargetRules</span>(<span class="params"><span class="built_in">string</span> TargetName, UnrealTargetPlatform Platform, UnrealTargetConfiguration Configuration, <span class="built_in">string</span> Architecture, FileReference ProjectFile, ReadOnlyBuildVersion Version, <span class="built_in">string</span>[] Arguments, <span class="keyword">out</span> FileReference TargetFileName</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ignore conditional check code...</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Return the target file name to the caller</span></span><br><span class="line">  TargetFileName = TargetNameToTargetFile[TargetName];</span><br><span class="line">  <span class="comment">// Currently, we expect the user&#x27;s rules object type name to be the same as the module name + &#x27;Target&#x27;</span></span><br><span class="line">  <span class="built_in">string</span> TargetTypeName = TargetName + <span class="string">&quot;Target&quot;</span>;</span><br><span class="line">  <span class="comment">// The build module must define a type named &#x27;&lt;TargetName&gt;Target&#x27; that derives from our &#x27;TargetRules&#x27; type.  </span></span><br><span class="line">  <span class="comment">// 通过构造TargetInfo对象，将基本的编译环境信息传递给`target.cs`中定义的构造函数</span></span><br><span class="line">  <span class="keyword">return</span> CreateTargetRulesInstance(TargetTypeName, <span class="keyword">new</span> TargetInfo(TargetName, Platform, Configuration, Architecture, ProjectFile, Version), Arguments);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>*.Target.cs</code> file for the project is obtained, and then <code>CreateTargetRulesInstance</code> is invoked to construct a <code>TargetRules</code> object (which is instantiated from the type defined in <code>target.cs</code>), executing the code in the constructor of <code>target.cs</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/System/RulesAssembly.cs</span></span><br><span class="line"><span class="comment">// Obtain the TargetRules object defined in target.cs and invoke its constructor </span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Construct an instance of the given target rules</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TypeName&quot;&gt;</span>Type name of the target rules<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;TargetInfo&quot;&gt;</span>Target configuration information to pass to the constructor<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Arguments&quot;&gt;</span>Command line arguments for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Instance of the corresponding TargetRules<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> TargetRules <span class="title">CreateTargetRulesInstance</span>(<span class="params"><span class="built_in">string</span> TypeName, TargetInfo TargetInfo, <span class="built_in">string</span>[] Arguments</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// The build module must define a type named &#x27;&lt;TargetName&gt;Target&#x27; that derives from our &#x27;TargetRules&#x27; type.  </span></span><br><span class="line">  Type RulesType = CompiledAssembly.GetType(TypeName);</span><br><span class="line">  <span class="keyword">if</span> (RulesType == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Expecting to find a type to be declared in a target rules named &#x27;&#123;0&#125;&#x27;.  This type must derive from the &#x27;TargetRules&#x27; type defined by Unreal Build Tool.&quot;</span>, TypeName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an instance of the module&#x27;s rules object, and set some defaults before calling the constructor.</span></span><br><span class="line">  TargetRules Rules = (TargetRules)FormatterServices.GetUninitializedObject(RulesType);</span><br><span class="line">  Rules.bUseBackwardsCompatibleDefaults = bUseBackwardsCompatibleDefaults;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find the constructor</span></span><br><span class="line">  ConstructorInfo Constructor = RulesType.GetConstructor(<span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(TargetInfo) &#125;);</span><br><span class="line">  <span class="keyword">if</span>(Constructor == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;No constructor found on &#123;0&#125; which takes an argument of type TargetInfo.&quot;</span>, RulesType.Name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Invoke the regular constructor</span></span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    Constructor.Invoke(Rules, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; TargetInfo &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Exception Ex)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(Ex, <span class="string">&quot;Unable to instantiate instance of &#x27;&#123;0&#125;&#x27; object type from compiled assembly &#x27;&#123;1&#125;&#x27;.  Unreal Build Tool creates an instance of your module&#x27;s &#x27;Rules&#x27; object in order to find out about your module&#x27;s requirements.  The CLR exception details may provide more information:  &#123;2&#125;&quot;</span>, TypeName, Path.GetFileNameWithoutExtension(CompiledAssembly.Location), Ex.ToString());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ignore other code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After these operations, we have obtained the <code>TargetRules</code> object from <code>target.cs</code>, which represents the compilation environment of the current project. The code is extensive and a bit tedious; the call stack looks like this:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/05-UBT-construct-TargetRule-callstack.webp"></p>
<h3 id="Compilation-Target-Module"><a href="#Compilation-Target-Module" class="headerlink" title="Compilation Target: Module"></a>Compilation Target: Module</h3><p><code>Module</code> is a small target file used for execution in UE, compiling to exe or DLL (the startup module compiles to exe, while non-startup modules compile to DLL or are statically linked to exe).</p>
<p>After the execution above, UBT will start reading and analyzing <code>ModuleRules</code> in the project, constructing <code>UEBuildModule</code> for subsequent compilation processing.</p>
<p>In <code>RunUBT</code>-&gt;<code>UEBuildTarget.Build</code>-&gt;<code>PreBuidSetup</code>, the actual execution logic can be understood to occur in <code>PreBuildSetup</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UEBuildTarget.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Setup target before build. This method finds dependencies, sets up global environment etc.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PreBuildSetup</span>(<span class="params">UEToolChain TargetToolChain</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Describe what&#x27;s being built.</span></span><br><span class="line">  Log.TraceVerbose(<span class="string">&quot;Building &#123;0&#125; - &#123;1&#125; - &#123;2&#125; - &#123;3&#125;&quot;</span>, AppName, TargetName, Platform, Configuration);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup the target&#x27;s binaries.</span></span><br><span class="line">  SetupBinaries();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup the target&#x27;s plugins</span></span><br><span class="line">  SetupPlugins();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup the custom build steps for this target</span></span><br><span class="line">  SetupCustomBuildSteps();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the plugin binaries to the build</span></span><br><span class="line">  <span class="keyword">foreach</span> (UEBuildPlugin Plugin <span class="keyword">in</span> BuildPlugins)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">foreach</span>(UEBuildModuleCPP Module <span class="keyword">in</span> Plugin.Modules)</span><br><span class="line">    &#123;</span><br><span class="line">      AddModuleToBinary(Module);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add all of the extra modules, including game modules, that need to be compiled along</span></span><br><span class="line">  <span class="comment">// with this app.  These modules are always statically linked in monolithic targets, but not necessarily linked to anything in modular targets,</span></span><br><span class="line">  <span class="comment">// and may still be required at runtime in order for the application to load and function properly!</span></span><br><span class="line">  AddExtraModules();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create all the modules referenced by the existing binaries</span></span><br><span class="line">  <span class="keyword">foreach</span>(UEBuildBinary Binary <span class="keyword">in</span> Binaries)</span><br><span class="line">  &#123;</span><br><span class="line">    Binary.CreateAllDependentModules(FindOrCreateModuleByName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bind every referenced C++ module to a binary</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> Idx = <span class="number">0</span>; Idx &lt; Binaries.Count; Idx++)</span><br><span class="line">  &#123;</span><br><span class="line">    List&lt;UEBuildModule&gt; DependencyModules = Binaries[Idx].GetAllDependencyModules(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (UEBuildModuleCPP DependencyModule <span class="keyword">in</span> DependencyModules.OfType&lt;UEBuildModuleCPP&gt;())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(DependencyModule.Binary == <span class="literal">null</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        AddModuleToBinary(DependencyModule);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add all the modules to the target if necessary.</span></span><br><span class="line">  <span class="keyword">if</span>(Rules.bBuildAllModules)</span><br><span class="line">  &#123;</span><br><span class="line">    AddAllValidModulesToTarget();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the external and non-C++ referenced modules to the binaries that reference them.</span></span><br><span class="line">  <span class="keyword">foreach</span> (UEBuildModuleCPP Module <span class="keyword">in</span> Modules.Values.OfType&lt;UEBuildModuleCPP&gt;())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(Module.Binary != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">foreach</span> (UEBuildModule ReferencedModule <span class="keyword">in</span> Module.GetUnboundReferences())</span><br><span class="line">      &#123;</span><br><span class="line">        Module.Binary.AddModule(ReferencedModule);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bCompileMonolithic)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Platform == UnrealTargetPlatform.Win64 || Platform == UnrealTargetPlatform.Win32)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// On Windows create import libraries for all binaries ahead of time, since linking binaries often causes bottlenecks</span></span><br><span class="line">      <span class="keyword">foreach</span> (UEBuildBinary Binary <span class="keyword">in</span> Binaries)</span><br><span class="line">      &#123;</span><br><span class="line">        Binary.SetCreateImportLibrarySeparately(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// On other platforms markup all the binaries containing modules with circular references</span></span><br><span class="line">      <span class="keyword">foreach</span> (UEBuildModule Module <span class="keyword">in</span> Modules.Values.Where(x =&gt; x.Binary != <span class="literal">null</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> CircularlyReferencedModuleName <span class="keyword">in</span> Module.Rules.CircularlyReferencedDependentModules)</span><br><span class="line">        &#123;</span><br><span class="line">          UEBuildModule CircularlyReferencedModule;</span><br><span class="line">          <span class="keyword">if</span> (Modules.TryGetValue(CircularlyReferencedModuleName, <span class="keyword">out</span> CircularlyReferencedModule) &amp;&amp; CircularlyReferencedModule.Binary != <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            CircularlyReferencedModule.Binary.SetCreateImportLibrarySeparately(<span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// On Mac AppBinaries paths for non-console targets need to be adjusted to be inside the app bundle</span></span><br><span class="line">  <span class="keyword">if</span> (Platform == UnrealTargetPlatform.Mac &amp;&amp; !Rules.bIsBuildingConsoleApplication)</span><br><span class="line">  &#123;</span><br><span class="line">    TargetToolChain.FixBundleBinariesPaths(<span class="keyword">this</span>, Binaries);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Where:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Setup the target&#x27;s binaries.</span></span><br><span class="line"><span class="comment">// Read LaunchModule, the executable target exe to be compiled, create the startup module&#x27;s UEBuildModuleCPP and UEBuildBinary (compile exe)</span></span><br><span class="line"><span class="comment">// UEBuildBinary is only created here</span></span><br><span class="line"><span class="built_in">SetupBinaries</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup the target&#x27;s plugins</span></span><br><span class="line"><span class="comment">// Construct all plugin Modules and create the compilation object UEBuildModuleCPP</span></span><br><span class="line"><span class="built_in">SetupPlugins</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>They directly or indirectly call <code>FindOrCreateCppModuleByName</code>, which ultimately calls <code>CreateModuleRulesAndSetDefaults</code> to construct the real <code>ModuleRules</code> object, and creates <code>UEBuildModuleCPP</code> for the module to be compiled:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/pre-create-modulerules.webp"></p>
<p><code>CreateModuleRulesAndSetDefaults</code> then calls <code>RulesAssembly.CreateModuleRules</code> (note that at this point, the execution flow has returned to <code>RulesAssembly</code>).</p>
<p><code>RulesAssembly.CreateModuleRules</code> retrieves the <code>*.build.cs</code> file using <code>ModuleNameToModuleFile</code> established during construction, then calls the constructor of <code>ModuleRules</code> similarly to the constructor of <code>TargetRules</code>, and passes the constructed <code>TargetRules</code> to <code>ModuleRules</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates an instance of a module rules descriptor object for the specified module name</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ModuleName&quot;&gt;</span>Name of the module<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Target&quot;&gt;</span>Information about the target associated with this module<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ReferenceChain&quot;&gt;</span>Chain of references leading to this module<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Compiled module rule info<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ModuleRules <span class="title">CreateModuleRules</span>(<span class="params"><span class="built_in">string</span> ModuleName, ReadOnlyTargetRules Target, <span class="built_in">string</span> ReferenceChain</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Currently, we expect the user&#x27;s rules object type name to be the same as the module name</span></span><br><span class="line">  <span class="built_in">string</span> ModuleTypeName = ModuleName;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure the module file is known to us</span></span><br><span class="line">  FileReference ModuleFileName;</span><br><span class="line">  <span class="keyword">if</span> (!ModuleNameToModuleFile.TryGetValue(ModuleName, <span class="keyword">out</span> ModuleFileName))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Parent == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Could not find definition for module &#x27;&#123;0&#125;&#x27; (referenced via &#123;1&#125;)&quot;</span>, ModuleName, ReferenceChain);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> Parent.CreateModuleRules(ModuleName, Target, ReferenceChain);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The build module must define a type named &#x27;Rules&#x27; that derives from our &#x27;ModuleRules&#x27; type.  </span></span><br><span class="line">  Type RulesObjectType = GetModuleRulesTypeInternal(ModuleName);</span><br><span class="line">  <span class="keyword">if</span> (RulesObjectType == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Expecting to find a type to be declared in a module rules named &#x27;&#123;0&#125;&#x27; in &#123;1&#125;.  This type must derive from the &#x27;ModuleRules&#x27; type defined by Unreal Build Tool.&quot;</span>, ModuleTypeName, CompiledAssembly.FullName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an instance of the module&#x27;s rules object</span></span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Create an uninitialized ModuleRules object and set some defaults.</span></span><br><span class="line">    ModuleRules RulesObject = (ModuleRules)FormatterServices.GetUninitializedObject(RulesObjectType);</span><br><span class="line">    RulesObject.Name = ModuleName;</span><br><span class="line">    RulesObject.File = ModuleFileName;</span><br><span class="line">    RulesObject.Directory = ModuleFileName.Directory;</span><br><span class="line">    ModuleFileToPluginInfo.TryGetValue(RulesObject.File, <span class="keyword">out</span> RulesObject.Plugin);</span><br><span class="line">    RulesObject.bTreatAsEngineModule = bContainsEngineModules;</span><br><span class="line">    RulesObject.bUseBackwardsCompatibleDefaults = bUseBackwardsCompatibleDefaults &amp;&amp; Target.bUseBackwardsCompatibleDefaults;</span><br><span class="line">    RulesObject.bPrecompile = (RulesObject.bTreatAsEngineModule || ModuleName.Equals(<span class="string">&quot;UE4Game&quot;</span>, StringComparison.OrdinalIgnoreCase)) &amp;&amp; Target.bPrecompile;</span><br><span class="line">    RulesObject.bUsePrecompiled = bReadOnly;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the constructor</span></span><br><span class="line">    ConstructorInfo Constructor = RulesObjectType.GetConstructor(<span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(ReadOnlyTargetRules) &#125;);</span><br><span class="line">    <span class="keyword">if</span>(Constructor == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;No valid constructor found for &#123;0&#125;.&quot;</span>, ModuleName);</span><br><span class="line">    &#125;</span><br><span class="line">    Constructor.Invoke(RulesObject, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; Target &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RulesObject;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Exception Ex)</span><br><span class="line">  &#123;</span><br><span class="line">    Exception MessageEx = (Ex <span class="keyword">is</span> TargetInvocationException &amp;&amp; Ex.InnerException != <span class="literal">null</span>)? Ex.InnerException : Ex;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(Ex, <span class="string">&quot;Unable to instantiate module &#x27;&#123;0&#125;&#x27;: &#123;1&#125;\n(referenced via &#123;2&#125;)&quot;</span>, ModuleName, MessageEx.ToString(), ReferenceChain);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We execute the code in all <code>GameMode</code> and <code>build.cs</code> in all <code>Plugins</code> at this time. ### Launch Module Compilation</p>
<p>The above mentioned compiling <code>Module</code>, there is one <code>Module</code> that is special, namely the <code>Launch</code> module.</p>
<p>Every executable program has an entry point, in UE, every Target compiles an executable program. The engine starts from the <code>Launch</code> module, and the <code>main</code> function is also defined therein, so it needs to compile the <code>main</code> function from the Launch module into an executable program.</p>
<p>The startup module is specified in the <code>TargetRules</code> of <code>UBT</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> LaunchModuleName</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">get</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> (LaunchModuleNamePrivate == <span class="literal">null</span> &amp;&amp; Type != <span class="keyword">global</span>::UnrealBuildTool.TargetType.Program)? <span class="string">&quot;Launch&quot;</span> : LaunchModuleNamePrivate;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span></span><br><span class="line">  &#123;</span><br><span class="line">    LaunchModuleNamePrivate = <span class="keyword">value</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can specify a launch module using <code>LaunchModuleNamePrivate</code> in <code>TargetRules</code>. If <strong>not specified</strong> and the Target type is not <code>Program</code>, it uses the <code>Launch</code> module, otherwise it uses the specified module. This means that the startup module is <code>Launch</code> for Game/Editor/Server/Client Targets.<br><strong>However</strong>, since <code>LaunchModuleNamePrivate</code> is defined as a <code>private</code> member in <code>TargetRules</code>, it cannot be assigned a value in our inherited <code>TargetRules</code>, so it currently serves no purpose.</p>
<p>It is used in <code>UEBuildTarget.SetupBinaries</code> (mentioned above, <code>UEBuildBinary</code> is the executable exe compilation object for the startup module and is only created here):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Sets up the binaries for the target.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">SetupBinaries</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// If we&#x27;re using the new method for specifying binaries, fill in the binary configurations now</span></span><br><span class="line">  <span class="keyword">if</span>(Rules.LaunchModuleName == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;LaunchModuleName must be set for all targets.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the launch module</span></span><br><span class="line">  UEBuildModuleCPP LaunchModule = FindOrCreateCppModuleByName(Rules.LaunchModuleName, TargetRulesFile.GetFileName());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the binary</span></span><br><span class="line">  UEBuildBinary Binary = <span class="keyword">new</span> UEBuildBinary(</span><br><span class="line">    Type: Rules.bShouldCompileAsDLL? UEBuildBinaryType.DynamicLinkLibrary : UEBuildBinaryType.Executable,</span><br><span class="line">    OutputFilePaths: OutputPaths,</span><br><span class="line">    IntermediateDirectory: (!LaunchModule.RulesFile.IsUnderDirectory(UnrealBuildTool.EngineDirectory) || ShouldCompileMonolithic()) ? ProjectIntermediateDirectory : EngineIntermediateDirectory,</span><br><span class="line">    bAllowExports: Rules.bHasExports,</span><br><span class="line">    PrimaryModule: LaunchModule,</span><br><span class="line">    bUsePrecompiled: LaunchModule.Rules.bUsePrecompiled &amp;&amp; OutputPaths[<span class="number">0</span>].IsUnderDirectory(UnrealBuildTool.EngineDirectory)</span><br><span class="line">  );</span><br><span class="line">  Binaries.Add(Binary);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the launch module to it</span></span><br><span class="line">  LaunchModule.Binary = Binary;</span><br><span class="line">  Binary.AddModule(LaunchModule);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an additional console app for the editor</span></span><br><span class="line">  <span class="keyword">if</span> (Platform == UnrealTargetPlatform.Win64 &amp;&amp; Configuration != UnrealTargetConfiguration.Shipping &amp;&amp; TargetType == TargetType.Editor)</span><br><span class="line">  &#123;</span><br><span class="line">    Binary.bBuildAdditionalConsoleApp = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The execution environment is as follows:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/ue-compile-launch-module-to-executable.webp"></p>
<p>You can see that the output file here is the project exe we compiled.</p>
<h2 id="UHT"><a href="#UHT" class="headerlink" title="UHT"></a>UHT</h2><p>Then UHT is called to generate code:<br>The function called is <code>ExecuteHeaderToolIfNecessary</code> (System/ExternalExecution.cs):<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/06_UBT_Call_UHT.webp"><br>If the previous step generates successfully through UHT, the compilation action will be executed (<code>ActionGraph.ExecuteActions</code> in System/ActionGraphs.cs):<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/07_UBT_ExecuteActions.webp"><br>It will further check a bunch of engine build configurations (e.g: Engine/Saved/UnrealBuildTool/BuildConfiguration.xml):<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/08_UBT_ExecuteActions.webp"><br>I kept the default engine build configuration, so a <code>ParallelExecutor</code> (System/ParallelExecutor.cs) is created, and then executed:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/09_UBT_ActionGraph_ExecuteActions_CreateExecutor.webp"><br>The current compilation tasks are created with multiple Actions and executed:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/10_UBT_ActionGraph_ExecuteActions_CreateExecutor_Executing.webp"><br>Start compiling code:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/6362/11_UBT_Real_Is_Building.webp"></p>
<h2 id="Postscript"><a href="#Postscript" class="headerlink" title="Postscript"></a>Postscript</h2><p>Based on the analysis above, the build path in UE is:</p>
<ol>
<li>Click Build in VS, which calls build.bat</li>
<li>build.bat calls UBT</li>
<li>UBT executes the logic in <code>target.cs</code> and all <code>Module</code>‘s <code>build.cs</code></li>
<li>UBT calls UHT (generating code based on UE’s <strong>macro tags</strong>)</li>
<li>After UHT finishes generating, UBT calls the compiler</li>
<li>Preprocessing</li>
<li>Compilation</li>
<li>Linking</li>
</ol>
<p>The key point of this process is that UBT calls UHT for generation before preprocessing by the compiler, which means we cannot wrap UE’s macros (in fact, <code>UCLASS</code> / <code>UFUNCTION</code> and similar should not be called macros, but rather <strong>tags</strong>), because UE’s macros are preprocessed by UHT before the compiler.</p>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                未完待续。
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/6362/" target="_blank">Build flow of the Unreal Engine4 project</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2019/03/16 23:09<br/>
             
              <span>Update Date:</span>2019/09/16 19:01<br/>
             
             <span>Word Count:</span><span class="page-count">6.8k Words</span><br/>
             
             <span>Link:</span><a href="/posts/6362/" target="_blank" title="Build flow of the Unreal Engine4 project">https://en.imzlp.com/posts/6362/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/6362/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/UBT/" rel="tag"># UBT</a>
              <a href="/tags/UHT/" rel="tag"># UHT</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/24007/" rel="prev" title="Engine Source Analysis: Module Loading and Startup">
      <i class="fa fa-chevron-left"></i> Engine Source Analysis: Module Loading and Startup
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/25558/" rel="next" title="C++ Polymorphism and Virtual Function Table">
      C++ Polymorphism and Virtual Function Table <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#VS"><span class="nav-number">1.</span> <span class="nav-text">VS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UBT"><span class="nav-number">2.</span> <span class="nav-text">UBT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RulesAssembly"><span class="nav-number">2.1.</span> <span class="nav-text">RulesAssembly</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compilation-Environment-Constructing-Target-and-Executing"><span class="nav-number">2.2.</span> <span class="nav-text">Compilation Environment: Constructing Target and Executing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compilation-Target-Module"><span class="nav-number">2.3.</span> <span class="nav-text">Compilation Target: Module</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UHT"><span class="nav-number">3.</span> <span class="nav-text">UHT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Postscript"><span class="nav-number">4.</span> <span class="nav-text">Postscript</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/6362/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
