<!DOCTYPE html>
<html lang="en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"en.imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="In the article ZSTD Dictionary-based Shader Compression Scheme, I introduced a method for compressing UE’s ShaderCode using ZSTD dictionaries, which can significantly improve the compression ratio of">
<meta property="og:type" content="article">
<meta property="og:title" content="An Efficient ZSTD Shader Dictionary Training Scheme">
<meta property="og:url" content="https://en.imzlp.com/posts/26943/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="In the article ZSTD Dictionary-based Shader Compression Scheme, I introduced a method for compressing UE’s ShaderCode using ZSTD dictionaries, which can significantly improve the compression ratio of">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20220812165429.webp">
<meta property="article:published_time" content="2022-07-14T13:01:54.000Z">
<meta property="article:modified_time" content="2022-07-14T13:01:54.000Z">
<meta property="article:author" content="LIPENGZHA">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="HotPatcher">
<meta property="article:tag" content="ZSTD">
<meta property="article:tag" content="ushaderbytecode">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20220812165429.webp">

<link rel="canonical" href="https://en.imzlp.com/posts/26943/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>An Efficient ZSTD Shader Dictionary Training Scheme | Z's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>Notes</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>Essay</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>Resources</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>Friends</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About Me</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>ShowCase</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>Site Log</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>Open Source</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>Unreal Wiki</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='en.imzlp.com';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <div class="l10n-header-widget">
    <script>
      // 获取当前页面的 URL
      const currentUrl = window.location.href;
      // 替换 URL 中的部分内容
      const jumpToL10nLink = currentUrl.replace('en.imzlp.com', 'imzlp.com');
      // 将 jumpToL10nLink 绑定到一个全局变量
      window.jumpToL10nLink = jumpToL10nLink;
    </script>

    <a href="#" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: none;" rel="noopener" target="_blank" onclick="window.open(window.jumpToL10nLink, '_blank'); return false;">
      <i class="fa fa-solid fa-language"></i>
    </a>
  </div>



    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"
  >
    <link itemprop="mainEntityOfPage" href="https://en.imzlp.com/posts/26943/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="LIPENGZHA">
      <meta itemprop="description" content=""I think, therefore I am"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          An Efficient ZSTD Shader Dictionary Training Scheme<a href="https://github.com/imzlp/blog-md/blob/en/_posts/2022-07-14-26943.md" class="post-edit-link" title="Edit this post" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a><a href="https://imzlp.com/posts/26943/" class="post-l10n-link" title="切换至中文版本" style="float: left;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-solid fa-language"></i></a>
        </h1>

        
          <div class="post-subtitle" style="text-align: center;line-height: 1;">
            <sub text-align="center" style="font-size: 15px;align-content: center;font-style: italic;bottom: 0em;">一种高效的ZSTD Shader字典训练方案</sub>
          </div>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-14 13:01 13:01:54:01" itemprop="dateCreated datePublished" datetime="2022-07-14T13:01:54+00:00">2022-07-14 13:01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/" itemprop="url" rel="index"><span itemprop="name">UnrealEngine</span></a>
                </span>
            </span>

          
            <span id="/posts/26943/" class="post-meta-item leancloud_visitors" data-flag-title="An Efficient ZSTD Shader Dictionary Training Scheme" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>27 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>In the article <a target="_blank" rel="noopener" href="https://imzlp.com/posts/24725/">ZSTD Dictionary-based Shader Compression Scheme</a>, I introduced a method for compressing UE’s ShaderCode using ZSTD dictionaries, which can significantly improve the compression ratio of ShaderLibrary. However, the process of training the dictionary and using it for compression remains complex and is not an efficient engineering implementation:</p>
<ol>
<li>The engine’s default Shader compression must be turned off.</li>
<li>You need to cook the project once to dump the ShaderCode of each unique Shader.</li>
<li>Based on the dumped ShaderCode files, use the ZSTD program to train the dictionary.</li>
<li>Execute a full cook process again to compress using the dictionary and generate the final shaderbytecode.</li>
</ol>
<p>According to the above process, changing the engine is necessary to dump ShaderCode; moreover, the disjointed workflow means that after dumping ShaderCode, you must invoke the <code>zstd</code> program to train the dictionary; finally, you still need to cook the project again to compress the Shader using the trained dictionary. Additionally, turning off Shader compression will cause DDC Cache Miss with LZ4 compression, leading to significant time overhead from repeated cooking, which is unacceptable in projects with a large number of Shaders.</p>
<p>Based on this pain point, I researched and implemented an efficient dictionary training method that requires no changes to the engine, allowing for rapid training of the dictionary and compression based on that dictionary. It can directly train the dictionary from ushaderbytecode and generate ushaderbytecode using ZSTD + dictionary compression, greatly improving processing efficiency. This is a completely Plugin-Only implementation, with almost zero integration cost, and will later be released as an extension module of <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>.</p>
<span id="more"></span>

<p>Based on the aforementioned dictionary training process, the core issues are threefold:</p>
<ol>
<li>How to efficiently obtain uncompressed ShaderCode.</li>
<li>How to eliminate dependence on the ZSTD program and implement dictionary training entirely within UE, avoiding additional IO processes.</li>
<li>How to avoid re-cooking and only use the dictionary to compress ShaderCode.</li>
</ol>
<p>The content of this article will systematically analyze and address these three issues.</p>
<h3 id="DumpShaderCode"><a href="#DumpShaderCode" class="headerlink" title="DumpShaderCode"></a>DumpShaderCode</h3><h4 id="What-is-the-most-reasonable-Dump-method"><a href="#What-is-the-most-reasonable-Dump-method" class="headerlink" title="What is the most reasonable Dump method?"></a>What is the most reasonable Dump method?</h4><p>To efficiently dump ShaderCode, we need to clarify one question: where is the most reasonable place to dump?</p>
<ol>
<li>When the Shader compilation is complete.<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220714142353358.webp"></li>
<li>At <code>FShaderCodeLibrary::AddShaderCode</code> (serializing <code>ushaderbytecode</code>).<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220714142619926.webp"></li>
</ol>
<p>The approach in <a target="_blank" rel="noopener" href="https://imzlp.com/posts/24725/">ZSTD Dictionary-based Shader Compression Scheme</a> suggests using <code>FShaderCodeLibrary::AddShaderCode</code>, because Shader cached from DDC will not go through the compilation process again. If done when the Shader compilation is complete, it will miss DDC cached shaders.</p>
<p>However, neither of these methods is the best solution. A careful consideration reveals that the final package already contains all the final ShaderCode for the current platform:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220714143112728.webp"></p>
<p>By default, the two ushaderbytecode files, <code>Global</code> and <code>ProjectName</code> in the project, constitute the complete ShaderLibrary of the project, which is by default compressed using LZ4.</p>
<p>If we can directly extract the original uncompressed ShaderCode from the default packaged ushaderbytecode for training, we can avoid the repeated cooking process.</p>
<p>To achieve this, we need to analyze the ushaderbytecode file format.</p>
<h4 id="Analysis-of-ushaderbytecode-format"><a href="#Analysis-of-ushaderbytecode-format" class="headerlink" title="Analysis of ushaderbytecode format"></a>Analysis of ushaderbytecode format</h4><p>The ushaderbytecode file is a container for managing ShaderCode in UE, used for storing the correspondence between shader hash and shader code for runtime querying and loading.</p>
<p>The serialization of the ushaderbytecode file is implemented in <code>ShaderCodeLibrary</code> within <code>FEditorShaderCodeArchive::Finalize</code>.</p>
<p>The final file format of ushaderbytecode:</p>
<ul>
<li><code>unsigned int GShaderArchiveVersion=2;</code> Four bytes, records the version number of ShaderArchive.</li>
<li><code>FSerializedShaderArchive SerializedShaders;</code> Records the hash, offset, and other information of shaders, serving as an index for ushaderbytecode, to document all shader information included in the current shaderbytecode and the offset of a particular ShaderCode in the file.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RENDERCORE_API</span> FSerializedShaderArchive</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	TArray&lt;FSHAHash&gt; ShaderMapHashes; <span class="comment">// Array of HASHes for ShaderMaps in this Archive.</span></span><br><span class="line">	TArray&lt;FSHAHash&gt; ShaderHashes; <span class="comment">// Array of HASHes for all Shaders in the Archive.</span></span><br><span class="line">	TArray&lt;FShaderMapEntry&gt; ShaderMapEntries; <span class="comment">// Information about ShaderMaps in the Archive.</span></span><br><span class="line">	TArray&lt;FShaderCodeEntry&gt; ShaderEntries; <span class="comment">// Array storing the offsets of all ShaderCodes in the Archive.</span></span><br><span class="line">	TArray&lt;FFileCachePreloadEntry&gt; PreloadEntries; <span class="comment">// Preloaded Shader array, records offsets and sizes.</span></span><br><span class="line">	TArray&lt;uint32&gt; ShaderIndices; <span class="comment">// Records the index values for each Shader.</span></span><br><span class="line">	FHashTable ShaderMapHashTable;</span><br><span class="line">	FHashTable ShaderHashTable;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220711112131954.webp" alt="FSerializedShaderArchive"></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220714145433976.webp" alt="ShaderMapEntries"></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220714145526496.webp" alt="ShaderEntries"></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220714145600602.webp" alt="ShaderIndices"></p>
<ul>
<li>ShaderCode array, containing all compiled ShaderCode serialized in order.</li>
</ul>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220711112514341.webp" alt="FEditorShaderCodeArchive::Finalize"></p>
<p>During runtime, when <code>FShaderCodeLibrary</code> loads a ushaderbytecode via <code>OpenLibrary</code>, it doesn’t fully load the file into memory. It only serializes <code>GShaderArchiveVersion</code> and the <code>FSerializedShaderArchive</code> structure:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220711141753.webp"></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220711141348.webp"></p>
<p>It retrieves the index structure, version number, and file handle (FileCacheHandle) for loading the true ShaderCode.</p>
<p>Necessary explanations of certain concepts:</p>
<ul>
<li>ShaderMap contains multiple ShaderCodes; for instance, a Material can generate multiple Shader variants, which are all located within the same ShaderMap.</li>
<li>ShaderCodes across multiple ShaderMaps can be reused and may have cross-referencing relationships; however, the ShaderCodes are not genuinely copied. The Shaders in ShaderMap are indexed by <code>ShaderIndices</code>, which only represent indices while the actual offsets of ShaderCode are stored in <code>ShaderEntries</code>, known as Unique Shaders.</li>
<li>Upon serialization, a Material (with bShareCode enabled) will serialize the ShaderMap’s HASH into the uasset, facilitating runtime queries for the corresponding ShaderMap.</li>
</ul>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220711150612.webp"></p>
<p>During reading, the FSHAHash value is utilized via <code>FShaderCodeLibrary::LoadResource</code> to load:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220711150843.webp"></p>
<h4 id="Reading-ShaderCode"><a href="#Reading-ShaderCode" class="headerlink" title="Reading ShaderCode"></a>Reading ShaderCode</h4><p>From the previous analysis, we recognize the storage structure of ShaderCode in ushaderbytecode.</p>
<p><code>FShaderCodeArchive</code> possesses a function <code>ReadShaderCode</code> that can specify loading a particular ShaderCode:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220711141932.webp"></p>
<p>ShaderIndex can be obtained through ShaderHash using the following interface:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int32 FSerializedShaderArchive::FindShader(const FSHAHash&amp; Hash) const;</span><br></pre></td></tr></table></figure>
<p>The ShaderIndex corresponds to the index of the ShaderCode within <code>ShaderEntries</code>.</p>
<p>To traverse all Shaders within a ushaderbytecode:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220714150319878.webp"></p>
<p>Once you have either the ShaderHash or ShaderIndex, you can directly use <code>ReadShaderCode</code> to retrieve the corresponding ShaderCode data:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IMemoryReadStreamRef Code = Library-&gt;ReadShaderCode(ReadShaderIndex);</span><br></pre></td></tr></table></figure>

<p>However, this data is still compressed with LZ4 by default, and we need to decompress it via LZ4:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FMemStackBase&amp; MemStack = FMemStack::<span class="built_in">Get</span>();</span><br><span class="line"><span class="built_in">check</span>(ShaderEntry.Size == Code-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line"><span class="type">const</span> uint8* ShaderCode = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">FMemMark <span class="title">Mark</span><span class="params">(MemStack)</span></span>;</span><br><span class="line"><span class="keyword">if</span> (ShaderEntry.UncompressedSize != ShaderEntry.Size)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">void</span>* UncompressedCode = MemStack.<span class="built_in">Alloc</span>(ShaderEntry.UncompressedSize, <span class="number">16</span>);</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bDecompressResult = FCompression::<span class="built_in">UncompressMemoryStream</span>(NAME_LZ4, UncompressedCode, ShaderEntry.UncompressedSize, Code, <span class="number">0</span>, ShaderEntry.Size);</span><br><span class="line">	<span class="built_in">check</span>(bDecompressResult);</span><br><span class="line">	ShaderCode = (uint8*)UncompressedCode;</span><br><span class="line">&#125;</span><br><span class="line">TArrayView&lt;uint8&gt; OriginalShaderCodeView = <span class="built_in">MakeArrayView</span>((uint8*)ShaderCode, ShaderEntry.UncompressedSize);</span><br></pre></td></tr></table></figure>

<p>This way, we have directly read the original uncompressed ShaderCode from ushaderbytecode.</p>
<p>Whether storing them separately or training the dictionary using a MemoryBuffer is possible. Of course, the recommended practice is to copy the decompressed ShaderCode into a MemoryBuffer for later training dataset use, so that there is no need for IO, and the dictionary can be trained directly from memory.</p>
<h4 id="Non-Engine-Modification-Implementation"><a href="#Non-Engine-Modification-Implementation" class="headerlink" title="Non-Engine Modification Implementation"></a>Non-Engine Modification Implementation</h4><p>The previous section introduced how to read ShaderCode from ushaderbytecode, but there is an issue: the <code>FShaderCodeArchive</code> class is not exported.</p>
<figure class="highlight cpp"><figcaption><span>RenderCore\Public\ShaderCodeArchive.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FShaderCodeArchive</span> : <span class="keyword">public</span> FRHIShaderLibrary&#123;<span class="comment">// ...&#125;</span></span><br></pre></td></tr></table></figure>
<p>In external modules, access to its member functions is not possible, leading to linker errors.</p>
<p>Moreover, the <code>ReadShaderCode</code> function is a <code>protected</code> member, making it inaccessible from external symbols.</p>
<p>If the engine must be modified, the simplest change is to add <code>RENDERCODE_API</code> to export the symbol. Otherwise, you will need to use some clever techniques to achieve this, which can be referenced in my previous articles:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://imzlp.com/posts/12080/">Breaking C++ Class Access Control Mechanisms</a>.</li>
<li><a target="_blank" rel="noopener" href="https://imzlp.com/posts/17586/">Visibility and Accessibility of Access Control Mechanisms</a></li>
</ul>
<p>The methods discussed in the articles can enable reading ShaderCode without modifying the engine, allowing it to be utilized even in the public engine. The specific methods will not be elaborated on in this article.</p>
<h3 id="Training-Dictionary-in-UE"><a href="#Training-Dictionary-in-UE" class="headerlink" title="Training Dictionary in UE"></a>Training Dictionary in UE</h3><p>In the previous article, the <code>zstd</code> command-line program was used for training:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create Dictionary</span></span><br><span class="line">$ zstd --train ./DumpShaders/PCD3D_SM5/* -r -o PCD3D_SM5.dict</span><br></pre></td></tr></table></figure>

<p>Based on the ShaderCode MemeryBuffer obtained in the last section, we can directly train the dictionary from memory.</p>
<p>Utilizing the ZSTD code in UE directly:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ZDICTLIB_API <span class="type">size_t</span> <span class="title function_">ZDICT_trainFromBuffer</span><span class="params">(<span class="type">void</span>* dictBuffer, <span class="type">size_t</span> dictBufferCapacity,</span></span><br><span class="line"><span class="params">                                    <span class="type">const</span> <span class="type">void</span>* samplesBuffer,</span></span><br><span class="line"><span class="params">                                    <span class="type">const</span> <span class="type">size_t</span>* samplesSizes, <span class="type">unsigned</span> nbSamples)</span>;</span><br></pre></td></tr></table></figure>

<p>We can encapsulate a helper function to create the dictionary:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">buffer_t</span> <span class="title function_">FUZ_createDictionary</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* src, <span class="type">size_t</span> srcSize, <span class="type">size_t</span> blockSize, <span class="type">size_t</span> requestedDictSize)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">buffer_t</span> dict = kBuffNull;</span><br><span class="line">	<span class="type">size_t</span> <span class="type">const</span> nbBlocks = (srcSize + (blockSize<span class="number">-1</span>)) / blockSize;</span><br><span class="line">	<span class="type">size_t</span>* <span class="type">const</span> blockSizes = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(nbBlocks * <span class="keyword">sizeof</span>(<span class="type">size_t</span>));</span><br><span class="line">	<span class="keyword">if</span> (!blockSizes) <span class="keyword">return</span> kBuffNull;</span><br><span class="line">	dict.start = <span class="built_in">malloc</span>(requestedDictSize);</span><br><span class="line">	<span class="keyword">if</span> (!dict.start) &#123; <span class="built_in">free</span>(blockSizes); <span class="keyword">return</span> kBuffNull; &#125;</span><br><span class="line">	&#123;   <span class="type">size_t</span> nb;</span><br><span class="line">		<span class="keyword">for</span> (nb=<span class="number">0</span>; nb&lt;nbBlocks<span class="number">-1</span>; nb++) blockSizes[nb] = blockSize;</span><br><span class="line">		blockSizes[nbBlocks<span class="number">-1</span>] = srcSize - (blockSize * (nbBlocks<span class="number">-1</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	&#123;   <span class="type">size_t</span> <span class="type">const</span> dictSize = ZDICT_trainFromBuffer(dict.start, requestedDictSize, src, blockSizes, (<span class="type">unsigned</span>)nbBlocks);</span><br><span class="line">		<span class="built_in">free</span>(blockSizes);</span><br><span class="line">		<span class="keyword">if</span> (ZDICT_isError(dictSize)) &#123; FUZ_freeDictionary(dict); <span class="keyword">return</span> kBuffNull; &#125;</span><br><span class="line">		dict.size = requestedDictSize;</span><br><span class="line">		dict.filled = dictSize;</span><br><span class="line">		<span class="keyword">return</span> dict;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This allows you to avoid saving ShaderCode to disk and then invoking <code>ZSTD</code> command-line training. The training logic is executed entirely in code based on in-memory data.</p>
<h3 id="Dictionary-Compression-of-shaderbytecode"><a href="#Dictionary-Compression-of-shaderbytecode" class="headerlink" title="Dictionary Compression of shaderbytecode"></a>Dictionary Compression of shaderbytecode</h3><p>Based on the contents of the previous two sections, we can directly train the ZSTD dictionary from ushaderbytecode.</p>
<p>So, what is the best practice for compressing the final ushaderbytecode using the ZSTD dictionary?</p>
<p>From the <a href="#ushaderbytecode%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90">ushaderbytecode format analysis</a> section, we know that the storage format of ushaderbytecode is as follows:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20220714181210276.webp" alt="ushaderbytecode storage format"></p>
<p>When loading a Shader, the ShaderHash is used to determine the index in <code>ShaderIndices</code>, which accesses <code>ShaderEntries[index]</code>, and the content of <code>ShaderEntries[index]</code> provides the offset, size, and uncompressed size of the ShaderCode in the <code>ShaderCodeData</code> shown above, achieving <strong>deterministic</strong> reading of the ShaderCode.</p>
<p>If we want to generate another final ushaderbytecode based on the original ushaderbytecode through dictionary compression, we need to modify the following two parts:</p>
<ol>
<li>The ShaderCodeData after dictionary compression.</li>
<li>Correct the offset and size (compressed size) of each Shader in <code>ShaderEntries</code> after dictionary compression.</li>
</ol>
<p>The specific implementation steps are:</p>
<ol>
<li>Read the original ushaderbytecode and save <code>SerializedShaders</code>.</li>
<li>Sequentially read each ShaderCode and decompress using LZ4.</li>
<li>Use ZSTD + dictionary to compress each ShaderCode, appending it to a global MemoryBuffer, allowing for obtaining the offset and size of the compressed ShaderCode in this MemoryBuffer.</li>
<li>Update the new offset and size of each ShaderCode in the MemoryBuffer into the previously saved <code>SerializedShaders</code>.</li>
<li>Finally, serialize <code>GShaderCodeArchiveVersion</code>, <code>SerializedShaders</code>, and <code>MemoryBuffer</code> to a file.</li>
</ol>
<p>This way, you can directly create ushaderbytecode with dictionary compression from the default packaged ushaderbytecode, avoiding additional cooking processes.</p>
<h3 id="ZSTD-Optimization-Strategies"><a href="#ZSTD-Optimization-Strategies" class="headerlink" title="ZSTD Optimization Strategies"></a>ZSTD Optimization Strategies</h3><p>Upgrade to the latest version of ZSTD (<a target="_blank" rel="noopener" href="https://github.com/facebook/zstd/releases/tag/v1.5.2">1.5.2</a>), which has further improved compression rates compared to the previous integration (1.4.4).</p>
<p>On the interface level, it is optimized by using <code>*usingCDict</code> instead of <code>*usingDict</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Recommended</span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">ZSTD_compress_usingCDict</span><span class="params">(ZSTD_CCtx* cctx,</span></span><br><span class="line"><span class="params">                                <span class="type">void</span>* dst, <span class="type">size_t</span> dstCapacity,</span></span><br><span class="line"><span class="params">                                <span class="type">const</span> <span class="type">void</span>* src, <span class="type">size_t</span> srcSize,</span></span><br><span class="line"><span class="params">                                <span class="type">const</span> ZSTD_CDict* cdict)</span>;</span><br><span class="line"><span class="comment">// Not recommended</span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">ZSTD_compress_usingDict</span><span class="params">(ZSTD_CCtx* cctx,</span></span><br><span class="line"><span class="params">                               <span class="type">void</span>* dst, <span class="type">size_t</span> dstCapacity,</span></span><br><span class="line"><span class="params">                         <span class="type">const</span> <span class="type">void</span>* src, <span class="type">size_t</span> srcSize,</span></span><br><span class="line"><span class="params">                         <span class="type">const</span> <span class="type">void</span>* dict, <span class="type">size_t</span> dictSize,</span></span><br><span class="line"><span class="params">                               <span class="type">int</span> compressionLevel)</span>;</span><br></pre></td></tr></table></figure>

<p>The <code>*usingDict</code> series of functions load the dictionary and are only recommended for single compressions. They can be very slow (by an order of magnitude) in scenarios requiring frequent compression using the same dictionary; therefore, <code>*usingCDict</code> should be used instead. The same also applies to decompression.</p>
<h3 id="Dictionary-Training-and-Compression-Efficiency"><a href="#Dictionary-Training-and-Compression-Efficiency" class="headerlink" title="Dictionary Training and Compression Efficiency"></a>Dictionary Training and Compression Efficiency</h3><p>Test Data:</p>
<ul>
<li>Shaderbytecode 256M</li>
<li>Total original ShaderCode size (after LZ4 decompression): 682M</li>
<li>66579 Unique Shaders</li>
</ul>
<p>Dictionary training:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220714124800.webp"></p>
<p>Shader compression:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220714124613.webp"></p>
<p>The majority of the ShaderCode’s <strong>compression time</strong> is around 1ms, fluctuating based on ShaderCode size.</p>
<p>The total time for dictionary training + generating final ushaderbytecode is less than 4 minutes, making the time consumption no longer a bottleneck.</p>
<p>Comparison of sizes between LZ4 compressed ushaderbytecode and ZSTD + dictionary compressed in actual projects:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220804113246.webp"></p>
<h3 id="Runtime-Example"><a href="#Runtime-Example" class="headerlink" title="Runtime Example"></a>Runtime Example</h3><p>I provide a runtime demo after packaging; the default package is through LZ4 compressed Shader, and I have provided one that contains the dictionary and the shaderbytecode compressed with the dictionary (including StarterContent and Global), which can be used to verify functionality and test runtime efficiency.</p>
<p>Download link: <a target="_blank" rel="noopener" href="https://stusdnueducn-my.sharepoint.com/:f:/g/personal/2017020625_stu_sdnu_edu_cn/EkIjc0JV6hNEi17VJrbpMfUBeMvTmlE2cDaNgIYFyi-ozQ?e=p8AK8d">ZstdExample_WindowsNoEditor</a></p>
<p>Place <code>ZstdShader_WindowsNoEditor_001_P.pak</code> under <code>Content/Paks</code> to use the ZSTD and dictionary mode for reading the shader compressed with the dictionary from ShaderLibrary by default:<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220715163512.webp"></p>
<p>If you don’t put this Pak, the engine will use the default LZ4 compressed ushaderbytecode.</p>
<p>The runtime effect of using the ZSTD mode shows no Shader errors:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220715163914.webp"></p>
<p>You can also analyze runtime performance using Unreal Insight:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZstdExample -windowed -resx=1280 -resy=720 -<span class="built_in">log</span> -trace=cpu -tracehost=127.0.0.1</span><br></pre></td></tr></table></figure>

<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20220715164500.webp"></p>
<h3 id="HotPatcher-Integration"><a href="#HotPatcher-Integration" class="headerlink" title="HotPatcher Integration"></a>HotPatcher Integration</h3><p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2022/202207281100036.webp"><br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2022/202207281102463.webp"></p>
<p>You can directly train the dictionary based on ushaderbytecode and use it to compress existing ushaderbytecode, minimizing operational costs.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>This article shares an efficient ZSTD Shader dictionary training method, analyzing the file format of ushaderbytecode, and contrasting the methods for dumping ShaderCode, training the dictionary directly within UE. It also shares a method that does not require engine modifications, allowing seamless use in the public engine and reducing the management costs of engine changes.</p>
<p>The dictionary training and compression operations can be realized in a single call, significantly enhancing efficiency. This transforms dictionary training and compression into a completely Plugin-Only implementation, requiring no additional modifications and processes, clearing the obstacles for integration into <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>, and it will later be released as an extension module of <a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>.</p>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                The article is finished. If you have any questions, please comment and communicate.
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>Scan the QR code on WeChat and follow me.</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>Title:</span><a href="/posts/26943/" target="_blank">An Efficient ZSTD Shader Dictionary Training Scheme</a><br/>
             <span>Author:</span><a href="/about" target="_blank" title="查看 LIPENGZHA 的资料">LIPENGZHA</a><br/>
             <span>Publish Date:</span>2022/07/14 13:01<br/>
             
             <span>Word Count:</span><span class="page-count">11k Words</span><br/>
             
             <span>Link:</span><a href="/posts/26943/" target="_blank" title="An Efficient ZSTD Shader Dictionary Training Scheme">https://en.imzlp.com/posts/26943/</a>
             <span class="copy-path" data-clipboard-text="Link: https://en.imzlp.com/posts/26943/ Author: LIPENGZHA" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>License:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>Reprinting of the full article is prohibited.</span>
          </div>
        
    

        
  <div class="reward-container">
    <div>Your donation will encourage me to keep creating!</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      Donate
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="LIPENGZHA WeChat Pay">
          <p>WeChat Pay</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/HotPatcher/" rel="tag"># HotPatcher</a>
              <a href="/tags/ZSTD/" rel="tag"># ZSTD</a>
              <a href="/tags/ushaderbytecode/" rel="tag"># ushaderbytecode</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/22655/" rel="prev" title="Multi-stage automated resource inspection scheme in UE">
      <i class="fa fa-chevron-left"></i> Multi-stage automated resource inspection scheme in UE
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/12188/" rel="next" title="A runtime reorganization scheme for Pak in Unreal Engine">
      A runtime reorganization scheme for Pak in Unreal Engine <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#DumpShaderCode"><span class="nav-number">1.</span> <span class="nav-text">DumpShaderCode</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#What-is-the-most-reasonable-Dump-method"><span class="nav-number">1.1.</span> <span class="nav-text">What is the most reasonable Dump method?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-of-ushaderbytecode-format"><span class="nav-number">1.2.</span> <span class="nav-text">Analysis of ushaderbytecode format</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Reading-ShaderCode"><span class="nav-number">1.3.</span> <span class="nav-text">Reading ShaderCode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Non-Engine-Modification-Implementation"><span class="nav-number">1.4.</span> <span class="nav-text">Non-Engine Modification Implementation</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Training-Dictionary-in-UE"><span class="nav-number">2.</span> <span class="nav-text">Training Dictionary in UE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dictionary-Compression-of-shaderbytecode"><span class="nav-number">3.</span> <span class="nav-text">Dictionary Compression of shaderbytecode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZSTD-Optimization-Strategies"><span class="nav-number">4.</span> <span class="nav-text">ZSTD Optimization Strategies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dictionary-Training-and-Compression-Efficiency"><span class="nav-number">5.</span> <span class="nav-text">Dictionary Training and Compression Efficiency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Runtime-Example"><span class="nav-number">6.</span> <span class="nav-text">Runtime Example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HotPatcher-Integration"><span class="nav-number">7.</span> <span class="nav-text">HotPatcher Integration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conclusion"><span class="nav-number">8.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="LIPENGZHA"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">LIPENGZHA</p>
  <div class="site-description" itemprop="description">"I think, therefore I am"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;" rel="noopener" target="_blank">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;" rel="noopener" target="_blank">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LIPENGZHA</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.5m</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://en.imzlp.com/posts/26943/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "Leave something behind~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'en' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
